<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Day 24ï½œç·šä¸Šç›¸ç°¿ - åˆ†äº«é€£çµï¼ˆID å°æ‡‰ï¼è¨ªå®¢æª¢è¦–ï¼‰</title>
  <!--
    ä½¿ç”¨æ–¹å¼ï¼š
    1) é€™æ˜¯å–®ä¸€ HTML æª”ï¼Œç›´æ¥å­˜æˆ index.html é–‹å•Ÿã€‚
    2) ä»Šå¤©ç›®æ¨™ï¼š
       - ç‚ºæ¯å¼µç…§ç‰‡ç”¢ç”Ÿã€Œåˆ†äº«é€£çµã€ï¼ˆä»¥éš¨æ©Ÿ token å°æ‡‰ä¸€ä»½**å¿«ç…§**ï¼‰ã€‚
       - é€ è¨ª ?share=<token> æ™‚ï¼Œé¡¯ç¤ºã€Œè¨ªå®¢æ¨¡å¼ã€é é¢ï¼ˆå”¯è®€ï¼‰ã€‚
    3) å¯¦ä½œç´°ç¯€ï¼š
       - æ‰€æœ‰è³‡æ–™ç”¨ LocalStorage æ¨¡æ“¬ï¼ˆç„¡å¾Œç«¯ï¼‰ã€‚
       - Share å…§å®¹ç‚º**å¿«ç…§**ï¼ˆåŒ…å« dataUrl / ä¸­ç¹¼è³‡æ–™ï¼‰ï¼Œå› æ­¤ä¸åŒè£ç½®ä¹Ÿèƒ½é–‹ï¼ˆä¸ä¾è³´åŸä½œè€…çš„ LocalStorageï¼‰ã€‚
       - å¡ç‰‡æä¾›ï¼šåˆ†äº«ã€è¤‡è£½é€£çµã€å–æ¶ˆåˆ†äº«ï¼ˆæ’¤éŠ·ï¼‰ã€‚
    4) å»¶ä¼¸ï¼šæœªä¾†å¯æ”¹ç‚ºå‘¼å« Day 23 çš„ API å»ºç«‹/æŸ¥è©¢åˆ†äº«ç´€éŒ„ã€‚
  -->
  <style>
    :root{ --bg:#ffffff; --elev:#f9fafb; --text:#1f2328; --muted:#6b7280; --primary:#ff8c42; --danger:#e11d48; --border:#e5e7eb; --radius:14px; --shadow:0 8px 24px rgba(17,24,39,.12) }
    @media(prefers-color-scheme:dark){ :root{ --bg:#0b1220; --elev:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --primary:#ff954f; --danger:#fb7185; --border:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.35) } }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans CJK TC","Microsoft JhengHei",Arial,sans-serif;line-height:1.65}
    .container{max-width:1100px;margin:0 auto;padding:24px;box-sizing:border-box}
    header{border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fff,#fff7f1)}
    @media(prefers-color-scheme:dark){header{background:linear-gradient(180deg,#0b1220,#0b1220)}}
    .brand{display:flex;align-items:center;gap:12px}
    .brand__logo{width:44px;height:44px;border-radius:10px;background:var(--primary);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .brand__title{margin:0;font-size:20px}
    .brand__subtitle{margin:4px 0 0;color:var(--muted);font-size:14px}

    .toolbar{display:grid;gap:12px;margin-top:16px;align-items:center;grid-template-columns:1fr 220px}
    @media(max-width:900px){.toolbar{grid-template-columns:1fr}}
    .toolbar input,.toolbar button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text)}
    .toolbar input[type=file]{padding:8px}
    .btn{cursor:pointer;border-radius:10px}
    .btn.primary{background:var(--primary);color:#fff;border:none}
    .btn.secondary{background:#fff0;border:1px solid var(--border)}
    .btn.danger{background:var(--danger);color:#fff;border:none}
    .btn.small{padding:8px 10px;font-size:12px}

    main{padding:24px 0}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}

    .card{background:var(--elev);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;background:#eef2f7;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:12px;display:grid;gap:8px}
    .title-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{font-size:12px;color:var(--muted)}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:#555;background:#fff0}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    /* è¨ªå®¢æ¨¡å¼ï¼ˆå–®å¼µæª¢è¦–ï¼‰ */
    .viewer{display:grid;gap:16px;grid-template-columns: 1.2fr 1fr}
    @media(max-width:900px){.viewer{grid-template-columns:1fr}}
    .viewer .big{background:var(--elev);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .viewer .big img{width:100%;height:auto;display:block}
    .viewer .info{background:var(--elev);border:1px solid var(--border);border-radius:16px;padding:16px;display:grid;gap:10px}
    .viewer h2{margin:0}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">PA</div>
        <div>
          <h1 class="brand__title">ç·šä¸Šç›¸ç°¿ï¼ˆDay 24ï¼‰</h1>
          <p class="brand__subtitle">åˆ†äº«é€£çµï¼ˆID â†’ å¿«ç…§ï¼›?share=TOKEN ç‚ºè¨ªå®¢æ¨¡å¼ï¼‰</p>
        </div>
      </div>

      <div id="toolbar" class="toolbar" role="region" aria-label="å·¥å…·åˆ—">
        <input id="searchInput" type="text" placeholder="æœå°‹é—œéµå­—ï¼ˆæ¨™é¡Œï¼æ•˜è¿°ï¼æ¨™ç±¤ï¼æª”åï¼‰" aria-label="æœå°‹">
        <input id="fileInput" type="file" accept="image/*" multiple aria-label="ä¸Šå‚³åœ–ç‰‡">
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div id="ownerView">
        <div class="statusbar" style="display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px;margin-bottom:10px">
          <div>ç…§ç‰‡ç¸½æ•¸ï¼š<span id="countAll">0</span></div>
          <div>ç¬¦åˆï¼š<span id="countFiltered">0</span>ï½œå·²é¡¯ç¤ºï¼š<span id="countShown">0</span></div>
        </div>
        <div id="grid" class="grid" aria-live="polite"></div>
      </div>

      <div id="visitorView" style="display:none">
        <div class="pill" style="margin-bottom:12px">è¨ªå®¢æ¨¡å¼ï¼ˆå”¯è®€ï¼‰</div>
        <div class="viewer">
          <div class="big"><img id="vImg" alt="shared" /></div>
          <div class="info">
            <h2 id="vTitle">â€”</h2>
            <div class="muted" id="vMeta">â€”</div>
            <div id="vDesc">â€”</div>
            <div id="vTags" class="tags"></div>
            <div class="muted">ä¾†æºï¼šæœ¬é ç‚ºä½œè€…åˆ†äº«çš„éœæ…‹å¿«ç…§ã€‚</div>
            <div><button id="btnVisitHome" class="btn secondary" type="button">å›åˆ°ä¸»é </button></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ç·¨è¼¯ Modalï¼ˆç°¡ç‰ˆï¼‰ -->
  <div id="modalBackdrop" class="modal-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px">
    <div class="modal" role="document" aria-labelledby="modalTitle" style="width:560px;max-width:720px;background:var(--bg);border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden">
      <div class="modal__header" id="modalTitle" style="padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800">ç·¨è¼¯åœ–ç‰‡è³‡è¨Š</div>
      <div class="modal__body" style="padding:16px;display:grid;gap:12px">
        <div class="field"><label for="fTitle" class="muted" style="font-size:13px">æ¨™é¡Œ</label><input id="fTitle" type="text" style="padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text)" placeholder="ä¾‹ï¼šå°åŒ—å°æ—…è¡Œ" /></div>
        <div class="field"><label for="fDesc" class="muted" style="font-size:13px">æ•˜è¿°</label><textarea id="fDesc" style="padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text);min-height:90px"></textarea></div>
        <div class="field"><label for="fTags" class="muted" style="font-size:13px">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label><input id="fTags" type="text" style="padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text)" placeholder="æ—…éŠ, æœ‹å‹, æ™šä¸Š" /></div>
      </div>
      <div class="modal__footer" style="padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px">
        <button id="btnCancel" class="btn secondary" type="button">å–æ¶ˆ</button>
        <button id="btnSave" class="btn primary" type="button">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script>
  // ============================
  // Day 24ï¼šåˆ†äº«é€£çµï¼ˆID å°æ‡‰ï¼è¨ªå®¢æª¢è¦–ï¼‰
  // ============================

  // LocalStorage Keys
  const LS_PHOTOS = 'pa_photos_v1'; // èˆ‡å…ˆå‰ç›¸å®¹
  const LS_SHARES = 'pa_shares_v1'; // { token: { createdAt, snapshot: PhotoSnapshot } }

  // UI
  const fileInput = document.getElementById('fileInput');
  const searchInput = document.getElementById('searchInput');
  const grid = document.getElementById('grid');
  const countAll = document.getElementById('countAll');
  const countFiltered = document.getElementById('countFiltered');
  const countShown = document.getElementById('countShown');

  const toolbar = document.getElementById('toolbar');
  const ownerView = document.getElementById('ownerView');
  const visitorView = document.getElementById('visitorView');
  const vImg = document.getElementById('vImg');
  const vTitle = document.getElementById('vTitle');
  const vMeta = document.getElementById('vMeta');
  const vDesc = document.getElementById('vDesc');
  const vTags = document.getElementById('vTags');
  const btnVisitHome = document.getElementById('btnVisitHome');

  // Modal (ç°¡ç‰ˆ)
  const modalBackdrop = document.getElementById('modalBackdrop');
  const fTitle = document.getElementById('fTitle');
  const fDesc = document.getElementById('fDesc');
  const fTags = document.getElementById('fTags');
  const btnCancel = document.getElementById('btnCancel');
  const btnSave = document.getElementById('btnSave');

  // ç‹€æ…‹
  /** @typedef {{ id:string, dataUrl:string, name:string, lastModified:number, size:number, title:string, desc:string, tags:string[] }} Photo */
  /** @type {Photo[]} */
  let photos = [];
  let query = '';
  let editingId = null;

  function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
  function prettySize(bytes){const u=['B','KB','MB','GB'];let i=0,n=bytes;while(n>=1024&&i<u.length-1){n/=1024;i++}return n.toFixed(1)+' '+u[i]}
  function fileNameWithoutExt(name){if(typeof name!=='string') return 'image'; const i=name.lastIndexOf('.'); return i>0? name.slice(0,i): (name||'image')}
  function fmtFull(ts){const d=new Date(ts||Date.now()); function pad(n){return String(n).padStart(2,'0')} return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes())}

  // Storage helpers
  function safeGetLS(key){try{return localStorage.getItem(key)}catch(e){return null}}
  function safeSetLS(key,val){try{localStorage.setItem(key,val);return true}catch(e){alert('LocalStorage å¯«å…¥å¤±æ•—');return false}}
  function loadPhotos(){const raw=safeGetLS(LS_PHOTOS); if(!raw) return []; try{const arr=JSON.parse(raw); return Array.isArray(arr)?arr:[]}catch(e){return []}}
  function savePhotos(){return safeSetLS(LS_PHOTOS, JSON.stringify(photos))}
  function loadShares(){const raw=safeGetLS(LS_SHARES); if(!raw) return {}; try{const obj=JSON.parse(raw); return obj && typeof obj==='object'? obj: {} }catch(e){return {}}}
  function saveShares(map){return safeSetLS(LS_SHARES, JSON.stringify(map))}

  // è®€æª”ç‚º DataURL
  function readFileAsDataURL(file){return new Promise(function(resolve,reject){const r=new FileReader(); r.onerror=function(){reject(new Error('è®€æª”å¤±æ•—'))}; r.onload=function(){resolve(r.result)}; r.readAsDataURL(file); })}

  // ====== Owner è¦–åœ–ï¼šæ¸²æŸ“ ======
  function baseFilter(list){ const q=(query||'').trim().toLowerCase(); if(!q) return list.slice(); const tokens=q.split(/\s+/).filter(function(s){return !!s}); return list.filter(function(p){ const hay=[p.title||'', p.desc||'', (p.tags||[]).join(' '), p.name||''].join(' ').toLowerCase(); return tokens.every(function(tok){return hay.indexOf(tok)>=0}); }) }
  function render(){ const data=baseFilter(photos); const frag=document.createDocumentFragment(); if(data.length===0){ const empty=document.createElement('div'); empty.className='card'; empty.style.padding='20px'; empty.textContent = photos.length? 'æ²’æœ‰ç¬¦åˆçš„çµæœã€‚':'å°šç„¡ç…§ç‰‡ï¼Œè«‹å…ˆä¸Šå‚³ã€‚'; frag.appendChild(empty); } else { data.forEach(function(p){ const card=document.createElement('article'); card.className='card'; card.dataset.id=p.id; const th=document.createElement('div'); th.className='thumb'; const img=document.createElement('img'); img.src=p.dataUrl; img.alt=p.title||p.name; th.appendChild(img); const meta=document.createElement('div'); meta.className='meta'; const titleRow=document.createElement('div'); titleRow.className='title-row'; const title=document.createElement('div'); title.className='title'; title.textContent=p.title||fileNameWithoutExt(p.name); const btnRow=document.createElement('div'); btnRow.className='actions'; const editBtn=document.createElement('button'); editBtn.className='btn small'; editBtn.type='button'; editBtn.textContent='ç·¨è¼¯'; editBtn.addEventListener('click',function(){ openEditor(p.id); }); const shareBtn=document.createElement('button'); shareBtn.className='btn small primary'; shareBtn.type='button'; shareBtn.textContent='åˆ†äº«'; shareBtn.addEventListener('click',function(){ onShare(p.id); }); const copyBtn=document.createElement('button'); copyBtn.className='btn small secondary'; copyBtn.type='button'; copyBtn.textContent='è¤‡è£½é€£çµ'; copyBtn.addEventListener('click',function(){ copyShareLink(p.id); }); const revokeBtn=document.createElement('button'); revokeBtn.className='btn small danger'; revokeBtn.type='button'; revokeBtn.textContent='å–æ¶ˆåˆ†äº«'; revokeBtn.addEventListener('click',function(){ revokeShare(p.id); }); btnRow.appendChild(editBtn); btnRow.appendChild(shareBtn); btnRow.appendChild(copyBtn); btnRow.appendChild(revokeBtn); titleRow.appendChild(title); titleRow.appendChild(btnRow); const time=document.createElement('div'); time.className='time'; time.textContent='æ™‚é–“ï¼š'+fmtFull(p.lastModified)+'ï½œ'+prettySize(p.size||0); const tagsWrap=document.createElement('div'); tagsWrap.className='tags'; (p.tags||[]).forEach(function(t){ const chip=document.createElement('span'); chip.className='tag'; chip.textContent=t; tagsWrap.appendChild(chip); }); const shareLine=document.createElement('div'); shareLine.className='time'; const token=getShareTokenByPhotoId(p.id); if(token){ const a=document.createElement('a'); a.href=buildShareUrl(token); a.textContent='å·²åˆ†äº«ï¼š'+a.href; a.target='_blank'; shareLine.appendChild(a); } else { shareLine.textContent='å°šæœªåˆ†äº«'; } meta.appendChild(titleRow); meta.appendChild(time); meta.appendChild(tagsWrap); meta.appendChild(shareLine); card.appendChild(th); card.appendChild(meta); frag.appendChild(card); }); } grid.innerHTML=''; grid.appendChild(frag); countAll.textContent=String(photos.length); const filtered=baseFilter(photos).length; countFiltered.textContent=String(filtered); countShown.textContent=String(filtered); }

  // ====== åˆ†äº«åŠŸèƒ½ï¼ˆOwnerï¼‰ ======
  function getShareMap(){ return loadShares(); }
  function getShareTokenByPhotoId(photoId){ const map=getShareMap(); for(const k in map){ if(Object.prototype.hasOwnProperty.call(map,k)){ const rec=map[k]; if(rec && rec.snapshot && rec.snapshot.id===photoId){ return k; } } } return null; }
  function buildShareUrl(token){ const base=location.origin + location.pathname; return base + '?share=' + encodeURIComponent(token); }
  function onShare(id){ const p=photos.find(function(x){return x.id===id}); if(!p) return; let token=getShareTokenByPhotoId(id); const map=getShareMap(); if(!token){ token='sh_'+uid(); const snap={ id:p.id, dataUrl:p.dataUrl, name:p.name, lastModified:p.lastModified, size:p.size, title:p.title, desc:p.desc, tags:Array.isArray(p.tags)? p.tags.slice():[] }; map[token]={ createdAt: Date.now(), snapshot: snap }; saveShares(map); } const url=buildShareUrl(token); openShareDialog(url); render(); }
  function openShareDialog(url){ const ok = confirm('å·²ç”¢ç”Ÿåˆ†äº«é€£çµï¼š\n\n'+url+'\n\næ˜¯å¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Ÿ'); if(ok){ copyText(url); alert('å·²è¤‡è£½åˆ†äº«é€£çµï¼'); } }
  function copyShareLink(id){ const token=getShareTokenByPhotoId(id); if(!token){ alert('å°šæœªåˆ†äº«ï¼Œè«‹å…ˆé»ã€Œåˆ†äº«ã€ç”¢ç”Ÿé€£çµã€‚'); return; } const url=buildShareUrl(token); copyText(url); alert('å·²è¤‡è£½åˆ†äº«é€£çµï¼'); }
  function revokeShare(id){ const token=getShareTokenByPhotoId(id); if(!token){ alert('æ­¤ç…§ç‰‡ç›®å‰æ²’æœ‰åˆ†äº«é€£çµã€‚'); return; } const map=getShareMap(); if(confirm('å–æ¶ˆåˆ†äº«å¾Œï¼Œä»»ä½•æŒæœ‰é€£çµè€…å°‡ç„¡æ³•å†ç€è¦½ã€‚ç¢ºå®šå–æ¶ˆï¼Ÿ')){ delete map[token]; saveShares(map); render(); alert('å·²å–æ¶ˆåˆ†äº«ã€‚'); } }
  function copyText(text){ navigator.clipboard && navigator.clipboard.writeText? navigator.clipboard.writeText(text) : (function(){ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} ta.remove(); })(); }

  // ====== è¨ªå®¢æ¨¡å¼ï¼ˆ?share=TOKENï¼‰ ======
  function getQueryParam(name){ const u=new URL(location.href); return u.searchParams.get(name); }
  function showVisitor(token){ const map=getShareMap(); const rec=map[token]; if(!rec || !rec.snapshot){ ownerView.style.display='none'; toolbar.style.display='none'; visitorView.style.display='block'; const wrap=document.createElement('div'); wrap.textContent='é€£çµå·²å¤±æ•ˆæˆ–ä¸å­˜åœ¨ã€‚'; visitorView.innerHTML=''; visitorView.appendChild(wrap); return; } const p=rec.snapshot; ownerView.style.display='none'; toolbar.style.display='none'; visitorView.style.display='block'; vImg.src=p.dataUrl; vTitle.textContent=p.title || fileNameWithoutExt(p.name); vMeta.textContent='æ™‚é–“ï¼š'+fmtFull(p.lastModified)+'ï½œ'+prettySize(p.size||0); vDesc.textContent=p.desc || 'â€”'; vTags.innerHTML=''; (p.tags||[]).forEach(function(t){ const chip=document.createElement('span'); chip.className='tag'; chip.textContent=t; vTags.appendChild(chip); }); }

  // ====== ç·¨è¼¯ Modalï¼ˆOwnerï¼‰ ======
  function openEditor(id){ const p=photos.find(function(x){return x.id===id}); if(!p) return; editingId=id; fTitle.value=p.title||fileNameWithoutExt(p.name); fDesc.value=p.desc||''; fTags.value=(p.tags||[]).join(', '); showModal(true); setTimeout(function(){ fTitle.focus(); }, 0); }
  function showModal(show){ modalBackdrop.style.display = show? 'flex':'none'; modalBackdrop.setAttribute('aria-hidden', show? 'false': 'true'); if(!show) editingId=null; }
  async function saveEditor(){ const p=photos.find(function(x){return x.id===editingId}); if(!p) return; p.title=String(fTitle.value||'').trim(); p.desc=String(fDesc.value||'').trim(); p.tags=String(fTags.value||'').split(',').map(function(s){return s.trim();}).filter(Boolean); savePhotos(); render(); showModal(false); // è‹¥æ­¤ç…§ç‰‡å·²åˆ†äº«ï¼Œæ›´æ–°å¿«ç…§
    const token=getShareTokenByPhotoId(p.id); if(token){ const map=getShareMap(); const snap={ id:p.id, dataUrl:p.dataUrl, name:p.name, lastModified:p.lastModified, size:p.size, title:p.title, desc:p.desc, tags:Array.isArray(p.tags)? p.tags.slice():[] }; map[token]={ createdAt: map[token].createdAt, snapshot: snap }; saveShares(map); }
  }
  btnCancel.addEventListener('click', function(){ showModal(false); });
  btnSave.addEventListener('click', saveEditor);
  modalBackdrop.addEventListener('click', function(ev){ if(ev.target===modalBackdrop) showModal(false); });
  document.addEventListener('keydown', function(ev){ if(modalBackdrop.style.display==='flex' && ev.key==='Escape') showModal(false); });

  // ====== ä¸Šå‚³ï¼ˆOwnerï¼‰ ======
  fileInput.addEventListener('change', async function(e){ const files=Array.prototype.slice.call(e.target.files||[]); if(!files.length) return; const images=files.filter(function(f){return f.type && f.type.indexOf('image/')===0}); const non=files.filter(function(f){return !f.type || f.type.indexOf('image/')!==0}); if(non.length) alert('å·²ç•¥ééåœ–ç‰‡æª”æ¡ˆ:\n'+non.map(function(f){return 'â€¢ '+f.name}).join('\n')); for(let i=0;i<images.length;i++){ const file=images[i]; try{ const dataUrl=await readFileAsDataURL(file); const photo={ id: uid(), dataUrl: String(dataUrl), name: file.name, lastModified: file.lastModified, size: file.size, title: fileNameWithoutExt(file.name), desc: '', tags: [] }; photos.push(photo); }catch(err){ console.warn('è½‰æ› DataURL å¤±æ•—ï¼š', err); } } savePhotos(); e.target.value=''; render(); });

  // ====== æœå°‹ï¼ˆOwnerï¼‰ ======
  searchInput.addEventListener('input', function(e){ query=e.target.value||''; render(); });

  // ====== è‡ªæˆ‘æ¸¬è©¦ ======
  function runSelfTests(){ console.groupCollapsed('ğŸ” Self-tests for Day 24 (Share)'); try{ // å»ºç«‹å‡è³‡æ–™
      const snap = { id:'p1', dataUrl:'data:image/png;base64,iVBORw0KGgo=', name:'t.png', lastModified:123, size:1, title:'T', desc:'D', tags:['a','b'] };
      const map0 = loadShares(); const token = 'sh_test_'+uid(); map0[token] = { createdAt: Date.now(), snapshot: snap }; saveShares(map0);
      const map1 = loadShares(); console.assert(map1[token] && map1[token].snapshot && map1[token].snapshot.id==='p1', 'åˆ†äº«å¿«ç…§å·²å¯«å…¥');
      // åæŸ¥ç…§ç‰‡ id â†’ token
      function findById(pid){ let got=null; for(const k in map1){ if(Object.prototype.hasOwnProperty.call(map1,k)){ if(map1[k] && map1[k].snapshot && map1[k].snapshot.id===pid){ got=k; break; } } } return got; }
      console.assert(findById('p1')===token, 'å¯ç”±ç…§ç‰‡ id åæŸ¥ token');
      // å–æ¶ˆåˆ†äº«
      delete map1[token]; saveShares(map1); const map2 = loadShares(); console.assert(!map2[token], 'å–æ¶ˆåˆ†äº«æˆåŠŸ');
      console.log('âœ… è‡ªæˆ‘æ¸¬è©¦é€šé');
    }catch(err){ console.error('âŒ è‡ªæˆ‘æ¸¬è©¦å¤±æ•—', err); } console.groupEnd(); }

  // ====== åˆå§‹åŒ– ======
  (function init(){ const shareToken=getQueryParam('share'); if(shareToken){ showVisitor(shareToken); } else { photos=loadPhotos(); render(); } btnVisitHome.addEventListener('click', function(){ const base=location.origin+location.pathname; location.href=base; }); runSelfTests(); })();
  </script>
</body>
</html>

