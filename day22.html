<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Day 22ï½œç·šä¸Šç›¸ç°¿ - å–®å¼µä¸‹è¼‰ï¼ˆCanvas ç¸®æ”¾å£“ç¸®ï¼‰</title>
  <!--
    ä½¿ç”¨æ–¹å¼ï¼š
    1) é€™æ˜¯å–®ä¸€ HTML æª”ï¼Œå­˜æˆ index.html ç›´æ¥é–‹å•Ÿå³å¯ã€‚
    2) ä»Šæ—¥ç›®æ¨™ï¼šåœ¨ç›¸ç‰‡å¡ä¸Šæ–°å¢ã€Œä¸‹è¼‰ã€æŒ‰éˆ•ï¼Œä½¿ç”¨ <canvas> ç¸®æ”¾ï¼†å£“ç¸®å¾Œä¸‹è¼‰ï¼ˆJPEG/PNG/WebPï¼‰ã€‚
       - å¯é¸è¼¸å‡ºæœ€å¤§é‚Šï¼ˆåŸå§‹/4096/2048/1280/800ï¼‰èˆ‡ JPEG/WebP å“è³ªï¼ˆ0.6ï½0.95ï¼‰ã€‚
       - æª”åæ ¼å¼ï¼š<æ¨™é¡Œæˆ–æª”å>_<YYYYMMDD>.å‰¯æª”åã€‚
    3) èˆ‡ Day 21ï¼ˆå¤šç›¸ç°¿ï¼‰ã€Day 20ï¼ˆä¸»é¡Œï¼‰ã€Day 19ï¼ˆéª¨æ¶ï¼‰ç›¸å®¹ã€‚è³‡æ–™ä»å­˜ LocalStorageã€‚
  -->
  <style>
    /* ===== Design Tokens ===== */
    :root{
      color-scheme: light dark;
      --bg:#ffffff; --bg-elev:#f9fafb; --text:#1f2328; --muted:#6b7280; --primary:#ff8c42; --danger:#e11d48;
      --border:#e5e7eb; --radius:14px; --radius-sm:10px; --radius-lg:22px;
      --shadow-1: 0 1px 2px rgba(0,0,0,.04), 0 1px 1px rgba(0,0,0,.02);
      --shadow-2: 0 6px 18px rgba(17,24,39,.10), 0 2px 6px rgba(17,24,39,.06);
      --shadow-3: 0 14px 35px rgba(17,24,39,.16);
      --overlay: rgba(0,0,0,.55); --focus:#2563eb; --container:1200px;
      --thumb-bg:#eef2f7; --chip-bg:#ffffff; --chip-text:#555; --grad-top:#fff; --grad-bottom:#fff7f1;
      --hover-accent: rgba(255,140,66,.45);
      --skeleton-a: rgba(148,163,184,.25); --skeleton-b: rgba(148,163,184,.15);
      --transition-fast: .18s ease;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --bg-elev:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --primary:#ff954f; --danger:#fb7185; --border:#1f2937; --overlay:rgba(0,0,0,.65);
      --thumb-bg:#0f172a; --chip-bg:#0b1220; --chip-text:#cbd5e1; --grad-top:#0b1220; --grad-bottom:#0b1220;
      --hover-accent: rgba(255,149,79,.45);
      --skeleton-a: rgba(148,163,184,.25); --skeleton-b: rgba(148,163,184,.15);
    }
    @media (prefers-color-scheme: dark){
      :root:not([data-theme]){
        --bg:#0b1220; --bg-elev:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --primary:#ff954f; --danger:#fb7185; --border:#1f2937; --overlay:rgba(0,0,0,.65);
        --thumb-bg:#0f172a; --chip-bg:#0b1220; --chip-text:#cbd5e1; --grad-top:#0b1220; --grad-bottom:#0b1220;
        --hover-accent: rgba(255,149,79,.45);
        --skeleton-a: rgba(148,163,184,.25); --skeleton-b: rgba(148,163,184,.15);
      }
    }

    /* ===== Base ===== */
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans CJK TC","Microsoft JhengHei",Arial,sans-serif;line-height:1.65; transition: background-color var(--transition-fast), color var(--transition-fast)}
    .container{max-width:var(--container);margin:0 auto;padding:24px;box-sizing:border-box}

    header.site-header{border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--grad-top),var(--grad-bottom))}
    .brand{display:flex;align-items:center;gap:14px}
    .brand__logo{width:48px;height:48px;border-radius:12px;background:var(--primary);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:900;box-shadow:var(--shadow-2)}
    .brand__title{margin:0;font-size:22px}
    .brand__subtitle{margin:4px 0 0;color:var(--muted);font-size:14px}

    /* Toolbar */
    .toolbar{display:grid;gap:12px;margin-top:16px;align-items:center;grid-template-columns:1fr 220px 170px 150px 150px 130px 160px}
    @media(max-width:1200px){.toolbar{grid-template-columns:1fr 1fr 1fr 1fr}}
    @media(max-width:640px){.toolbar{grid-template-columns:1fr}}
    .toolbar input[type=text],.toolbar select,.toolbar button{padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text);box-shadow:var(--shadow-1)}
    .toolbar input[type=file]{padding:8px;border:1px solid var(--border);border-radius:10px;background:#fff0}
    .toolbar .btn{background:var(--primary);color:#fff;border:none;cursor:pointer;border-radius:10px;padding:12px 14px;font-weight:700;box-shadow:var(--shadow-2);transition:transform .12s ease, box-shadow .12s ease}
    .toolbar .btn:hover{transform:translateY(-1px)}
    .toolbar .btn:active{transform:translateY(0);box-shadow:var(--shadow-1)}

    .switcher{display:flex;gap:8px;align-items:center}
    .switcher .tabbtn{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;cursor:pointer;transition:box-shadow .12s ease, transform .12s ease}
    .switcher .tabbtn:hover{box-shadow:var(--shadow-2);transform:translateY(-1px)}
    .switcher .tabbtn:active{transform:translateY(0)}
    .switcher .tabbtn.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:var(--shadow-2)}
    .badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;padding:0 6px;border-radius:999px;background:var(--border);color:var(--muted);font-size:12px;margin-left:6px}

    main.gallery{margin-top:18px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:990px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}

    /* Card */
    .card{background:var(--bg-elev);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-1);overflow:hidden;display:flex;flex-direction:column;transition:transform .18s ease, box-shadow .18s ease, border-color var(--transition-fast)}
    .card:hover{transform:translateY(-3px);box-shadow:var(--shadow-2);border-color:var(--hover-accent)}
    .thumb{aspect-ratio:4/3;background:var(--thumb-bg);position:relative;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;transform:scale(1);transition:transform .35s ease}
    .card:hover .thumb img{transform:scale(1.04)}
    .meta{padding:12px;display:grid;gap:8px}
    .title-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{font-size:12px;color:var(--muted)}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--chip-text);background:var(--chip-bg);box-shadow:var(--shadow-1)}
    .actions{display:flex;gap:8px}
    .btn.small{padding:8px 10px;font-size:12px;border-radius:10px;border:1px solid var(--border);background:#fff0;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .btn.small:hover{box-shadow:var(--shadow-2);transform:translateY(-1px)}
    .btn.small:active{transform:translateY(0)}
    .btn.danger{background:var(--danger);color:#fff;border:none}
    .btn.cover{background:#fff0;color:var(--primary);border:1px solid var(--primary)}
    .btn.download{background:#fff0;border:1px solid var(--border)}
    .cover-ind{font-size:11px;color:var(--primary);font-weight:700;border:1px solid var(--primary);padding:2px 6px;border-radius:999px}

    .statusbar{display:flex;align-items:center;justify-content:space-between;margin:8px 0 12px;color:var(--muted);font-size:13px}
    .empty{border:2px dashed var(--border);border-radius:var(--radius);padding:24px;color:var(--muted);display:flex;align-items:center;justify-content:center;grid-column:1/-1;background:#fff0}

    .pager{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:16px}
    .pager .btn{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:12px 18px;cursor:pointer;font-weight:800;box-shadow:var(--shadow-2)}
    .pager .btn[disabled]{opacity:.55;cursor:not-allowed}
    .pager .hint{color:var(--muted);font-size:13px}

    /* Modal é€šç”¨ */
    .modal-backdrop{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal{width:600px;max-width:720px;background:var(--bg);border-radius:var(--radius-lg);border:1px solid var(--border);box-shadow:var(--shadow-3);overflow:hidden}
    .modal__header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:900}
    .modal__body{padding:16px;display:grid;gap:12px}
    .modal__footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
    .field{display:grid;gap:6px}
    .field label{font-size:13px;color:var(--muted)}
    .field input[type=text],.field textarea,.field select,.field input[type=number]{width:100%;box-sizing:border-box;padding:12px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text);box-shadow:var(--shadow-1)}
    .field .inline{display:flex;gap:8px;align-items:center}
    .btn.secondary{background:#fff0;border:1px solid var(--border);color:var(--text)}
    .btn.primary{background:var(--primary);color:#fff;border:none}
  </style>
  <!-- exif-jsï¼ˆDay 15 å»¶çºŒï¼›è¼‰ä¸åˆ°ä¹Ÿä¸å½±éŸ¿ä»Šå¤©åŠŸèƒ½ï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" integrity="sha512-sSWq7J7V7x1Gk2YgG9XgVQwO4TtF2v3m7zq2jv1Wn0fS9zF+v4uE7wUuJ7c3OeJqf8i9mnnm2n6O1i8wCw3Wiw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">PA</div>
        <div>
          <h1 class="brand__title">ç·šä¸Šç›¸ç°¿ï¼ˆDay 22ï¼‰</h1>
          <p class="brand__subtitle">åœ–ç‰‡ä¸‹è¼‰ï¼šå–®å¼µå£“ç¸®ç‰ˆæœ¬ï¼ˆCanvas ç¸®æ”¾ï¼JPEG/PNG/WebPï¼‰</p>
        </div>
      </div>

      <div class="toolbar" role="region" aria-label="å·¥å…·åˆ—">
        <input id="searchInput" type="text" placeholder="æœå°‹é—œéµå­—ï¼ˆæ¨™é¡Œï¼æ•˜è¿°ï¼æ¨™ç±¤ï¼æª”åï¼‰" aria-label="æœå°‹">
        <input id="fileInput" type="file" accept="image/*" multiple aria-label="ä¸Šå‚³åœ–ç‰‡">
        <select id="albumSelect" aria-label="ç›¸ç°¿"></select>
        <select id="sortBy" aria-label="æ’åºä¾æ“š">
          <option value="time" selected>ä¾æ™‚é–“</option>
          <option value="title">ä¾æ¨™é¡Œ</option>
          <option value="custom">è‡ªè¨‚ï¼ˆæ‹–æ›³ï¼‰</option>
        </select>
        <select id="sortOrder" aria-label="å‡å†ªæˆ–é™å†ª">
          <option value="desc" selected>é™å†ª</option>
          <option value="asc">å‡å†ª</option>
        </select>
        <select id="pageSize" aria-label="æ¯é ç­†æ•¸">
          <option value="8">æ¯é  8 å¼µ</option>
          <option value="12" selected>æ¯é  12 å¼µ</option>
          <option value="16">æ¯é  16 å¼µ</option>
          <option value="24">æ¯é  24 å¼µ</option>
        </select>
        <div class="switcher" style="grid-column:1/-1; gap:12px; align-items:center;">
          <button id="tabLibrary" class="tabbtn active" type="button">ç›¸ç‰‡</button>
          <button id="tabAlbums" class="tabbtn" type="button">ç›¸ç°¿åˆ—è¡¨</button>
          <button id="tabTrash" class="tabbtn" type="button">å›æ”¶æ¡¶ <span id="trashBadge" class="badge">0</span></button>
          <span style="margin-left:auto; color:var(--muted); font-size:13px;">ä¸»é¡Œï¼š</span>
          <select id="themeSelect" aria-label="ä¸»é¡Œåˆ‡æ›">
            <option value="system" selected>ç³»çµ±</option>
            <option value="light">æ·ºè‰²</option>
            <option value="dark">æ·±è‰²</option>
          </select>
          <button id="manageAlbumsBtn" class="btn" type="button" title="ç®¡ç†ç›¸ç°¿">ç®¡ç†ç›¸ç°¿</button>
        </div>
        <div style="grid-column: 1 / -1; font-size:13px; color:var(--muted);">
          æç¤ºï¼šé»å¡ç‰‡ä¸Šçš„ã€Œä¸‹è¼‰ã€å¯é¸æ“‡è¼¸å‡ºæ ¼å¼/å°ºå¯¸/å“è³ªï¼Œä½¿ç”¨ Canvas å®¢è£½åŒ–å£“ç¸®å¾Œä¸‹è¼‰ã€‚
        </div>
      </div>
    </div>
  </header>

  <main class="gallery">
    <div class="container">
      <div class="statusbar" aria-live="polite">
        <div><span id="countAll">0</span> å¼µç…§ç‰‡</div>
        <div>å·²é¡¯ç¤ºï¼š<span id="countShown">0</span>ï¼ç¬¦åˆï¼š<span id="countFiltered">0</span> å¼µ</div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px;">
        <button id="emptyTrashBtn" class="btn danger small" type="button" title="æ°¸ä¹…æ¸…ç©ºå›æ”¶æ¡¶" style="display:none;">æ¸…ç©ºå›æ”¶æ¡¶</button>
        <button id="clearBtn" class="btn secondary small" type="button" title="æ¸…ç©ºå…¨éƒ¨è³‡æ–™">æ¸…ç©ºå…¨éƒ¨ï¼ˆå«å›æ”¶æ¡¶ & å°é¢ & ç›¸ç°¿ï¼‰</button>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div class="pager" id="pager" style="display:flex;">
        <button id="loadMoreBtn" class="btn" type="button">è¼‰å…¥æ›´å¤š</button>
        <span class="hint" id="pagerHint"></span>
      </div>
    </div>
  </main>

  <!-- ====== Modalï¼šç·¨è¼¯åœ–ç‰‡ä¸­ç¹¼è³‡æ–™ ====== -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div class="modal__header" id="modalTitle">ç·¨è¼¯åœ–ç‰‡è³‡è¨Š</div>
      <div class="modal__body">
        <div class="field">
          <label for="fTitle">æ¨™é¡Œ</label>
          <input id="fTitle" type="text" placeholder="ä¾‹ï¼šå°åŒ—å°æ—…è¡Œ" />
        </div>
        <div class="field">
          <label for="fDesc">æ•˜è¿°</label>
          <textarea id="fDesc" placeholder="ç°¡çŸ­æè¿°é€™å¼µç…§ç‰‡...ï¼ˆéå¿…å¡«ï¼‰"></textarea>
        </div>
        <div class="field">
          <label for="fTags">æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿ , åˆ†éš”ï¼‰</label>
          <input id="fTags" type="text" placeholder="ä¾‹ï¼šæ—…éŠ, æœ‹å‹, æ™šä¸Š" />
        </div>
        <div class="field">
          <label for="fAlbum">ç›¸ç°¿</label>
          <select id="fAlbum"></select>
        </div>
      </div>
      <div class="modal__footer">
        <button id="btnCancel" class="btn secondary" type="button">å–æ¶ˆ</button>
        <button id="btnSave" class="btn primary" type="button">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- ====== Modalï¼šç®¡ç†ç›¸ç°¿ ====== -->
  <div id="albumModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="albumModalTitle">
      <div class="modal__header" id="albumModalTitle">ç®¡ç†ç›¸ç°¿</div>
      <div class="modal__body" id="albumModalBody">
        <div class="field" style="grid-template-columns:1fr auto; align-items:end;">
          <div>
            <label for="newAlbumName">æ–°å¢ç›¸ç°¿åç¨±</label>
            <input id="newAlbumName" type="text" placeholder="ä¾‹ï¼šæ—…è¡Œã€å®¶åº­ã€å¯µç‰©..." />
          </div>
          <button id="createAlbumBtn" class="btn primary" type="button">å»ºç«‹</button>
        </div>
        <div id="albumList" style="display:grid; gap:10px"></div>
      </div>
      <div class="modal__footer">
        <button id="btnAlbumClose" class="btn secondary" type="button">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- ====== Modalï¼šä¸‹è¼‰è¨­å®š ====== -->
  <div id="downloadModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="downloadModalTitle">
      <div class="modal__header" id="downloadModalTitle">ä¸‹è¼‰è¨­å®š</div>
      <div class="modal__body">
        <div class="field">
          <label for="dlFormat">æ ¼å¼</label>
          <select id="dlFormat">
            <option value="image/jpeg" selected>JPEGï¼ˆç›¸å®¹æ€§é«˜ï¼‰</option>
            <option value="image/webp">WebPï¼ˆé«˜å£“ç¸®ï¼‰</option>
            <option value="image/png">PNGï¼ˆç„¡æï¼‰</option>
          </select>
        </div>
        <div class="field">
          <label for="dlMax">æœ€å¤§é‚Šå°ºå¯¸</label>
          <select id="dlMax">
            <option value="orig">ä¿ç•™åŸå§‹å°ºå¯¸</option>
            <option value="4096">4096 px</option>
            <option value="2048" selected>2048 px</option>
            <option value="1280">1280 px</option>
            <option value="800">800 px</option>
          </select>
        </div>
        <div class="field">
          <label for="dlQuality">å“è³ªï¼ˆåƒ… JPEG/WebPï¼‰</label>
          <div class="inline"><input id="dlQuality" type="number" min="0.5" max="0.98" step="0.01" value="0.9" style="max-width:140px"><span class="time">å»ºè­° 0.85â€“0.95</span></div>
        </div>
        <div class="field">
          <label>æª”åé è¦½</label>
          <div id="dlFilenamePreview" class="time">â€”</div>
        </div>
      </div>
      <div class="modal__footer">
        <button id="btnDlCancel" class="btn secondary" type="button">å–æ¶ˆ</button>
        <button id="btnDlStart" class="btn primary" type="button">ä¸‹è¼‰</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container" style="border-top:1px solid var(--border); margin-top:24px; padding-top:16px; color:var(--muted); font-size:13px; text-align:center;">
      Day 22 å®Œæˆï¼šCanvas ç¸®æ”¾å£“ç¸®å¾Œä¸‹è¼‰ï¼ˆå–®å¼µï¼‰ã€‚
    </div>
  </footer>

  <script>
    // ============================
    // Day 22ï¼šåœ–ç‰‡ä¸‹è¼‰ï¼ˆå–®å¼µå£“ç¸®ï¼ŒCanvas ç¸®æ”¾ï¼‰
    // æ‰¿æ¥ Day 21ï¼šå¤šç›¸ç°¿ / å°é¢ / ä¸»é¡Œ / éª¨æ¶ / å›æ”¶æ¡¶
    // ============================

    // LocalStorage Keys
    const LS_PHOTOS = 'pa_photos_v1';
    const LS_ALBUMS = 'pa_albums_v1';
    const LS_THEME = 'pa_theme_pref_v1';

    // å·¥å…·åˆ—
    const fileInput = document.getElementById('fileInput');
    const searchInput = document.getElementById('searchInput');
    const albumSelect = document.getElementById('albumSelect');
    const sortBySelect = document.getElementById('sortBy');
    const sortOrderSelect = document.getElementById('sortOrder');
    const pageSizeSelect = document.getElementById('pageSize');

    const grid = document.getElementById('grid');
    const pager = document.getElementById('pager');
    const clearBtn = document.getElementById('clearBtn');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const pagerHint = document.getElementById('pagerHint');

    const countAll = document.getElementById('countAll');
    const countFiltered = document.getElementById('countFiltered');
    const countShown = document.getElementById('countShown');

    const tabLibrary = document.getElementById('tabLibrary');
    const tabAlbums = document.getElementById('tabAlbums');
    const tabTrash = document.getElementById('tabTrash');
    const trashBadge = document.getElementById('trashBadge');
    const emptyTrashBtn = document.getElementById('emptyTrashBtn');

    const themeSelect = document.getElementById('themeSelect');
    const manageAlbumsBtn = document.getElementById('manageAlbumsBtn');

    // Modalï¼šç…§ç‰‡ç·¨è¼¯
    const modalBackdrop = document.getElementById('modalBackdrop');
    const fTitle = document.getElementById('fTitle');
    const fDesc = document.getElementById('fDesc');
    const fTags = document.getElementById('fTags');
    const fAlbum = document.getElementById('fAlbum');
    const btnCancel = document.getElementById('btnCancel');
    const btnSave = document.getElementById('btnSave');

    // Modalï¼šç›¸ç°¿ç®¡ç†
    const albumModalBackdrop = document.getElementById('albumModalBackdrop');
    const newAlbumName = document.getElementById('newAlbumName');
    const createAlbumBtn = document.getElementById('createAlbumBtn');
    const albumList = document.getElementById('albumList');
    const btnAlbumClose = document.getElementById('btnAlbumClose');

    // Modalï¼šä¸‹è¼‰
    const downloadModalBackdrop = document.getElementById('downloadModalBackdrop');
    const dlFormat = document.getElementById('dlFormat');
    const dlMax = document.getElementById('dlMax');
    const dlQuality = document.getElementById('dlQuality');
    const dlFilenamePreview = document.getElementById('dlFilenamePreview');
    const btnDlCancel = document.getElementById('btnDlCancel');
    const btnDlStart = document.getElementById('btnDlStart');

    // ç‹€æ…‹
    /** @type {{ id:string, dataUrl:string, name:string, lastModified:number, size:number, title:string, desc:string, tags:string[], albumId?:string, category?:string, exif?: { dateTakenMs?: number|null, make?: string|null, model?: string|null, orientation?: number|null }, isDeleted?: boolean, deletedAt?: number|null, orderIndex?: number }[]} */
    let photos = [];
    /** @type {{ id:string, name:string, orderIndex:number, coverPhotoId?:string|null }[]} */
    let albums = [];

    let editingId = null;
    let query = '';
    let currentAlbumId = 'all';
    let sortBy = 'time';
    let sortOrder = 'desc';
    let pageSize = 12;
    let visibleCount = pageSize;
    let showTrash = false;
    let showAlbumsView = false;
    let isLoadingUI = false;

    // ä¸‹è¼‰ç”¨æš«å­˜
    let pendingDownloadPhotoId = null;

    const DEFAULT_ALBUM_NAME = 'æœªåˆ†é¡';

    // ========== ä¸»é¡Œ ==========
    const mediaDark = window.matchMedia('(prefers-color-scheme: dark)');
    function getSavedTheme(){ try{ return localStorage.getItem(LS_THEME) || 'system'; }catch(e){ return 'system'; } }
    function saveThemePref(pref){ try{ localStorage.setItem(LS_THEME, pref); }catch(_){} }
    function applyTheme(pref){ if(pref==='light'){ document.documentElement.setAttribute('data-theme','light'); } else if(pref==='dark'){ document.documentElement.setAttribute('data-theme','dark'); } else { document.documentElement.removeAttribute('data-theme'); } }
    function syncThemeWithSystem(){ const pref = getSavedTheme(); if(pref==='system'){ applyTheme('system'); render(); } }
    mediaDark.addEventListener?.('change', syncThemeWithSystem);

    // ========== Utils ==========
    function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
    function prettySize(bytes){const u=['B','KB','MB','GB'];let i=0,n=bytes;while(n>=1024&&i<u.length-1){n/=1024;i++}return `${n.toFixed(1)} ${u[i]}`}
    function fileNameWithoutExt(name=''){const i=name.lastIndexOf('.');return i>0?name.slice(0,i):name||'æœªå‘½ååœ–ç‰‡'}
    function fmt(dt){ const d=new Date(dt||Date.now()); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` }
    function fmtFull(dt){ const d=new Date(dt||Date.now()); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` }

    function safeGetLS(key){try{return localStorage.getItem(key)}catch(e){console.warn('è®€å– LS å¤±æ•—',e);return null}}
    function safeSetLS(key,val){try{localStorage.setItem(key,val);return true}catch(e){alert('å„²å­˜å¤±æ•—ï¼Œå¯èƒ½è¶…é LocalStorage å®¹é‡ã€‚');console.warn('å¯«å…¥ LS å¤±æ•—',e);return false}}

    function savePhotos(){ return safeSetLS(LS_PHOTOS, JSON.stringify(photos)); }
    function loadPhotos(){ const raw=safeGetLS(LS_PHOTOS); if(!raw) return []; try{ const arr=JSON.parse(raw); return Array.isArray(arr)?arr:[]; }catch(e){ return []; } }

    function saveAlbums(){ return safeSetLS(LS_ALBUMS, JSON.stringify(albums)); }
    function loadAlbums(){ const raw=safeGetLS(LS_ALBUMS); if(!raw) return []; try{ const arr=JSON.parse(raw); return Array.isArray(arr)?arr:[]; }catch(e){ return []; } }

    // ========== Albums CRUDï¼ˆç°¡ç‰ˆï¼šæ²¿ç”¨ Day 21ï¼‰ ==========
    function createAlbum(name){ const n=(name||'').trim(); if(!n) return alert('è«‹è¼¸å…¥ç›¸ç°¿åç¨±'); if(albums.some(a=>a.name===n)) return alert('å·²æœ‰åŒåç›¸ç°¿'); const maxOrder=albums.reduce((m,a)=>Math.max(m,a.orderIndex||0),0); const a={id:uid(),name:n,orderIndex:maxOrder+10,coverPhotoId:null}; albums.push(a); saveAlbums(); buildAlbumSelect(); render(); return a.id; }
    function renameAlbum(id, newName){ const a=albums.find(x=>x.id===id); if(!a) return; const n=(newName||'').trim(); if(!n) return alert('åç¨±ä¸å¯ç‚ºç©º'); if(albums.some(x=>x.name===n && x.id!==id)) return alert('å·²æœ‰åŒåç›¸ç°¿'); a.name=n; saveAlbums(); buildAlbumSelect(); render(); }
    function deleteAlbum(id){ const aIdx=albums.findIndex(x=>x.id===id); if(aIdx<0) return; const a=albums[aIdx]; if(!confirm(`åˆªé™¤ç›¸ç°¿ã€Œ${a.name}ã€ï¼Ÿç›¸ç°¿å…§çš„ç…§ç‰‡ä¸æœƒè¢«åˆªé™¤ï¼Œå°‡ç§»è‡³ã€Œ${DEFAULT_ALBUM_NAME}ã€ã€‚`)) return; let uncat=albums.find(x=>x.name===DEFAULT_ALBUM_NAME); if(!uncat){ const uncatId=createAlbum(DEFAULT_ALBUM_NAME); uncat=albums.find(x=>x.id===uncatId); } photos.forEach(p=>{ if(!p.isDeleted && (p.albumId===a.id)) p.albumId=uncat.id; }); const deletingIsCurrent=(currentAlbumId===a.id); albums.splice(aIdx,1); saveAlbums(); savePhotos(); if(deletingIsCurrent){ currentAlbumId='all'; albumSelect.value='all'; } render(); buildAlbumSelect(); }

    // Covers
    function coverOfAlbum(albumId){ const a=albums.find(x=>x.id===albumId); if(!a) return null; if(a.coverPhotoId){ const p=photos.find(x=>x.id===a.coverPhotoId && !x.isDeleted && x.albumId===albumId); if(p) return p; } const arr=photos.filter(p=>!p.isDeleted && p.albumId===albumId).sort((p1,p2)=>Number(p2.lastModified||0)-Number(p1.lastModified||0)); return arr[0]||null; }
    function setCover(albumId, photoId){ const a=albums.find(x=>x.id===albumId); if(!a) return; a.coverPhotoId=photoId; saveAlbums(); render(); }
    function clearCover(albumId){ const a=albums.find(x=>x.id===albumId); if(!a) return; a.coverPhotoId=null; saveAlbums(); render(); }
    function reconcileCovers(){ let changed=false; albums.forEach(a=>{ if(!a.coverPhotoId) return; const p=photos.find(x=>x.id===a.coverPhotoId); if(!p || p.isDeleted || p.albumId!==a.id){ a.coverPhotoId=null; changed=true; } }); if(changed) saveAlbums(); }

    // ========== Albums é¸å–® ==========
    function buildAlbumSelect(){ const prev=currentAlbumId; albumSelect.innerHTML=''; const optAll=new Option('å…¨éƒ¨ç›¸ç°¿','all'); albumSelect.appendChild(optAll); albums.slice().sort((a,b)=>a.orderIndex-b.orderIndex).forEach(a=>albumSelect.appendChild(new Option(a.name,a.id))); albumSelect.value=Array.from(albumSelect.options).some(o=>o.value===prev)?prev:'all'; currentAlbumId=albumSelect.value; fAlbum.innerHTML=''; albums.slice().sort((a,b)=>a.orderIndex-b.orderIndex).forEach(a=>fAlbum.appendChild(new Option(a.name,a.id))); }

    // ========== æ¸…å–®æ¸²æŸ“ ==========
    function baseFilter(list){ const q=(query||'').trim().toLowerCase(); const tokens=q?q.split(/\s+/).filter(Boolean):[]; return list.filter(p=>{ if(showAlbumsView) return false; const inTrash=!!p.isDeleted; if(showTrash? !inTrash : inTrash) return false; if(!showTrash && currentAlbumId!=='all' && p.albumId!==currentAlbumId) return false; if(!tokens.length) return true; const hay=[p.title||'',p.desc||'',(p.tags||[]).join(' '),p.name||''].join(' ').toLowerCase(); return tokens.every(tok=>hay.includes(tok)); }) }
    function sortPhotos(list){ const arr=list.slice(); const order=sortOrder==='asc'?1:-1; if(sortBy==='custom'){ arr.sort((a,b)=>{ const aIdx= typeof a.orderIndex==='number'? a.orderIndex : Number.MAX_SAFE_INTEGER; const bIdx= typeof b.orderIndex==='number'? b.orderIndex : Number.MAX_SAFE_INTEGER; if(aIdx===bIdx) return 0; return (aIdx>bIdx?1:-1); }); } else if(sortBy==='time'){ arr.sort((a,b)=>{const t1=Number(a.lastModified||0),t2=Number(b.lastModified||0);return (t1===t2?0:(t1>t2?1:-1))*order}); } else { arr.sort((a,b)=>{const s1=(a.title||fileNameWithoutExt(a.name)).toLowerCase();const s2=(b.title||fileNameWithoutExt(b.name)).toLowerCase();if(s1===s2) return 0;return (s1>s2?1:-1)*order}); } return arr }
    function getFilteredSorted(){return sortPhotos(baseFilter(photos))}
    function getVisibleData(){return getFilteredSorted().slice(0, visibleCount)}

    function updateCounters(){ const trashCount=photos.filter(p=>p.isDeleted).length; trashBadge.textContent=String(trashCount); }
    function updatePagerUI(total){ const shown=Math.min(visibleCount,total); countAll.textContent=String(photos.filter(p=>!p.isDeleted).length); countFiltered.textContent=String(total); countShown.textContent=String(shown); const hasMore=shown<total; const showPager=!showAlbumsView; pager.style.display= showPager? 'flex':'none'; if(showPager){ loadMoreBtn.disabled=!hasMore; pagerHint.textContent = hasMore ? `å°šæœ‰ ${total - shown} å¼µæœªé¡¯ç¤º` : (total===0 ? (showTrash?'å›æ”¶æ¡¶æ²’æœ‰å…§å®¹':'æ²’æœ‰ç¬¦åˆçš„ç›¸ç‰‡') : 'å·²é¡¯ç¤ºå…¨éƒ¨'); } emptyTrashBtn.style.display= showTrash? 'inline-flex':'none'; }

    function renderAlbumsView(){ const frag=document.createDocumentFragment(); const list=albums.slice().sort((a,b)=>a.orderIndex-b.orderIndex); if(list.length===0){ const empty=document.createElement('div'); empty.className='empty'; empty.textContent='ç›®å‰æ²’æœ‰ç›¸ç°¿ï¼Œè«‹å…ˆå»ºç«‹ã€‚'; frag.appendChild(empty); } else { list.forEach(a=>{ const card=document.createElement('article'); card.className='card'; const th=document.createElement('div'); th.className='thumb'; const p=coverOfAlbum(a.id); const img=document.createElement('img'); if(p){ img.src=p.dataUrl; img.alt=`${a.name} å°é¢`; } else { const fill=getComputedStyle(document.documentElement).getPropertyValue('--thumb-bg').trim()||'#eef2f7'; img.src='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><rect width="100%" height="100%" fill="${fill}"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-family="sans-serif" font-size="20">${a.name}</text></svg>`); img.alt=`${a.name}ï¼ˆå°šç„¡ç…§ç‰‡ï¼‰`; } th.appendChild(img); const meta=document.createElement('div'); meta.className='meta'; const titleRow=document.createElement('div'); titleRow.className='title-row'; const title=document.createElement('div'); title.className='title'; title.textContent=a.name; const btnRow=document.createElement('div'); btnRow.className='actions'; const viewBtn=document.createElement('button'); viewBtn.className='btn small'; viewBtn.type='button'; viewBtn.textContent='æŸ¥çœ‹'; viewBtn.addEventListener('click',()=>{ currentAlbumId=a.id; albumSelect.value=a.id; setTab('library'); }); const clrBtn=document.createElement('button'); clrBtn.className='btn small secondary'; clrBtn.type='button'; clrBtn.textContent='æ¸…é™¤å°é¢'; clrBtn.addEventListener('click',()=>clearCover(a.id)); btnRow.appendChild(viewBtn); btnRow.appendChild(clrBtn); titleRow.appendChild(title); titleRow.appendChild(btnRow); const metaLine=document.createElement('div'); metaLine.className='time'; const count=photos.filter(p=>!p.isDeleted && p.albumId===a.id).length; metaLine.textContent = `ç›¸ç‰‡ ${count} å¼µ ${a.coverPhotoId? 'ï½œå·²æŒ‡å®šå°é¢' : (p? 'ï½œé è¨­å°é¢ï¼ˆæœ€æ–°ï¼‰' : '')}`; meta.appendChild(titleRow); meta.appendChild(metaLine); card.appendChild(th); card.appendChild(meta); frag.appendChild(card); }) } grid.innerHTML=''; grid.appendChild(frag); countFiltered.textContent='â€”'; countShown.textContent='â€”'; updateCounters(); pager.style.display='none'; }

    function renderPhotosView(){ const data=getVisibleData(); const total=getFilteredSorted().length; updateCounters(); updatePagerUI(total); const frag=document.createDocumentFragment(); if(data.length===0){ const empty=document.createElement('div'); empty.className='empty'; empty.textContent = showTrash ? 'å›æ”¶æ¡¶æ˜¯ç©ºçš„ã€‚' : (photos.filter(p=>!p.isDeleted).length===0?'é‚„æ²’æœ‰ç›¸ç‰‡ï¼Œè«‹å¾ä¸Šæ–¹ä¸Šå‚³ã€‚':'æ²’æœ‰ç¬¦åˆç›®å‰æœå°‹/ç›¸ç°¿çš„çµæœã€‚'); frag.appendChild(empty); } else { data.forEach((p)=>{ const card=document.createElement('article'); card.className='card'; card.dataset.id=p.id; const th=document.createElement('div'); th.className='thumb'; const img=document.createElement('img'); img.src=p.dataUrl; img.alt=p.title||p.name; th.appendChild(img); const meta=document.createElement('div'); meta.className='meta'; const titleRow=document.createElement('div'); titleRow.className='title-row'; const title=document.createElement('div'); title.className='title'; title.textContent=p.title||fileNameWithoutExt(p.name); const btnRow=document.createElement('div'); btnRow.className='actions'; if(showTrash){ const restoreBtn=document.createElement('button'); restoreBtn.className='btn small'; restoreBtn.type='button'; restoreBtn.textContent='é‚„åŸ'; restoreBtn.addEventListener('click',()=>restorePhoto(p.id)); const delBtn=document.createElement('button'); delBtn.className='btn small danger'; delBtn.type='button'; delBtn.textContent='æ°¸ä¹…åˆªé™¤'; delBtn.addEventListener('click',()=>permanentlyDelete(p.id)); btnRow.appendChild(restoreBtn); btnRow.appendChild(delBtn); }else{ const editBtn=document.createElement('button'); editBtn.className='btn small'; editBtn.type='button'; editBtn.textContent='ç·¨è¼¯'; editBtn.addEventListener('click',()=>openEditor(p.id)); const trashBtn=document.createElement('button'); trashBtn.className='btn small danger'; trashBtn.type='button'; trashBtn.textContent='åˆªé™¤'; trashBtn.addEventListener('click',()=>moveToTrash(p.id)); const coverBtn=document.createElement('button'); coverBtn.className='btn small cover'; coverBtn.type='button'; coverBtn.textContent='è¨­ç‚ºå°é¢'; coverBtn.addEventListener('click',()=>{ setCover(p.albumId, p.id); }); const downloadBtn=document.createElement('button'); downloadBtn.className='btn small download'; downloadBtn.type='button'; downloadBtn.textContent='ä¸‹è¼‰'; downloadBtn.addEventListener('click',()=>openDownloadModal(p.id)); btnRow.appendChild(editBtn); btnRow.appendChild(trashBtn); btnRow.appendChild(coverBtn); btnRow.appendChild(downloadBtn); } titleRow.appendChild(title); titleRow.appendChild(btnRow); const time=document.createElement('div'); time.className='time'; const aName=(albums.find(a=>a.id===p.albumId)?.name)||DEFAULT_ALBUM_NAME; const isCover=!!albums.find(a=>a.id===p.albumId && a.coverPhotoId===p.id); const coverBadge=isCover? `ï½œ`+`<span class="cover-ind">${aName} å°é¢</span>` : ''; time.innerHTML=`æ™‚é–“ï¼š${fmtFull(p.lastModified)}ï½œ${prettySize(p.size||0)}ï½œç›¸ç°¿ï¼š${aName} ${coverBadge}`; const tagsWrap=document.createElement('div'); tagsWrap.className='tags'; (p.tags||[]).filter(Boolean).forEach(t=>{const chip=document.createElement('span'); chip.className='tag'; chip.textContent=t; tagsWrap.appendChild(chip)}); meta.appendChild(titleRow); meta.appendChild(time); meta.appendChild(tagsWrap); card.appendChild(th); card.appendChild(meta); frag.appendChild(card); }) } grid.innerHTML=''; grid.appendChild(frag); }

    function render(){ if(showAlbumsView){ renderAlbumsView(); } else { renderPhotosView(); } }

    // ========== Skeleton ==========
    function showSkeleton(n){ const frag=document.createDocumentFragment(); for(let i=0;i<n;i++){ const card=document.createElement('article'); card.className='card skel'; const th=document.createElement('div'); th.className='thumb'; th.style.background='linear-gradient(90deg, var(--skeleton-a) 25%, var(--skeleton-b) 37%, var(--skeleton-a) 63%)'; th.style.animation='skeleton 1.1s ease-in-out infinite'; th.style.backgroundSize='400% 100%'; card.appendChild(th); const meta=document.createElement('div'); meta.className='meta'; const l1=document.createElement('div'); l1.style.height='16px'; l1.style.background='linear-gradient(90deg, var(--skeleton-a) 25%, var(--skeleton-b) 37%, var(--skeleton-a) 63%)'; l1.style.animation='skeleton 1.1s ease-in-out infinite'; l1.style.backgroundSize='400% 100%'; l1.style.borderRadius='8px'; const l2=document.createElement('div'); l2.style.height='12px'; l2.style.background='linear-gradient(90deg, var(--skeleton-a) 25%, var(--skeleton-b) 37%, var(--skeleton-a) 63%)'; l2.style.animation='skeleton 1.1s ease-in-out infinite'; l2.style.backgroundSize='400% 100%'; l2.style.borderRadius='8px'; l2.style.width='60%'; meta.appendChild(l1); meta.appendChild(l2); card.appendChild(meta); frag.appendChild(card); } grid.innerHTML=''; grid.appendChild(frag); }
    function softRender(){ if(isLoadingUI) return; isLoadingUI=true; const total=getFilteredSorted().length||pageSize; showSkeleton(Math.min(pageSize, Math.max(6, Math.min(total, pageSize)))); requestAnimationFrame(()=>{ setTimeout(()=>{ isLoadingUI=false; render(); }, 220); }); }

    // ========== File è®€å– ==========
    function readFileAsDataURL(file){return new Promise((resolve,reject)=>{const r=new FileReader();r.onerror=()=>reject(new Error('è®€æª”å¤±æ•—'));r.onload=()=>resolve(r.result);r.readAsDataURL(file)})}

    // ========== Trash ==========
    function moveToTrash(id){ const p=photos.find(x=>x.id===id); if(!p) return; const a=albums.find(a=>a.id===p.albumId); if(a && a.coverPhotoId===p.id){ a.coverPhotoId=null; saveAlbums(); } p.isDeleted=true; p.deletedAt=Date.now(); savePhotos(); softRender(); }
    function restorePhoto(id){ const p=photos.find(x=>x.id===id); if(!p) return; p.isDeleted=false; p.deletedAt=null; savePhotos(); softRender(); }
    function permanentlyDelete(id){ const idx=photos.findIndex(x=>x.id===id); if(idx<0) return; const p=photos[idx]; const a=albums.find(a=>a.id===p.albumId); if(a && a.coverPhotoId===p.id){ a.coverPhotoId=null; saveAlbums(); } if(confirm('æ­¤å‹•ä½œç„¡æ³•é‚„åŸã€‚ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ')){ photos.splice(idx,1); savePhotos(); softRender(); } }
    function emptyTrash(){ if(!photos.some(p=>p.isDeleted)) return alert('å›æ”¶æ¡¶ç›®å‰æ˜¯ç©ºçš„'); if(!confirm('å°‡æ°¸ä¹…åˆªé™¤å›æ”¶æ¡¶å…§çš„æ‰€æœ‰é …ç›®ï¼ˆåŒæ™‚æ¸…ç†å°é¢æŒ‡å‘ï¼‰ï¼Œç„¡æ³•å¾©åŸã€‚è¦ç¹¼çºŒå—ï¼Ÿ')) return; const idsToDelete=photos.filter(p=>p.isDeleted).map(p=>p.id); photos=photos.filter(p=>!p.isDeleted); albums.forEach(a=>{ if(idsToDelete.includes(a.coverPhotoId)) a.coverPhotoId=null; }); saveAlbums(); savePhotos(); softRender(); }

    // ========== ç·¨è¼¯å½ˆçª— ==========
    function openEditor(id){ const p=photos.find(x=>x.id===id); if(!p) return; if(p.isDeleted) return alert('å›æ”¶æ¡¶ä¸­çš„é …ç›®ä¸èƒ½ç·¨è¼¯ï¼Œè«‹å…ˆé‚„åŸã€‚'); editingId=id; fTitle.value=p.title||fileNameWithoutExt(p.name); fDesc.value=p.desc||''; fTags.value=(p.tags||[]).join(', '); fAlbum.value=p.albumId || getOrCreateDefaultAlbum().id; showModal(true); setTimeout(()=>fTitle.focus(),0) }
    function showModal(show){ modalBackdrop.style.display=show?'flex':'none'; modalBackdrop.setAttribute('aria-hidden',show?'false':'true'); if(!show) editingId=null }
    function saveEditor(){ const p=photos.find(x=>x.id===editingId); if(!p) return; const oldAlbumId=p.albumId; p.title=fTitle.value.trim(); p.desc=fDesc.value.trim(); p.tags=fTags.value.split(',').map(s=>s.trim()).filter(Boolean); p.albumId=fAlbum.value; const oldAlbum=albums.find(a=>a.id===oldAlbumId); if(oldAlbum && oldAlbum.coverPhotoId===p.id && oldAlbumId!==p.albumId){ oldAlbum.coverPhotoId=null; saveAlbums(); } savePhotos(); buildAlbumSelect(); render(); showModal(false) }

    // ========== ä¸‹è¼‰å½ˆçª— ==========
    function openDownloadModal(photoId){ const p=photos.find(x=>x.id===photoId); if(!p) return; if(p.isDeleted) return alert('å›æ”¶æ¡¶ä¸­çš„é …ç›®ç„¡æ³•ä¸‹è¼‰ï¼Œè«‹å…ˆé‚„åŸã€‚'); pendingDownloadPhotoId=photoId; dlFormat.value='image/jpeg'; dlMax.value='2048'; dlQuality.value='0.9'; dlFilenamePreview.textContent = suggestDownloadName(p, dlFormat.value); showDownloadModal(true); }
    function suggestDownloadName(p, mime){ const base=(p.title||fileNameWithoutExt(p.name)).replace(/[\\/:*?"<>|]/g,'_'); const date=fmt(p.lastModified||Date.now()).replace(/-/g,''); const ext = mime==='image/png'? 'png' : (mime==='image/webp'? 'webp' : 'jpg'); return `${base}_${date}.${ext}` }
    function showDownloadModal(show){ downloadModalBackdrop.style.display=show?'flex':'none'; downloadModalBackdrop.setAttribute('aria-hidden',show?'false':'true'); }

    dlFormat.addEventListener('change',()=>{ const p=photos.find(x=>x.id===pendingDownloadPhotoId); if(p) dlFilenamePreview.textContent=suggestDownloadName(p, dlFormat.value); });

    btnDlCancel.addEventListener('click',()=>showDownloadModal(false));
    btnDlStart.addEventListener('click', async ()=>{
      const p=photos.find(x=>x.id===pendingDownloadPhotoId); if(!p) return;
      const maxSel = dlMax.value;
      const mime = dlFormat.value;
      const quality = Number(dlQuality.value)||0.9;
      try{
        const blob = await renderCompressedBlob(p, {maxSide: maxSel==='orig'? null : Number(maxSel), mime: mime, quality: quality});
        const name = suggestDownloadName(p, mime);
        triggerDownload(blob, name);
        showDownloadModal(false);
      }catch(err){ console.error(err); alert('ç”¢ç”Ÿä¸‹è¼‰æª”æ¡ˆå¤±æ•—ï¼š'+err.message); }
    });

    function triggerDownload(blob, filename){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0); }

    // ç”¢ç”Ÿå£“ç¸® Blobï¼ˆCanvas ç¸®æ”¾ + å¯é¸æ ¼å¼/å“è³ªï¼‰
    async function renderCompressedBlob(photo, opts){
      const {maxSide, mime, quality} = opts;
      const img = await dataUrlToImage(photo.dataUrl);
      let {w, h} = {w: img.naturalWidth||img.width, h: img.naturalHeight||img.height};
      if(maxSide && (w>maxSide || h>maxSide)){
        const ratio = w>h ? maxSide/w : maxSide/h; w = Math.round(w*ratio); h = Math.round(h*ratio);
      }
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1,w); canvas.height = Math.max(1,h);
      const ctx = canvas.getContext('2d');
      // èƒŒæ™¯å¡«ç™½ï¼ˆé¿å… JPEG é€æ˜ -> é»‘åº•ï¼‰
      if(mime==='image/jpeg'){
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,canvas.width,canvas.height);
      } else {
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      const q = (mime==='image/jpeg' || mime==='image/webp')? Math.min(0.98, Math.max(0.5, quality||0.9)) : undefined;
      const blob = await new Promise((resolve,reject)=> canvas.toBlob(b=> b? resolve(b):reject(new Error('toBlob å¤±æ•—')) , mime, q));
      return blob;
    }
    function dataUrlToImage(dataUrl){ return new Promise((resolve,reject)=>{ const img=new Image(); img.onload=()=>resolve(img); img.onerror=()=>reject(new Error('è®€å–åœ–ç‰‡å¤±æ•—')); img.src=dataUrl; }); }

    // ========== ç›¸ç°¿ç®¡ç†é¢æ¿ ==========
    function showAlbumModal(show){ albumModalBackdrop.style.display=show?'flex':'none'; albumModalBackdrop.setAttribute('aria-hidden',show?'false':'true'); if(show){ newAlbumName.value=''; newAlbumName.focus(); renderAlbumManagerList(); } }
    function renderAlbumManagerList(){ albumList.innerHTML=''; const list=albums.slice().sort((a,b)=>a.orderIndex-b.orderIndex); list.forEach(a=>{ const row=document.createElement('div'); row.className='album-row'; const left=document.createElement('div'); left.className='left'; const cover=document.createElement('div'); cover.className='album-cover'; const p=coverOfAlbum(a.id); const img=document.createElement('img'); img.src=p? p.dataUrl : 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 150"><rect width="100%" height="100%" fill="${getComputedStyle(document.documentElement).getPropertyValue('--thumb-bg').trim()||'#eef2f7'}"/></svg>`); cover.appendChild(img); const name=document.createElement('div'); name.className='album-name'; name.textContent=a.name; const count=document.createElement('div'); count.className='time'; count.textContent=`${photos.filter(p=>!p.isDeleted && p.albumId===a.id).length} å¼µ`; left.appendChild(cover); left.appendChild(name); left.appendChild(count); const ops=document.createElement('div'); ops.className='actions'; const renameBtn=document.createElement('button'); renameBtn.className='btn small'; renameBtn.type='button'; renameBtn.textContent='é‡æ–°å‘½å'; renameBtn.addEventListener('click',()=>{ const nn=prompt('æ–°çš„ç›¸ç°¿åç¨±ï¼š', a.name); if(nn!=null) renameAlbum(a.id, nn); renderAlbumManagerList(); }); const delBtn=document.createElement('button'); delBtn.className='btn small danger'; delBtn.type='button'; delBtn.textContent='åˆªé™¤'; delBtn.addEventListener('click',()=>{ deleteAlbum(a.id); renderAlbumManagerList(); }); ops.appendChild(renameBtn); ops.appendChild(delBtn); row.appendChild(left); row.appendChild(ops); albumList.appendChild(row); }); if(list.length===0){ const hint=document.createElement('div'); hint.className='time'; hint.textContent='ç›®å‰æ²’æœ‰ç›¸ç°¿ï¼Œè«‹æ–°å¢ä¸€å€‹ã€‚'; albumList.appendChild(hint); } }

    // ========== äº‹ä»¶ï¼šä¸Šå‚³ ==========
    fileInput.addEventListener('change', async (e)=>{ const files=Array.from(e.target.files||[]); if(!files.length) return; const images=files.filter(f=>f.type&&f.type.startsWith('image/')); const nonImages=files.filter(f=>!f.type||!f.type.startsWith('image/')); if(nonImages.length) alert('å·²ç•¥ééåœ–ç‰‡æª”æ¡ˆï¼š\n'+nonImages.map(f=>'â€¢ '+f.name).join('\n')); const targetAlbumId = currentAlbumId==='all' ? getOrCreateDefaultAlbum().id : currentAlbumId; for(const file of images){ try{ const dataUrl=await readFileAsDataURL(file); const maxOrder=photos.reduce((m,p)=>Math.max(m, typeof p.orderIndex==='number'?p.orderIndex:-1), -1); photos.push({id:uid(),dataUrl:String(dataUrl),name:file.name,lastModified:file.lastModified,size:file.size,title:fileNameWithoutExt(file.name),desc:'',tags:[],albumId:targetAlbumId,isDeleted:false,deletedAt:null, orderIndex:maxOrder+10}); }catch(err){ console.warn('è½‰æ› DataURL å¤±æ•—ï¼š',err) } } savePhotos(); e.target.value=''; softRender(); });

    // ========== äº‹ä»¶ï¼šæ¸…ç©ºå…¨éƒ¨ ==========
    clearBtn.addEventListener('click',()=>{ if(!photos.length && !albums.length) return; if(confirm('å°‡åˆªé™¤æ‰€æœ‰ç›¸ç‰‡ã€å›æ”¶æ¡¶å…§å®¹ã€å°é¢è¨­å®šèˆ‡ç›¸ç°¿ï¼ˆä¸å¯å¾©åŸï¼‰ã€‚ç¢ºå®šï¼Ÿ')){ photos=[]; albums=[]; savePhotos(); saveAlbums(); buildAlbumSelect(); softRender(); } })

    // ========== ç¯©é¸/æ’åº/åˆ†é /è¦–åœ– ==========
    searchInput.addEventListener('input',e=>{ query=e.target.value||''; visibleCount=pageSize; softRender() })
    albumSelect.addEventListener('change',e=>{ currentAlbumId=e.target.value; setTab('library'); visibleCount=pageSize; softRender() })
    sortBySelect.addEventListener('change',e=>{ sortBy=e.target.value; visibleCount=pageSize; softRender() })
    sortOrderSelect.addEventListener('change',e=>{ sortOrder=e.target.value; visibleCount=pageSize; softRender() })
    pageSizeSelect.addEventListener('change',e=>{ pageSize=Number(e.target.value)||12; visibleCount=pageSize; softRender() })
    loadMoreBtn.addEventListener('click',()=>{ const total=getFilteredSorted().length; visibleCount=Math.min(visibleCount+pageSize, total); softRender() })

    function setTab(which){ showAlbumsView=(which==='albums'); showTrash=(which==='trash'); tabLibrary.classList.toggle('active', which==='library'); tabAlbums.classList.toggle('active', which==='albums'); tabTrash.classList.toggle('active', which==='trash'); visibleCount=pageSize; softRender(); }
    tabLibrary.addEventListener('click',()=>setTab('library'));
    tabAlbums.addEventListener('click',()=>setTab('albums'));
    tabTrash.addEventListener('click',()=>setTab('trash'));

    // ä¸»é¡Œäº‹ä»¶
    themeSelect.addEventListener('change',()=>{ const pref=themeSelect.value; saveThemePref(pref); applyTheme(pref); render(); });

    // ç›¸ç°¿ç®¡ç†äº‹ä»¶
    manageAlbumsBtn.addEventListener('click',()=>showAlbumModal(true));
    btnAlbumClose.addEventListener('click',()=>showAlbumModal(false));
    createAlbumBtn.addEventListener('click',()=>{ const id=createAlbum(newAlbumName.value); if(id){ newAlbumName.value=''; renderAlbumManagerList(); } });
    albumModalBackdrop.addEventListener('click',ev=>{ if(ev.target===albumModalBackdrop) showAlbumModal(false); });

    // ç…§ç‰‡ç·¨è¼¯äº‹ä»¶
    btnCancel.addEventListener('click',()=>showModal(false));
    btnSave.addEventListener('click',saveEditor);
    document.addEventListener('keydown',ev=>{ if(modalBackdrop.style.display==='flex' && ev.key==='Escape') showModal(false); if(albumModalBackdrop.style.display==='flex' && ev.key==='Escape') showAlbumModal(false); if(downloadModalBackdrop.style.display==='flex' && ev.key==='Escape') showDownloadModal(false); })
    modalBackdrop.addEventListener('click',ev=>{ if(ev.target===modalBackdrop) showModal(false) })
    downloadModalBackdrop.addEventListener('click',ev=>{ if(ev.target===downloadModalBackdrop) showDownloadModal(false) })

    // ========== Self Tests ==========
    function runSelfTests(){
      console.groupCollapsed('ğŸ” Self-tests for Day 22');
      try{
        // æ¸¬è©¦ä¸€ï¼šJPEG å£“ç¸®ï¼ˆç¸®å°ï¼‰
        const testCanvas=document.createElement('canvas'); testCanvas.width=100; testCanvas.height=50; const tctx=testCanvas.getContext('2d'); tctx.fillStyle='#f00'; tctx.fillRect(0,0,100,50); const dataUrl=testCanvas.toDataURL('image/png');
        const fakePhoto={id:'t', dataUrl: dataUrl, name:'t.png', lastModified:Date.now(), size:0, title:'T', albumId:'', isDeleted:false};
        renderCompressedBlob(fakePhoto,{maxSide:50, mime:'image/jpeg', quality:0.9}).then(b=>{ console.assert(b instanceof Blob,'toBlob æˆåŠŸ (JPEG ç¸®å°)'); }).catch(e=>console.error(e));

        // æ¸¬è©¦äºŒï¼šPNG åŸå°ºå¯¸ï¼ˆä¿ç•™é€æ˜ï¼‰
        const c2=document.createElement('canvas'); c2.width=4; c2.height=4; const g2=c2.getContext('2d'); g2.clearRect(0,0,4,4); g2.fillStyle='rgba(0,255,0,0.5)'; g2.fillRect(0,0,4,4); const dataUrl2=c2.toDataURL('image/png');
        const fakePhoto2={id:'t2', dataUrl: dataUrl2, name:'t2.png', lastModified:Date.now(), size:0, title:'T2', albumId:'', isDeleted:false};
        renderCompressedBlob(fakePhoto2,{maxSide:null, mime:'image/png', quality:0.9}).then(b=>{ console.assert(b instanceof Blob,'toBlob æˆåŠŸ (PNG åŸå°ºå¯¸)'); }).catch(e=>console.warn('PNG æ¸¬è©¦ï¼š',e));

        // æ¸¬è©¦ä¸‰ï¼šæ¥µå°å°ºå¯¸ JPEGï¼ˆ1pxï¼‰
        renderCompressedBlob(fakePhoto2,{maxSide:1, mime:'image/jpeg', quality:0.6}).then(b=>{ console.assert(b instanceof Blob,'toBlob æˆåŠŸ (JPEG 1px)'); }).catch(e=>console.error(e));

        // æª”åæ¸¬è©¦
        const namePreview=suggestDownloadName(fakePhoto2,'image/png');
        console.assert(/\.png$/.test(namePreview), 'å‰¯æª”åæ‡‰ç‚º .png');
        console.assert(!/[\\/:*?"<>|]/.test(namePreview), 'ä¸æ‡‰å«æœ‰éæ³•æª”åå­—å…ƒ');

        console.log('âœ… è‡ªæˆ‘æ¸¬è©¦å·²è§¸ç™¼ï¼ˆè«‹çœ‹ä¸Šæ–¹ assertï¼‰');
      }catch(err){ console.error('âŒ è‡ªæˆ‘æ¸¬è©¦å¤±æ•—',err); }
      console.groupEnd();
    }

    // ========== ç›¸å®¹æ€§é·ç§» ==========
    function getOrCreateDefaultAlbum(){ let a=albums.find(x=>x.name===DEFAULT_ALBUM_NAME); if(!a){ const id=createAlbum(DEFAULT_ALBUM_NAME); a=albums.find(x=>x.id===id); } return a; }

    // ========== åˆå§‹åŒ– ==========
    (function init(){
      // ä¸»é¡Œ
      const pref = getSavedTheme(); themeSelect.value=pref; applyTheme(pref);

      photos = loadPhotos();
      let patched=false; photos.forEach(p=>{ if(!('isDeleted' in p)) { p.isDeleted=false; patched=true } if(!('deletedAt' in p)) { p.deletedAt=null; patched=true } if(!('orderIndex' in p)) { p.orderIndex=0; patched=true } if(!('albumId' in p)) { p.albumId = getOrCreateDefaultAlbum().id; patched=true } }); if(patched) savePhotos();

      albums = loadAlbums(); if(albums.length===0){ // åˆæ¬¡ï¼šå»ºç«‹æœªåˆ†é¡
        createAlbum(DEFAULT_ALBUM_NAME);
      }

      buildAlbumSelect();
      sortBy = sortBySelect.value; sortOrder = sortOrderSelect.value; pageSize=Number(pageSizeSelect.value)||12; visibleCount=pageSize; showTrash=false; showAlbumsView=false;
      softRender();
      runSelfTests();
      console.log('âœ… Day 22ï¼šåœ–ç‰‡ä¸‹è¼‰å•Ÿç”¨ã€‚ç…§ç‰‡æ•¸ï¼š', photos.length);
    })();
  </script>
</body>
</html>

