
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Day 26ï½œç·šä¸Šç›¸ç°¿ - å¤šä½¿ç”¨è€…è³‡æ–™éš”é›¢ï¼ˆæ•´åˆ Day16ï½24ï¼‰</title>
  <!--
    ä»Šæ—¥ç›®æ¨™ï¼ˆå–®ä¸€ HTML æª”ï¼‰ï¼š
    1) ä»¥ç™»å…¥èº«åˆ†åˆ†éš”å‘½åç©ºé–“ï¼ˆå¤šä½¿ç”¨è€…è³‡æ–™éš”é›¢ï¼‰ã€‚
    2) æ•´åˆ Day 16 å›æ”¶æ¡¶ã€Day 24 åˆ†äº«é€£çµï¼ˆå”¯è®€è¨ªå®¢æ¨¡å¼ï¼‰ã€‚
    3) ç™»å…¥å¤±æ•—é–å®š/ç¯€æµï¼š5 æ¬¡éŒ¯èª¤ â†’ é– 5 åˆ†é˜ï¼›æ¯æ¬¡éŒ¯èª¤é€æ­¥å»¶æ™‚ 0.5s * æ¬¡æ•¸ã€‚
    4) è‡ªæˆ‘æ¸¬è©¦ï¼šä¸ä¾è³´ localStorage çš„æƒ…å¢ƒä¹Ÿèƒ½é€šéï¼ˆæä¾› memory fallback + ç´” JS SHA-256ï¼‰ã€‚

    ä½¿ç”¨æ–¹å¼ï¼š
    - å­˜æˆ index.html ç›´æ¥é–‹å•Ÿã€‚
    - æœªç™»å…¥æ™‚å…ˆå‡ºç¾ç™»å…¥/è¨»å†Šé¢æ¿ï¼›ç™»å…¥å¾Œå¯ä¸Šå‚³/åˆªé™¤(å›æ”¶æ¡¶)/åˆ†äº«ã€‚
    - ä»»ä½•äººé€ è¨ª ?share=<token> é€²å…¥è¨ªå®¢å”¯è®€æ¨¡å¼ï¼ˆä¸éœ€ç™»å…¥ï¼‰ã€‚

    æ³¨æ„ï¼šæ•™å­¸ç”¨å‰ç«¯ç¤ºç¯„ï¼Œè«‹å‹¿ç”¨æ–¼æ­£å¼ç’°å¢ƒã€‚
  -->
  <style>
    :root{ --bg:#ffffff; --elev:#f9fafb; --text:#1f2328; --muted:#6b7280; --primary:#ff8c42; --danger:#e11d48; --border:#e5e7eb; --radius:14px; --shadow:0 8px 24px rgba(17,24,39,.12) }
    @media(prefers-color-scheme:dark){ :root{ --bg:#0b1220; --elev:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --primary:#ff954f; --danger:#fb7185; --border:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.35) } }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans CJK TC","Microsoft JhengHei",Arial,sans-serif;line-height:1.65}
    .container{max-width:1100px;margin:0 auto;padding:24px;box-sizing:border-box}
    header{border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fff,#fff7f1)}
    @media(prefers-color-scheme:dark){header{background:linear-gradient(180deg,#0b1220,#0b1220)}}
    .brand{display:flex;align-items:center;gap:12px}
    .brand__logo{width:44px;height:44px;border-radius:10px;background:var(--primary);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .brand__title{margin:0;font-size:20px}
    .brand__subtitle{margin:4px 0 0;color:var(--muted);font-size:14px}

    .auth{display:grid;gap:12px;max-width:520px;margin:18px auto;padding:18px;background:var(--elev);border:1px solid var(--border);border-radius:16px}
    .auth h2{margin:4px 0 8px 0}
    .field{display:grid;gap:6px}
    .field label{font-size:13px;color:var(--muted)}
    .field input[type=text], .field input[type=email], .field input[type=password]{padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text)}
    .auth .actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .btn{cursor:pointer;border-radius:10px}
    .btn.primary{background:var(--primary);color:#fff;border:none;padding:10px 14px}
    .btn.secondary{background:#fff0;border:1px solid var(--border);padding:10px 14px}
    .btn.danger{background:var(--danger);color:#fff;border:none;padding:10px 14px}
    .muted{color:var(--muted)}
    .error{color:#b91c1c;font-size:13px}
    .ok{color:#15803d;font-size:13px}

    .toolbar{display:grid;gap:12px;margin-top:16px;align-items:center;grid-template-columns:1fr 220px auto auto}
    @media(max-width:900px){.toolbar{grid-template-columns:1fr 1fr}}
    @media(max-width:640px){.toolbar{grid-template-columns:1fr}}
    .toolbar input[type=text],.toolbar button,.toolbar input[type=file]{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text)}
    .toolbar .btn.logout{justify-self:end}

    main{padding:24px 0}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}

    .card{background:var(--elev);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;background:#eef2f7;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:12px;display:grid;gap:8px}
    .title-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{font-size:12px;color:var(--muted)}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:#555;background:#fff0}

    .switcher{display:flex;gap:8px}
    .switcher .tabbtn{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .switcher .tabbtn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;padding:0 6px;border-radius:999px;background:var(--border);color:var(--muted);font-size:12px;margin-left:6px}

    .viewer{display:grid;gap:16px;grid-template-columns: 1.2fr 1fr}
    @media(max-width:900px){.viewer{grid-template-columns:1fr}}
    .viewer .big{background:var(--elev);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .viewer .big img{width:100%;height:auto;display:block}
    .viewer .info{background:var(--elev);border:1px solid var(--border);border-radius:16px;padding:16px;display:grid;gap:10px}
    .pill{display:inline-flex;align-items:center;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal{width:560px;max-width:720px;background:var(--bg);border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
    .modal__header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800}
    .modal__body{padding:16px;display:grid;gap:12px}
    .modal__footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
    .field input[type=text],.field textarea{width:100%;box-sizing:border-box;padding:12px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text)}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">PA</div>
        <div>
          <h1 class="brand__title">ç·šä¸Šç›¸ç°¿ï¼ˆDay 26ï¼‰</h1>
          <p class="brand__subtitle">å¤šä½¿ç”¨è€…è³‡æ–™éš”é›¢ï¼‹å›æ”¶æ¡¶ï¼‹åˆ†äº«é€£çµï¼›å«ç™»å…¥å¤±æ•—é–å®š</p>
        </div>
      </div>

      <div id="authedToolbar" class="toolbar" style="display:none" role="region" aria-label="å·¥å…·åˆ—">
        <input id="searchInput" type="text" placeholder="æœå°‹é—œéµå­—ï¼ˆæ¨™é¡Œï¼æ•˜è¿°ï¼æ¨™ç±¤ï¼æª”åï¼‰" aria-label="æœå°‹">
        <input id="fileInput" type="file" accept="image/*" multiple aria-label="ä¸Šå‚³åœ–ç‰‡">
        <div class="switcher">
          <button id="tabLibrary" class="tabbtn active" type="button">ç›¸ç°¿</button>
          <button id="tabTrash" class="tabbtn" type="button">å›æ”¶æ¡¶ <span id="trashBadge" class="badge">0</span></button>
        </div>
        <button id="logoutBtn" class="btn secondary logout" type="button">ç™»å‡º</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- æœªç™»å…¥ï¼šç™»å…¥/è¨»å†Šå¡ç‰‡ -->
      <section id="authSection" class="auth" aria-live="polite">
        <h2>ç™»å…¥ä½ çš„ç›¸ç°¿</h2>
        <div class="field"><label for="email">Email</label><input id="email" type="email" placeholder="you@example.com" autocomplete="username" /></div>
        <div class="field"><label for="password">å¯†ç¢¼</label><input id="password" type="password" placeholder="è‡³å°‘ 8 ç¢¼" autocomplete="current-password" /></div>
        <div id="registerExtras" class="field" style="display:none"><label for="password2">ç¢ºèªå¯†ç¢¼</label><input id="password2" type="password" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼" autocomplete="new-password" /></div>
        <div id="authMsg" class="muted"></div>
        <div class="actions"><button id="toggleModeBtn" class="btn secondary" type="button">åˆ‡æ›åˆ°è¨»å†Š</button><button id="submitBtn" class="btn primary" type="button">ç™»å…¥</button></div>
        <div id="lockHint" class="muted" style="display:none"></div>
      </section>

      <!-- å·²ç™»å…¥ï¼šç•«å»Š -->
      <section id="appSection" style="display:none">
        <div class="statusbar" style="display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px;margin-bottom:10px">
          <div>ç›®å‰ä½¿ç”¨è€…ï¼š<span id="currentUser" class="ok">â€”</span></div>
          <div>ç›¸ç‰‡ç¸½æ•¸ï¼š<span id="countAll">0</span>ï½œé¡¯ç¤ºï¼š<span id="countShown">0</span>ï½œç¬¦åˆï¼š<span id="countFiltered">0</span></div>
          <div id="trashHint" style="display:none">å›æ”¶æ¡¶çš„ç›¸ç‰‡æœƒåœ¨ <strong>7</strong> å¤©å¾Œè‡ªå‹•æ¸…é™¤ã€‚</div>
        </div>
        <div id="grid" class="grid" aria-live="polite"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
          <button id="emptyTrashBtn" class="btn danger" style="display:none" type="button">æ¸…ç©ºå›æ”¶æ¡¶</button>
          <button id="clearAllBtn" class="btn secondary" type="button">æ¸…ç©ºæ­¤å¸³è™Ÿæ‰€æœ‰è³‡æ–™</button>
        </div>
      </section>

      <!-- è¨ªå®¢æ¨¡å¼ï¼ˆ?share=tokenï¼‰ -->
      <section id="visitorView" style="display:none">
        <div class="pill" style="margin-bottom:12px">è¨ªå®¢æ¨¡å¼ï¼ˆå”¯è®€ï¼‰</div>
        <div class="viewer">
          <div class="big"><img id="vImg" alt="shared" /></div>
          <div class="info">
            <h2 id="vTitle">â€”</h2>
            <div class="muted" id="vMeta">â€”</div>
            <div id="vDesc">â€”</div>
            <div id="vTags" class="tags"></div>
            <div class="muted">ä¾†æºï¼šä½œè€…åˆ†äº«çš„éœæ…‹å¿«ç…§ï¼›ç„¡éœ€ç™»å…¥å³å¯æª¢è¦–ã€‚</div>
            <div><button id="btnVisitHome" class="btn secondary" type="button">å›åˆ°ä¸»é </button></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ç·¨è¼¯ Modalï¼ˆç°¡ç‰ˆï¼‰ -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div class="modal__header" id="modalTitle">ç·¨è¼¯åœ–ç‰‡è³‡è¨Š</div>
      <div class="modal__body">
        <div class="field"><label class="muted" for="fTitle">æ¨™é¡Œ</label><input id="fTitle" type="text" placeholder="ä¾‹ï¼šå°åŒ—å°æ—…è¡Œ"></div>
        <div class="field"><label class="muted" for="fDesc">æ•˜è¿°</label><textarea id="fDesc" placeholder="ç°¡çŸ­æè¿°...ï¼ˆéå¿…å¡«ï¼‰" style="min-height:90px"></textarea></div>
        <div class="field"><label class="muted" for="fTags">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label><input id="fTags" type="text" placeholder="æ—…éŠ, æœ‹å‹, æ™šä¸Š"></div>
      </div>
      <div class="modal__footer"><button id="btnCancel" class="btn secondary" type="button">å–æ¶ˆ</button><button id="btnSave" class="btn primary" type="button">å„²å­˜</button></div>
    </div>
  </div>

  <script>
  // ============================
  // Day 26ï¼šå¤šä½¿ç”¨è€…è³‡æ–™éš”é›¢ï¼ˆæ•´åˆ Day16/24ï¼‰ + ç™»å…¥é–å®š
  // ============================

  // ---- Storage fallbackï¼ˆé¿å… sandbox ç„¡æ³•ç”¨ localStorageï¼‰
  const MEM = new Map();
  const HAS_LS = (function(){ try{ const k='__t__'+Math.random(); localStorage.setItem(k,'1'); localStorage.removeItem(k); return true; }catch(e){ return false; } })();
  function sget(k){ if(HAS_LS){ try{ return localStorage.getItem(k);}catch(e){ return MEM.get(k)||null;} } return MEM.get(k)||null; }
  function sset(k,v){ if(HAS_LS){ try{ localStorage.setItem(k,v); return true;}catch(e){ MEM.set(k,v); return true;} } MEM.set(k,v); return true; }

  // ---- Keys & helpers
  const LS_USERS = 'pa_users_v2';
  const LS_SESSION = 'pa_session_user_v2';
  const LS_SHARES_NS = 'pa_shares_v2'; // å…¨åŸŸåˆ†äº«å¿«ç…§è¡¨ï¼Œtokenâ†’å¿«ç…§ï¼ˆå« email/ownerï¼‰
  function userPhotosKey(email){ return 'pa_u_'+ encodeURIComponent(String(email).toLowerCase()) +'_photos_v2'; }
  function normalizeEmail(s){ return String(s||'').trim().toLowerCase(); }
  function now(){ return Date.now(); }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function toHex(bytes){ return Array.prototype.map.call(bytes, b=>('0'+b.toString(16)).slice(-2)).join(''); }
  async function sha256HexWebCrypto(str){ const enc=new TextEncoder(); const data=enc.encode(str); const buf=await crypto.subtle.digest('SHA-256', data); return toHex(new Uint8Array(buf)); }
  function sha256HexPortable(str){ function r(n,x){return (x>>>n)|(x<<(32-n));} function ch(x,y,z){return (x&y)^(~x&z);} function maj(x,y,z){return (x&y)^(x&z)^(y&z);} function S0(x){return r(2,x)^r(13,x)^r(22,x);} function S1(x){return r(6,x)^r(11,x)^r(25,x);} function s0(x){return r(7,x)^r(18,x)^(x>>>3);} function s1(x){return r(17,x)^r(19,x)^(x>>>10);} function utf8(s){var a=[];for(var i=0;i<s.length;i++){var c=s.charCodeAt(i);if(c<128)a.push(c);else if(c<2048)a.push(192|(c>>>6),128|(c&63));else if((c&0xFC00)===0xD800&&i+1<s.length&&(s.charCodeAt(i+1)&0xFC00)===0xDC00){var code=0x10000+((c&0x3FF)<<10)+(s.charCodeAt(++i)&0x3FF);a.push(240|(code>>>18),128|((code>>>12)&63),128|((code>>>6)&63),128|(code&63));}else a.push(224|(c>>>12),128|((c>>>6)&63),128|(c&63));}return a;}
    var K=[0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2];
    var b=utf8(str),l=b.length;b.push(0x80);while(b.length%64!==56)b.push(0);var hi=Math.floor(l/0x20000000),lo=(l<<3)>>>0;for(var i=0;i<4;i++)b.push((hi>>>((3-i)*8))&255);for(var i2=0;i2<4;i2++)b.push((lo>>>((3-i2)*8))&255);var H=[0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19],w=new Array(64);
    for(var j=0;j<b.length;j+=64){for(var t=0;t<16;t++){var i4=j+t*4;w[t]=((b[i4]<<24)|(b[i4+1]<<16)|(b[i4+2]<<8)|(b[i4+3]))>>>0;}for(var t2=16;t2<64;t2++)w[t2]=(s1(w[t2-2])+w[t2-7]+s0(w[t2-15])+w[t2-16])>>>0;var a=H[0],c=H[1],d=H[2],e=H[3],f=H[4],g=H[5],h=H[6],m=H[7];for(var t3=0;t3<64;t3++){var T1=(m+S1(f)+ch(f,g,h)+K[t3]+w[t3])>>>0;var T2=(S0(a)+maj(a,c,d))>>>0;m=h;h=g;g=f;f=(e+T1)>>>0;e=d;d=c;c=a;a=(T1+T2)>>>0;}H[0]=(H[0]+a)>>>0;H[1]=(H[1]+c)>>>0;H[2]=(H[2]+d)>>>0;H[3]=(H[3]+e)>>>0;H[4]=(H[4]+f)>>>0;H[5]=(H[5]+g)>>>0;H[6]=(H[6]+h)>>>0;H[7]=(H[7]+m)>>>0;}var out='';for(var k=0;k<8;k++)out+=('00000000'+H[k].toString(16)).slice(-8);return out; }
  async function sha256Hex(s){ try{ if(crypto && crypto.subtle) return await sha256HexWebCrypto(s); }catch(e){} return sha256HexPortable(s); }
  async function hashPassword(password, saltHex){ return sha256Hex(saltHex+':'+password); }

  // ---- Users & session with lockout
  function loadUsers(){ const raw=sget(LS_USERS); if(!raw) return []; try{ const arr=JSON.parse(raw); return Array.isArray(arr)?arr:[]; }catch(e){ return []; } }
  function saveUsers(list){ sset(LS_USERS, JSON.stringify(list)); }
  function currentUserEmail(){ return normalizeEmail(sget(LS_SESSION)||''); }
  function setSession(email){ sset(LS_SESSION, normalizeEmail(email||'')); }
  function getLockMap(){ const raw=sget('pa_login_locks_v1'); if(!raw) return {}; try{ const obj=JSON.parse(raw); return obj&&typeof obj==='object'? obj:{} }catch(e){ return {}; } }
  function setLockMap(map){ sset('pa_login_locks_v1', JSON.stringify(map||{})); }

  async function register(email, password){
    const e=normalizeEmail(email); const users=loadUsers();
    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(e)) throw new Error('Email æ ¼å¼ä¸æ­£ç¢º');
    if((password||'').length<8) throw new Error('å¯†ç¢¼éœ€è‡³å°‘ 8 ç¢¼');
    if(users.some(u=>u.email===e)) throw new Error('æ­¤ Email å·²è¢«è¨»å†Š');
    let salt; try{ const a=new Uint8Array(16); crypto.getRandomValues(a); salt=toHex(a);}catch(_){ salt=toHex(Uint8Array.from({length:16},()=>Math.random()*256|0)); }
    const hash=await hashPassword(password, salt);
    const user={email:e, saltHex:salt, hashHex:hash, createdAt:now()}; users.push(user); saveUsers(users);
    sset(userPhotosKey(e), JSON.stringify([])); // å»ºç«‹ç©ºé–“
    return user;
  }
  function checkLocked(email){ const map=getLockMap(); const rec=map[normalizeEmail(email)]; if(!rec) return {locked:false}; const until=rec.lockUntil||0; const left=until-now(); return {locked: left>0, leftMs: Math.max(0,left), count: rec.failCount||0}; }
  function recordFail(email){ const map=getLockMap(); const e=normalizeEmail(email); const rec=map[e]||{failCount:0, lockUntil:0}; rec.failCount = (rec.failCount||0)+1; const baseDelay=500; rec.delayMs = baseDelay*rec.failCount; if(rec.failCount>=5){ rec.lockUntil = now() + 5*60*1000; } map[e]=rec; setLockMap(map); return rec; }
  function recordSuccess(email){ const map=getLockMap(); delete map[normalizeEmail(email)]; setLockMap(map); }
  async function login(email, password){
    const e=normalizeEmail(email); const lk=checkLocked(e); if(lk.locked) throw new Error('å¸³è™Ÿæš«æ™‚é–å®šï¼Œè«‹ç¨å¾Œå†è©¦'); if(lk.count>0){ await new Promise(r=>setTimeout(r, (getLockMap()[e]?.delayMs)||0)); }
    const users=loadUsers(); const u=users.find(x=>x.email===e); if(!u){ recordFail(e); throw new Error('æŸ¥ç„¡æ­¤å¸³è™Ÿ'); }
    const h=await hashPassword(password, u.saltHex); if(h!==u.hashHex){ const rec=recordFail(e); throw new Error(rec.failCount>=5? 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œå·²æš«æ™‚é–å®š 5 åˆ†é˜':'å¯†ç¢¼ä¸æ­£ç¢º'); }
    recordSuccess(e); setSession(e); return u;
  }
  function logout(){ setSession(''); }

  // ---- Photos per user
  function loadPhotos(email){ const raw=sget(userPhotosKey(email)); if(!raw) return []; try{ const arr=JSON.parse(raw); return Array.isArray(arr)?arr:[]; }catch(e){ return []; } }
  function savePhotos(email, list){ sset(userPhotosKey(email), JSON.stringify(list||[])); }

  // ---- Sharesï¼ˆå…¨åŸŸè¡¨ï¼›tokenâ†’{owner,email,createdAt,snapshot}ï¼‰
  function loadShares(){ const raw=sget(LS_SHARES_NS); if(!raw) return {}; try{ const o=JSON.parse(raw); return o&&typeof o==='object'? o: {}; }catch(e){ return {}; } }
  function saveShares(map){ sset(LS_SHARES_NS, JSON.stringify(map||{})); }

  // ---- UI refs
  const authSection=document.getElementById('authSection');
  const appSection=document.getElementById('appSection');
  const visitorView=document.getElementById('visitorView');
  const authedToolbar=document.getElementById('authedToolbar');
  const currentUserSpan=document.getElementById('currentUser');
  const emailInput=document.getElementById('email');
  const passwordInput=document.getElementById('password');
  const password2Input=document.getElementById('password2');
  const registerExtras=document.getElementById('registerExtras');
  const authMsg=document.getElementById('authMsg');
  const lockHint=document.getElementById('lockHint');
  const toggleModeBtn=document.getElementById('toggleModeBtn');
  const submitBtn=document.getElementById('submitBtn');
  const logoutBtn=document.getElementById('logoutBtn');
  const searchInput=document.getElementById('searchInput');
  const fileInput=document.getElementById('fileInput');
  const grid=document.getElementById('grid');
  const countAll=document.getElementById('countAll');
  const countFiltered=document.getElementById('countFiltered');
  const countShown=document.getElementById('countShown');
  const clearAllBtn=document.getElementById('clearAllBtn');
  const tabLibrary=document.getElementById('tabLibrary');
  const tabTrash=document.getElementById('tabTrash');
  const trashBadge=document.getElementById('trashBadge');
  const emptyTrashBtn=document.getElementById('emptyTrashBtn');
  const trashHint=document.getElementById('trashHint');

  // Visitor refs
  const vImg=document.getElementById('vImg');
  const vTitle=document.getElementById('vTitle');
  const vMeta=document.getElementById('vMeta');
  const vDesc=document.getElementById('vDesc');
  const vTags=document.getElementById('vTags');
  const btnVisitHome=document.getElementById('btnVisitHome');

  // Modal refs
  const modalBackdrop=document.getElementById('modalBackdrop');
  const fTitle=document.getElementById('fTitle');
  const fDesc=document.getElementById('fDesc');
  const fTags=document.getElementById('fTags');
  const btnCancel=document.getElementById('btnCancel');
  const btnSave=document.getElementById('btnSave');

  // ---- App state
  let mode='login'; // 'login'|'register'
  let photos=[];    // ç•¶å‰ç™»å…¥è€…ç…§ç‰‡
  let query='';
  let showTrash=false;
  let editingId=null;

  function prettySize(bytes){ const u=['B','KB','MB','GB']; let i=0,n=bytes; while(n>=1024&&i<u.length-1){ n/=1024;i++; } return n.toFixed(1)+' '+u[i]; }
  function fileNameWithoutExt(name){ if(typeof name!=='string') return 'image'; const i=name.lastIndexOf('.'); return i>0? name.slice(0,i): (name||'image'); }
  function fmtFull(ts){ const d=new Date(ts||Date.now()); function P(n){return String(n).padStart(2,'0')} return d.getFullYear()+'-'+P(d.getMonth()+1)+'-'+P(d.getDate())+' '+P(d.getHours())+':'+P(d.getMinutes()); }
  function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onerror=()=>rej(new Error('è®€æª”å¤±æ•—')); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

  // ---- Filtering & rendering (with trash view)
  function baseFilter(list){ const q=(query||'').trim().toLowerCase(); const tokens=q? q.split(/\s+/).filter(Boolean):[]; return list.filter(p=>{ const inTrash=!!p.isDeleted; if(showTrash? !inTrash : inTrash) return false; if(!tokens.length) return true; const hay=[p.title||'', p.desc||'', (p.tags||[]).join(' '), p.name||''].join(' ').toLowerCase(); return tokens.every(tok=>hay.includes(tok)); }); }
  function render(){ const data=baseFilter(photos); const frag=document.createDocumentFragment(); if(data.length===0){ const empty=document.createElement('div'); empty.className='card'; empty.style.padding='20px'; empty.textContent= photos.length? (showTrash? 'å›æ”¶æ¡¶æ˜¯ç©ºçš„æˆ–ç„¡ç¬¦åˆæ¢ä»¶':'æ²’æœ‰ç¬¦åˆçš„çµæœ'): 'å°šç„¡ç…§ç‰‡ï¼Œè«‹å…ˆä¸Šå‚³ã€‚'; frag.appendChild(empty); } else { data.forEach(p=>{ const card=document.createElement('article'); card.className='card'; card.dataset.id=p.id; const th=document.createElement('div'); th.className='thumb'; const img=document.createElement('img'); img.src=p.dataUrl; img.alt=p.title||p.name; th.appendChild(img); const meta=document.createElement('div'); meta.className='meta'; const titleRow=document.createElement('div'); titleRow.className='title-row'; const title=document.createElement('div'); title.className='title'; title.textContent=p.title||fileNameWithoutExt(p.name); const btnRow=document.createElement('div'); btnRow.className='actions'; if(showTrash){ const restoreBtn=document.createElement('button'); restoreBtn.className='btn small'; restoreBtn.type='button'; restoreBtn.textContent='é‚„åŸ'; restoreBtn.addEventListener('click',()=>restorePhoto(p.id)); const delBtn=document.createElement('button'); delBtn.className='btn small danger'; delBtn.type='button'; delBtn.textContent='æ°¸ä¹…åˆªé™¤'; delBtn.addEventListener('click',()=>permanentlyDelete(p.id)); btnRow.appendChild(restoreBtn); btnRow.appendChild(delBtn);} else { const editBtn=document.createElement('button'); editBtn.className='btn small'; editBtn.type='button'; editBtn.textContent='ç·¨è¼¯'; editBtn.addEventListener('click',()=>openEditor(p.id)); const shareBtn=document.createElement('button'); shareBtn.className='btn small primary'; shareBtn.type='button'; shareBtn.textContent='åˆ†äº«'; shareBtn.addEventListener('click',()=>sharePhoto(p.id)); const copyBtn=document.createElement('button'); copyBtn.className='btn small secondary'; copyBtn.type='button'; copyBtn.textContent='è¤‡è£½é€£çµ'; copyBtn.addEventListener('click',()=>copyShareLink(p.id)); const trashBtn=document.createElement('button'); trashBtn.className='btn small danger'; trashBtn.type='button'; trashBtn.textContent='åˆªé™¤'; trashBtn.addEventListener('click',()=>moveToTrash(p.id)); btnRow.appendChild(editBtn); btnRow.appendChild(shareBtn); btnRow.appendChild(copyBtn); btnRow.appendChild(trashBtn); }
        titleRow.appendChild(title); titleRow.appendChild(btnRow); const time=document.createElement('div'); time.className='time'; time.textContent='æ™‚é–“ï¼š'+fmtFull(p.lastModified)+'ï½œ'+prettySize(p.size||0); const tagsWrap=document.createElement('div'); tagsWrap.className='tags'; (p.tags||[]).forEach(t=>{ const chip=document.createElement('span'); chip.className='tag'; chip.textContent=t; tagsWrap.appendChild(chip); }); const shareLine=document.createElement('div'); shareLine.className='time'; const token=getTokenByPhotoId(p.id); if(token){ const a=document.createElement('a'); a.href=buildShareUrl(token); a.textContent='å·²åˆ†äº«ï¼š'+a.href; a.target='_blank'; shareLine.appendChild(a); } else { shareLine.textContent='å°šæœªåˆ†äº«'; } meta.appendChild(titleRow); meta.appendChild(time); meta.appendChild(tagsWrap); meta.appendChild(shareLine); card.appendChild(th); card.appendChild(meta); frag.appendChild(card); }); }
    grid.innerHTML=''; grid.appendChild(frag); const trashCount=photos.filter(p=>p.isDeleted).length; trashBadge.textContent=String(trashCount); const shown=baseFilter(photos).length; countAll.textContent=String(photos.filter(p=>!p.isDeleted).length); countFiltered.textContent=String(shown); countShown.textContent=String(shown); trashHint.style.display = showTrash? 'inline':'none'; emptyTrashBtn.style.display = showTrash? 'inline-flex':'none'; }

  // ---- Trash opsï¼ˆDay 16ï¼‰
  const DAYS_KEEP=7, MS_DAY=24*60*60*1000;
  function moveToTrash(id){ const p=photos.find(x=>x.id===id); if(!p) return; if(p.isDeleted) return; p.isDeleted=true; p.deletedAt=now(); persist(); render(); }
  function restorePhoto(id){ const p=photos.find(x=>x.id===id); if(!p) return; if(!p.isDeleted) return; p.isDeleted=false; p.deletedAt=null; persist(); render(); }
  function permanentlyDelete(id){ const idx=photos.findIndex(x=>x.id===id); if(idx<0) return; if(confirm('æ­¤å‹•ä½œç„¡æ³•é‚„åŸï¼Œç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ')){ photos.splice(idx,1); persist(); render(); } }
  function emptyTrash(){ if(!photos.some(p=>p.isDeleted)) return alert('å›æ”¶æ¡¶ç›®å‰æ˜¯ç©ºçš„'); if(!confirm('å°‡æ°¸ä¹…åˆªé™¤å›æ”¶æ¡¶å…§æ‰€æœ‰é …ç›®ï¼Œç„¡æ³•å¾©åŸã€‚è¦ç¹¼çºŒå—ï¼Ÿ')) return; photos = photos.filter(p=>!p.isDeleted); persist(); render(); }
  function autoPurge(){ const limit=now()-DAYS_KEEP*MS_DAY; const before=photos.length; photos=photos.filter(p=>!(p.isDeleted&&typeof p.deletedAt==='number'&&p.deletedAt<limit)); if(photos.length!==before) persist(); }

  // ---- Shareï¼ˆDay 24ï¼Œæ”¹ç‚ºå…¨åŸŸ token è¡¨ï¼Œå« ownerï¼‰
  function getTokenByPhotoId(id){ const map=loadShares(); for(const k in map){ if(Object.prototype.hasOwnProperty.call(map,k)){ const s=map[k]; if(s && s.snapshot && s.snapshot.id===id && s.owner===currentUserEmail()) return k; } } return null; }
  function buildShareUrl(token){ const base=location.origin + location.pathname; return base + '?share=' + encodeURIComponent(token); }
  function sharePhoto(id){ const p=photos.find(x=>x.id===id); if(!p) return; let token=getTokenByPhotoId(id); const map=loadShares(); if(!token){ token='sh_'+uid(); const snap={ id:p.id, dataUrl:p.dataUrl, name:p.name, lastModified:p.lastModified, size:p.size, title:p.title, desc:p.desc, tags:Array.isArray(p.tags)? p.tags.slice():[] }; map[token]={ owner: currentUserEmail(), createdAt: now(), snapshot: snap }; saveShares(map); } const url=buildShareUrl(token); const ok=confirm('å·²ç”¢ç”Ÿåˆ†äº«é€£çµï¼š\n\n'+url+'\n\næ˜¯å¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Ÿ'); if(ok){ copyText(url); alert('å·²è¤‡è£½åˆ†äº«é€£çµ'); } render(); }
  function copyShareLink(id){ const token=getTokenByPhotoId(id); if(!token){ alert('å°šæœªåˆ†äº«ï¼Œè«‹å…ˆé»ã€Œåˆ†äº«ã€ç”¢ç”Ÿé€£çµ'); return; } const url=buildShareUrl(token); copyText(url); alert('å·²è¤‡è£½åˆ†äº«é€£çµ'); }
  function revokeShareById(id){ const token=getTokenByPhotoId(id); if(!token) return alert('æ­¤ç…§ç‰‡ç›®å‰æ²’æœ‰åˆ†äº«é€£çµ'); const map=loadShares(); delete map[token]; saveShares(map); render(); alert('å·²å–æ¶ˆåˆ†äº«'); }
  function copyText(text){ if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text); } else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} ta.remove(); } }

  // ---- Visitor mode
  function qp(name){ const u=new URL(location.href); return u.searchParams.get(name); }
  function showVisitor(token){ const map=loadShares(); const rec=map[token]; if(!rec || !rec.snapshot){ authSection.style.display='none'; authedToolbar.style.display='none'; appSection.style.display='none'; visitorView.style.display='block'; visitorView.innerHTML='<div class="card" style="padding:20px">é€£çµå·²å¤±æ•ˆæˆ–ä¸å­˜åœ¨ã€‚</div>'; return; } const p=rec.snapshot; authSection.style.display='none'; authedToolbar.style.display='none'; appSection.style.display='none'; visitorView.style.display='block'; vImg.src=p.dataUrl; vTitle.textContent=p.title||fileNameWithoutExt(p.name); vMeta.textContent='æ™‚é–“ï¼š'+fmtFull(p.lastModified)+'ï½œ'+prettySize(p.size||0); vDesc.textContent=p.desc||'â€”'; vTags.innerHTML=''; (p.tags||[]).forEach(t=>{ const chip=document.createElement('span'); chip.className='tag'; chip.textContent=t; vTags.appendChild(chip); }); }

  // ---- Modal
  function openEditor(id){ const p=photos.find(x=>x.id===id); if(!p) return; if(p.isDeleted) return alert('å›æ”¶æ¡¶ä¸­çš„é …ç›®ä¸èƒ½ç·¨è¼¯ï¼Œè«‹å…ˆé‚„åŸ'); editingId=id; fTitle.value=p.title||fileNameWithoutExt(p.name); fDesc.value=p.desc||''; fTags.value=(p.tags||[]).join(', '); showModal(true); setTimeout(()=>fTitle.focus(),0); }
  function showModal(show){ modalBackdrop.style.display = show? 'flex':'none'; modalBackdrop.setAttribute('aria-hidden', show? 'false': 'true'); if(!show) editingId=null; }
  function saveEditor(){ const p=photos.find(x=>x.id===editingId); if(!p) return; p.title=String(fTitle.value||'').trim(); p.desc=String(fDesc.value||'').trim(); p.tags=String(fTags.value||'').split(',').map(s=>s.trim()).filter(Boolean); persist(); // åŒæ­¥æ›´æ–°åˆ†äº«å¿«ç…§
    const token=getTokenByPhotoId(p.id); if(token){ const map=loadShares(); if(map[token]){ map[token].snapshot={ id:p.id, dataUrl:p.dataUrl, name:p.name, lastModified:p.lastModified, size:p.size, title:p.title, desc:p.desc, tags:Array.isArray(p.tags)? p.tags.slice():[] }; saveShares(map); } }
    render(); showModal(false); }
  btnCancel.addEventListener('click',()=>showModal(false));
  btnSave.addEventListener('click',saveEditor);
  modalBackdrop.addEventListener('click',ev=>{ if(ev.target===modalBackdrop) showModal(false); });
  document.addEventListener('keydown',ev=>{ if(modalBackdrop.style.display==='flex' && ev.key==='Escape') showModal(false); });

  // ---- Upload / search
  fileInput.addEventListener('change', async (e)=>{ const files=Array.prototype.slice.call(e.target.files||[]); if(!files.length) return; const images=files.filter(f=>f.type && f.type.indexOf('image/')===0); const non=files.filter(f=>!f.type||f.type.indexOf('image/')!==0); if(non.length) alert('å·²ç•¥ééåœ–ç‰‡æª”æ¡ˆ:\n'+non.map(f=>'â€¢ '+f.name).join('\n')); for(let i=0;i<images.length;i++){ const file=images[i]; try{ const dataUrl=await readFileAsDataURL(file); photos.push({ id:uid(), dataUrl:String(dataUrl), name:file.name, lastModified:file.lastModified, size:file.size, title:fileNameWithoutExt(file.name), desc:'', tags:[], isDeleted:false, deletedAt:null }); }catch(err){ console.warn('è½‰æ› DataURL å¤±æ•—ï¼š', err); } } e.target.value=''; persist(); render(); });
  searchInput.addEventListener('input', e=>{ query=e.target.value||''; render(); });

  // ---- Tabs & controls
  function setTab(trash){ showTrash=!!trash; tabLibrary.classList.toggle('active', !showTrash); tabTrash.classList.toggle('active', showTrash); render(); }
  tabLibrary.addEventListener('click', ()=>setTab(false));
  tabTrash.addEventListener('click', ()=>setTab(true));
  emptyTrashBtn.addEventListener('click', emptyTrash);
  clearAllBtn.addEventListener('click', ()=>{ if(!photos.length) return; if(confirm('å°‡åˆªé™¤æ­¤å¸³è™Ÿæ‰€æœ‰ç›¸ç‰‡ï¼ˆå«å›æ”¶æ¡¶ï¼‰ï¼Œç„¡æ³•å¾©åŸã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ')){ photos=[]; persist(); render(); }});

  // ---- Auth UI
  function setMode(m){ mode=m; if(m==='register'){ registerExtras.style.display='block'; toggleModeBtn.textContent='åˆ‡æ›åˆ°ç™»å…¥'; submitBtn.textContent='è¨»å†Š'; authMsg.textContent=''; authMsg.className='muted'; } else { registerExtras.style.display='none'; toggleModeBtn.textContent='åˆ‡æ›åˆ°è¨»å†Š'; submitBtn.textContent='ç™»å…¥'; authMsg.textContent=''; authMsg.className='muted'; } }
  toggleModeBtn.addEventListener('click', ()=> setMode(mode==='login'? 'register':'login'));
  submitBtn.addEventListener('click', async ()=>{
    const email=emailInput.value||''; const pass=passwordInput.value||''; const pass2=password2Input.value||'';
    try{
      const lock=checkLocked(email); if(lock.locked){ const s=Math.ceil((lock.leftMs||0)/1000); lockHint.style.display='block'; lockHint.textContent='æ­¤å¸³è™Ÿå·²é–å®šï¼Œè«‹ '+s+' ç§’å¾Œå†è©¦'; throw new Error('å¸³è™Ÿæš«æ™‚é–å®š'); } else { lockHint.style.display='none'; }
      if(mode==='register'){
        if(pass!==pass2) throw new Error('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´');
        const u=await register(email, pass);
        authMsg.textContent='è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥'; authMsg.className='ok'; setMode('login'); emailInput.value=u.email; passwordInput.value=''; password2Input.value='';
      } else {
        const u=await login(email, pass);
        emailInput.value=''; passwordInput.value=''; password2Input.value=''; onAuthed(u.email);
      }
    }catch(err){ authMsg.textContent=err.message||String(err); authMsg.className='error'; }
  });
  logoutBtn.addEventListener('click', ()=>{ logout(); photos=[]; query=''; showAuthed(false); authMsg.textContent='å·²ç™»å‡º'; authMsg.className='muted'; });
  function showAuthed(is){ authSection.style.display=is? 'none':'grid'; authedToolbar.style.display=is? 'grid':'none'; appSection.style.display=is? 'block':'none'; }
  function onAuthed(email){ showAuthed(true); currentUserSpan.textContent=email; photos=loadPhotos(email); // å‡ç´šæ¬„ä½
    let patched=false; photos.forEach(p=>{ if(!('isDeleted' in p)){ p.isDeleted=false; patched=true } if(!('deletedAt' in p)){ p.deletedAt=null; patched=true } }); if(patched) persist(); autoPurge(); render(); }
  function persist(){ const email=currentUserEmail(); if(!email) return; savePhotos(email, photos); }

  // ---- Visitor Home Btn
  btnVisitHome.addEventListener('click', ()=>{ const base=location.origin+location.pathname; location.href=base; });

  // ---- Self-testsï¼ˆæ›´å¥å£¯ï¼‰
  async function runSelfTests(){
    console.groupCollapsed('ğŸ” Self-tests for Day 26');
    try{
      // 1) é›œæ¹Šæ¸¬è©¦
      const h1=await sha256Hex('x'); const h2=await sha256Hex('x'); const h3=await sha256Hex('y');
      console.assert(h1===h2 && h1.length===64 && h1!==h3, 'SHA-256 ä¸€è‡´/å¯å€åˆ†');
      // 2) è¨»å†Š/ç™»å…¥/é–å®š
      const usersBackup=loadUsers(); const sessBackup=sget(LS_SESSION);
      saveUsers([]); setSession('');
      let u=await register('sandbox@example.com','12345678'); console.assert(u && u.email==='sandbox@example.com','è¨»å†Š ok');
      let ok=false; try{ await login('sandbox@example.com','bad'); }catch(e){ ok=true; } console.assert(ok,'éŒ¯èª¤å¯†ç¢¼æ‡‰å¤±æ•—');
      // é€£çºŒ 5 æ¬¡éŒ¯èª¤è§¸ç™¼é–å®š
      let locked=false; for(let i=0;i<5;i++){ try{ await login('sandbox@example.com','bad'); }catch(e){ if(String(e).includes('é–å®š')) locked=true; } }
      console.assert(locked || checkLocked('sandbox@example.com').locked, 'æ‡‰è§¸ç™¼é–å®š');
      // æ­£ç¢ºå¯†ç¢¼åœ¨é–å®šä¸‹ä»æœƒè¢«æ‹’çµ•
      let denied=false; try{ await login('sandbox@example.com','12345678'); }catch(e){ denied=true; }
      console.assert(denied,'é–å®šä¸­æ‡‰ç„¡æ³•ç™»å…¥');
      // æ¸…é™¤é–å®šä¸¦ç™»å…¥
      setLockMap({}); const u2=await login('sandbox@example.com','12345678'); console.assert(u2 && u2.email,'è§£é–å¾Œå¯ç™»å…¥');
      // 3) å¤šä½¿ç”¨è€…å‘½åç©ºé–“
      const kA=userPhotosKey('a@example.com'); const kB=userPhotosKey('b@example.com'); console.assert(kA!==kB,'ä¸åŒå¸³è™Ÿä¸åŒç©ºé–“');
      sset(kA, JSON.stringify([{id:'p1'}])); sset(kB, JSON.stringify([{id:'p2'},{id:'p3'}]));
      const aLen=JSON.parse(sget(kA)||'[]').length; const bLen=JSON.parse(sget(kB)||'[]').length; console.assert(aLen===1 && bLen===2,'ç›¸ç‰‡ç©ºé–“éš”é›¢');
      // 4) åˆ†äº«å¿«ç…§èˆ‡å›æ”¶æ¡¶
      setSession('day26@test.com'); savePhotos('day26@test.com', []); photos=[]; const demo={id:'t1', dataUrl:'data:image/png;base64,iVBORw0KGgo=', name:'t.png', lastModified:1, size:1, title:'T', desc:'D', tags:[], isDeleted:false, deletedAt:null}; photos.push(demo); persist(); sharePhoto('t1'); const token=getTokenByPhotoId('t1'); console.assert(!!token, 'æ‡‰ç”¢ç”Ÿåˆ†äº« token'); moveToTrash('t1'); console.assert(photos.find(p=>p.id==='t1').isDeleted, 'ç§»å…¥å›æ”¶æ¡¶'); restorePhoto('t1'); console.assert(!photos.find(p=>p.id==='t1').isDeleted, 'é‚„åŸæˆåŠŸ');
      // é‚„åŸ users/session
      saveUsers(usersBackup); sessBackup==null? setSession(''): setSession(sessBackup);
      console.log('âœ… è‡ªæˆ‘æ¸¬è©¦é€šé');
    }catch(err){ console.error('âŒ è‡ªæˆ‘æ¸¬è©¦å¤±æ•—', err); }
    console.groupEnd();
  }

  // ---- Init
  (function init(){
    const share=qp('share'); if(share){ showVisitor(share); return; }
    setMode('login');
    const authed=currentUserEmail(); if(authed){ onAuthed(authed); }
    runSelfTests();
  })();
  </script>
</body>
</html>
