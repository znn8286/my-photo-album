<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Day 6ï½œç·šä¸Šç›¸ç°¿ - æœå°‹ï¼ˆæ¨™é¡Œï¼æ•˜è¿°ï¼æ¨™ç±¤ï¼‰</title>
  <!--
    ä½¿ç”¨æ–¹å¼ï¼š
    1) é€™æ˜¯å–®ä¸€ HTML æª”ï¼Œç›´æ¥å­˜æˆ index.htmlï¼Œç”¨ç€è¦½å™¨é–‹å•Ÿå³å¯ã€‚
    2) ä»Šæ—¥ç›®æ¨™ï¼šå•Ÿç”¨ã€Œå³æ™‚æœå°‹ã€ã€‚é—œéµå­—æœƒå³æ™‚éæ¿¾å¡ç‰‡ï¼ˆæ¨™é¡Œ / æ•˜è¿° / æ¨™ç±¤ / æª”åï¼‰ã€‚
    3) å»¶çºŒ Day 5ï¼šLocalStorage æ°¸çºŒåŒ–ï¼›å»¶çºŒ Day 4ï¼šå¯ç·¨è¼¯ä¸­ç¹¼è³‡æ–™ã€‚
    4) æ¡Œæ©Ÿç‚ºä¸»ï¼šå…§å®¹å¯¬ 1200pxã€4 æ¬„ç¶²æ ¼ï¼ˆç•¥çª„å¯ 3 æ¬„ï¼‰ã€‚
  -->
  <style>
    :root {
      --bg: #ffffff;
      --text: #2b2b2b;
      --muted: #6b6b6b;
      --primary: #ff8c42;
      --border: #e6e6e6;
      --card: #fafafa;
      --shadow: rgba(0,0,0,0.06);
      --overlay: rgba(0,0,0,0.5);
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; box-sizing: border-box; }

    /* ====== é é¦– ====== */
    header.site-header { border-bottom: 1px solid var(--border); background: linear-gradient(180deg, #fff, #fff6f0); }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand__logo { width: 40px; height: 40px; border-radius: 10px; background: var(--primary); display: inline-flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; }
    .brand__title { margin: 0; font-size: 22px; }
    .brand__subtitle { margin: 4px 0 0; color: var(--muted); font-size: 14px; }

    /* ====== å·¥å…·åˆ—ï¼ˆä»Šå¤©å•Ÿç”¨æœå°‹ï¼‰ ====== */
    .toolbar { display: grid; grid-template-columns: 1fr 320px 140px 140px; gap: 12px; margin-top: 16px; align-items: center; }
    .toolbar input[type="text"], .toolbar select, .toolbar button { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; box-sizing: border-box; }
    .toolbar input[type="file"] { padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; }
    .toolbar button.action { background: var(--primary); color: #fff; border: none; cursor: pointer; }

    /* ====== å…§å®¹å€ï¼š4 æ¬„ç¶²æ ¼ ====== */
    main.gallery { margin-top: 20px; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

    /* ====== å¡ç‰‡ ====== */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 2px 8px var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
    .thumb { aspect-ratio: 4 / 3; background: #f4f4f4; position: relative; display: flex; align-items: center; justify-content: center; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .meta { padding: 12px; display: grid; grid-template-rows: auto auto auto; gap: 6px; }
    .title-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .title { font-size: 15px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .time { font-size: 12px; color: var(--muted); }
    .tags { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { font-size: 11px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; color: #555; background: #fff; }
    .btn { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 13px; }
    .btn.edit { background: var(--primary); color: #fff; border: none; }

    /* è¼•é‡ç‹€æ…‹åˆ— */
    .statusbar { display:flex; align-items:center; justify-content: space-between; margin: 8px 0 12px; color: var(--muted); font-size: 13px; }

    /* ç©ºç‹€æ…‹ */
    .empty {
      border: 2px dashed var(--border); border-radius: 12px; padding: 24px; color: var(--muted);
      display:flex; align-items:center; justify-content:center; grid-column: 1 / -1;
      background:#fff;
    }

    /* è¦–çª—ç•¥çª„æ™‚å…è¨± 3 æ¬„ï¼ˆä»å±¬æ¡Œæ©Ÿï¼‰ */
    @media (max-width: 1199px) { .grid { grid-template-columns: repeat(3, 1fr); } }
  </style>
</head>
<body>
  <!-- ====== é é¦– ====== -->
  <header class="site-header">
    <div class="container">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">PA</div>
        <div>
          <h1 class="brand__title">ç·šä¸Šç›¸ç°¿ï¼ˆDay 6ï¼‰</h1>
          <p class="brand__subtitle">å³æ™‚æœå°‹ï¼šæ¨™é¡Œï¼æ•˜è¿°ï¼æ¨™ç±¤ï¼æª”å</p>
        </div>
      </div>

      <div class="toolbar" role="region" aria-label="å·¥å…·åˆ—">
        <input id="searchInput" type="text" placeholder="è¼¸å…¥é—œéµå­—å³å¯ç¯©é¸ï¼ˆå¯è¼¸å…¥å¤šå€‹è©ï¼Œä»¥ç©ºç™½åˆ†éš”ï¼‰">
        <input id="fileInput" type="file" accept="image/*" multiple>
        <select disabled>
          <option selected>åˆ†é¡ï¼ˆDay 7 å•Ÿç”¨ï¼‰</option>
        </select>
        <select disabled>
          <option selected>æ’åºï¼ˆDay 8 å•Ÿç”¨ï¼‰</option>
        </select>
        <div style="grid-column: 1 / -1; font-size:13px; color:var(--muted);">
          æç¤ºï¼šé—œéµå­—æœƒåœ¨ã€Œæ¨™é¡Œã€æ•˜è¿°ã€æ¨™ç±¤ã€æª”åã€ä¸­å°‹æ‰¾ï¼Œå¤§å°å¯«ä¸æ•æ„Ÿã€‚ä¾‹ï¼š<code>è²“ å’–å•¡</code>
        </div>
      </div>
    </div>
  </header>

  <!-- ====== å…§å®¹ï¼šæœå°‹ + ä¸Šå‚³ + ç·¨è¼¯ + æ°¸çºŒåŒ– ====== -->
  <main class="gallery">
    <div class="container">
      <div class="statusbar">
        <div><span id="countAll">0</span> å¼µç…§ç‰‡</div>
        <div>ç¬¦åˆæœå°‹ï¼š<span id="countFiltered">0</span> å¼µ</div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px;">
        <button id="clearBtn" class="btn" type="button" title="æ¸…ç©ºå…¨éƒ¨è³‡æ–™">æ¸…ç©ºå…¨éƒ¨</button>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </div>
  </main>

  <!-- ====== Modalï¼šç·¨è¼¯åœ–ç‰‡ä¸­ç¹¼è³‡æ–™ ====== -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div class="modal__header" id="modalTitle">ç·¨è¼¯åœ–ç‰‡è³‡è¨Š</div>
      <div class="modal__body">
        <div class="field">
          <label for="fTitle">æ¨™é¡Œ</label>
          <input id="fTitle" type="text" placeholder="ä¾‹ï¼šå°åŒ—å°æ—…è¡Œ" />
        </div>
        <div class="field">
          <label for="fDesc">æ•˜è¿°</label>
          <textarea id="fDesc" placeholder="ç°¡çŸ­æè¿°é€™å¼µç…§ç‰‡...ï¼ˆéå¿…å¡«ï¼‰"></textarea>
        </div>
        <div class="field">
          <label for="fTags">æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿ , åˆ†éš”ï¼‰</label>
          <input id="fTags" type="text" placeholder="ä¾‹ï¼šæ—…éŠ, æœ‹å‹, æ™šä¸Š" />
        </div>
      </div>
      <div class="modal__footer">
        <button id="btnCancel" class="btn secondary" type="button">å–æ¶ˆ</button>
        <button id="btnSave" class="btn primary" type="button">å„²å­˜</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container" style="border-top:1px solid var(--border); margin-top:32px; padding-top:16px; color:var(--muted); font-size:13px; text-align:center;">
      Day 6 å®Œæˆï¼šå³æ™‚æœå°‹ï¼ˆæ¨™é¡Œï¼æ•˜è¿°ï¼æ¨™ç±¤ï¼æª”åï¼‰ã€‚
    </div>
  </footer>

  <script>
    // ============================
    // Day 6ï¼šæœå°‹ï¼ˆåˆå­¸è€…ç‰ˆï¼‰
    // - å»¶çºŒ Day 5 LocalStorage
    // - å»¶çºŒ Day 4 ç·¨è¼¯ä¸­ç¹¼è³‡æ–™
    // ============================

    const LS_KEY = 'pa_photos_v1';

    const fileInput = document.getElementById('fileInput');
    const searchInput = document.getElementById('searchInput');
    const grid = document.getElementById('grid');
    const clearBtn = document.getElementById('clearBtn');

    const countAll = document.getElementById('countAll');
    const countFiltered = document.getElementById('countFiltered');

    // Modal å…ƒä»¶ç›¸é—œ
    const modalBackdrop = document.getElementById('modalBackdrop');
    const fTitle = document.getElementById('fTitle');
    const fDesc = document.getElementById('fDesc');
    const fTags = document.getElementById('fTags');
    const btnCancel = document.getElementById('btnCancel');
    const btnSave = document.getElementById('btnSave');

    /** @type {{ id:string, dataUrl:string, name:string, lastModified:number, size:number, title:string, desc:string, tags:string[] }[]} */
    let photos = [];
    let editingId = null;
    let query = '';

    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    function prettySize(bytes) {
      const units = ['B','KB','MB','GB'];
      let i = 0, num = bytes;
      while (num >= 1024 && i < units.length - 1) { num /= 1024; i++; }
      return `${num.toFixed(1)} ${units[i]}`;
    }

    function fileNameWithoutExt(name='') {
      const i = name.lastIndexOf('.');
      return i > 0 ? name.slice(0, i) : name || 'æœªå‘½ååœ–ç‰‡';
    }

    function safeGetLS(key) { try { return localStorage.getItem(key); } catch (e) { console.warn('è®€å– LocalStorage å¤±æ•—ï¼š', e); return null; } }
    function safeSetLS(key, val) { try { localStorage.setItem(key, val); return true; } catch (e) { alert('å„²å­˜å¤±æ•—ï¼Œå¯èƒ½è¶…é LocalStorage å®¹é‡ã€‚'); console.warn('å¯«å…¥ LocalStorage å¤±æ•—ï¼š', e); return false; } }
    function saveToStorage() { return safeSetLS(LS_KEY, JSON.stringify(photos)); }
    function loadFromStorage() {
      const raw = safeGetLS(LS_KEY);
      if (!raw) return [];
      try { const arr = JSON.parse(raw); if (Array.isArray(arr)) return arr; } catch (e) { console.warn('è§£æ JSON å¤±æ•—ï¼š', e); }
      return [];
    }

    // ä¾æŸ¥è©¢å­—ä¸²å›å‚³éæ¿¾å¾Œçš„é™£åˆ—ï¼ˆå¤§å°å¯«ä¸æ•æ„Ÿï¼›å¤šè©å¿…é ˆå…¨éƒ¨å‘½ä¸­ï¼‰
    function getFilteredPhotos() {
      const q = query.trim().toLowerCase();
      if (!q) return photos.slice();
      const tokens = q.split(/\s+/).filter(Boolean);
      return photos.filter(p => {
        const hay = [
          p.title || '',
          p.desc || '',
          (p.tags || []).join(' '),
          p.name || ''
        ].join(' ').toLowerCase();
        return tokens.every(tok => hay.includes(tok));
      });
    }

    function render() {
      const data = getFilteredPhotos();
      countAll.textContent = String(photos.length);
      countFiltered.textContent = String(data.length);

      const frag = document.createDocumentFragment();

      if (data.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = query ? 'æ²’æœ‰ç¬¦åˆæœå°‹çš„çµæœã€‚è©¦è©¦å…¶ä»–é—œéµå­—ã€‚' : 'é‚„æ²’æœ‰ç›¸ç‰‡ï¼Œè«‹å¾ä¸Šæ–¹ä¸Šå‚³ã€‚';
        frag.appendChild(empty);
      } else {
        data.forEach(p => {
          const card = document.createElement('article');
          card.className = 'card';
          card.dataset.id = p.id;

          const thumb = document.createElement('div');
          thumb.className = 'thumb';
          const img = document.createElement('img');
          img.src = p.dataUrl;
          img.alt = p.title || p.name;
          thumb.appendChild(img);

          const meta = document.createElement('div');
          meta.className = 'meta';

          const titleRow = document.createElement('div');
          titleRow.className = 'title-row';
          const title = document.createElement('div');
          title.className = 'title';
          title.textContent = p.title || fileNameWithoutExt(p.name);

          const editBtn = document.createElement('button');
          editBtn.className = 'btn edit';
          editBtn.type = 'button';
          editBtn.textContent = 'ç·¨è¼¯';
          editBtn.addEventListener('click', () => openEditor(p.id));

          titleRow.appendChild(title);
          titleRow.appendChild(editBtn);

          const time = document.createElement('div');
          time.className = 'time';
          const dt = new Date(p.lastModified || Date.now());
          time.textContent = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}ï½œ${prettySize(p.size||0)}`;

          const tagsWrap = document.createElement('div');
          tagsWrap.className = 'tags';
          (p.tags || []).filter(Boolean).forEach(t => {
            const chip = document.createElement('span');
            chip.className = 'tag';
            chip.textContent = t;
            tagsWrap.appendChild(chip);
          });

          meta.appendChild(titleRow);
          meta.appendChild(time);
          meta.appendChild(tagsWrap);

          card.appendChild(thumb);
          card.appendChild(meta);
          frag.appendChild(card);
        });
      }

      grid.innerHTML = '';
      grid.appendChild(frag);
    }

    // è®€å–æª”æ¡ˆç‚º DataURLï¼ˆPromise ç‰ˆï¼‰
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('è®€æª”å¤±æ•—'));
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    // ========== äº‹ä»¶è™•ç† ==========
    // ä¸Šå‚³æª”æ¡ˆ
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      const images = files.filter(f => f.type && f.type.startsWith('image/'));
      const nonImages = files.filter(f => !f.type || !f.type.startsWith('image/'));
      if (nonImages.length) alert('å·²ç•¥ééåœ–ç‰‡æª”æ¡ˆï¼š\n' + nonImages.map(f => `â€¢ ${f.name}`).join('\n'));

      for (const file of images) {
        try {
          const dataUrl = await readFileAsDataURL(file);
          photos.push({
            id: uid(),
            dataUrl: String(dataUrl),
            name: file.name,
            lastModified: file.lastModified,
            size: file.size,
            title: fileNameWithoutExt(file.name),
            desc: '',
            tags: [],
          });
        } catch (err) {
          console.warn('è½‰æ› DataURL å¤±æ•—ï¼š', err);
        }
      }

      saveToStorage();
      render();
      fileInput.value = '';
    });

    // æ¸…ç©ºå…¨éƒ¨è³‡æ–™
    clearBtn.addEventListener('click', () => {
      if (!photos.length) return;
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºã€Œæ‰€æœ‰å·²å„²å­˜ã€çš„ç›¸ç‰‡èˆ‡è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œä¸å¯å›å¾©ã€‚')) {
        photos = [];
        saveToStorage();
        render();
      }
    });

    // æœå°‹è¼¸å…¥ï¼šå³æ™‚éæ¿¾ï¼ˆåŸºæœ¬ç‰ˆï¼Œç„¡ debounceï¼‰
    searchInput.addEventListener('input', (e) => {
      query = e.target.value || '';
      render();
    });

    // ====== ç·¨è¼¯å½ˆçª— ======
    function openEditor(id) {
      const p = photos.find(x => x.id === id);
      if (!p) return;
      editingId = id;
      fTitle.value = p.title || fileNameWithoutExt(p.name);
      fDesc.value = p.desc || '';
      fTags.value = (p.tags || []).join(', ');
      showModal(true);
      setTimeout(() => fTitle.focus(), 0);
    }

    function showModal(show) {
      modalBackdrop.style.display = show ? 'flex' : 'none';
      modalBackdrop.setAttribute('aria-hidden', show ? 'false' : 'true');
      if (!show) editingId = null;
    }

    function saveEditor() {
      const p = photos.find(x => x.id === editingId);
      if (!p) return;
      p.title = fTitle.value.trim();
      p.desc = fDesc.value.trim();
      p.tags = fTags.value.split(',').map(s => s.trim()).filter(Boolean);
      saveToStorage();
      render();
      showModal(false);
    }

    // âš ï¸ ä¿®æ­£ï¼šé¿å…é‡è¤‡å®£å‘Š btnCancel/btnSaveï¼ˆåŸæœ¬é€™è£¡åˆå®£å‘Šä¸€æ¬¡æœƒé€ æˆ SyntaxErrorï¼‰
    // ç›´æ¥ä½¿ç”¨ä¸Šæ–¹å·²å–å¾—çš„ç¯€é»ï¼Œåƒ…ç¶å®šäº‹ä»¶å³å¯ã€‚
    btnCancel.addEventListener('click', () => showModal(false));
    btnSave.addEventListener('click', saveEditor);
    document.addEventListener('keydown', (ev) => {
      if (modalBackdrop.style.display === 'flex' && ev.key === 'Escape') showModal(false);
    });
    modalBackdrop.addEventListener('click', (ev) => { if (ev.target === modalBackdrop) showModal(false); });

    // ============================
    // ç°¡æ˜“è‡ªå‹•åŒ–æ¸¬è©¦ï¼ˆä¸æ›´å‹•ä½ çš„è³‡æ–™ï¼›åƒ… console è¼¸å‡ºï¼‰
    // ============================
    function runSelfTests() {
      console.groupCollapsed('ğŸ” Self-tests for Day 6');
      try {
        console.assert(btnCancel && btnSave, 'btnCancel / btnSave æ‡‰å­˜åœ¨');
        const before = photos.length;
        const q0 = query; // ä¿å­˜æŸ¥è©¢å­—ä¸²
        query = '';
        const all = getFilteredPhotos();
        console.assert(all.length === before, 'ç©ºç™½æœå°‹æ‡‰å›å‚³å…¨éƒ¨ç…§ç‰‡æ•¸');
        // å˜—è©¦ç”¨å·²å­˜åœ¨ç…§ç‰‡çš„æ¨™é¡Œæ¸¬ä¸€æ¬¡ï¼ˆè‹¥æ²’æœ‰ç…§ç‰‡å‰‡ç•¥éï¼‰
        if (before > 0) {
          const token = (photos[0].title || '').split(/\s+/)[0];
          if (token) {
            query = token;
            const res = getFilteredPhotos();
            console.assert(res.length >= 1, 'ä»¥ç¬¬ä¸€å¼µç…§ç‰‡çš„æŸå€‹è©æœå°‹ï¼Œæ‡‰è‡³å°‘å‘½ä¸­ 1 å¼µ');
          }
        }
        query = q0; // é‚„åŸæŸ¥è©¢å­—ä¸²
        console.log('âœ… è‡ªå‹•åŒ–æ¸¬è©¦å®Œæˆ');
      } catch (err) {
        console.error('âŒ è‡ªå‹•åŒ–æ¸¬è©¦å¤±æ•—ï¼š', err);
      }
      console.groupEnd();
    }

    // åˆå§‹åŒ–ï¼šå¾ LocalStorage è¼‰å…¥ä¸¦æ¸²æŸ“
    (function init() {
      photos = loadFromStorage();
      render();
      runSelfTests();
      console.log('âœ… Day 6ï¼šæœå°‹å·²å•Ÿç”¨ï¼›ç›®å‰ç…§ç‰‡æ•¸ï¼š', photos.length);
    })();
  </script>
</body>
</html>
