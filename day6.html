<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Day 6｜線上相簿 - 搜尋（標題／敘述／標籤）</title>
  <!--
    使用方式：
    1) 這是單一 HTML 檔，直接存成 index.html，用瀏覽器開啟即可。
    2) 今日目標：啟用「即時搜尋」。關鍵字會即時過濾卡片（標題 / 敘述 / 標籤 / 檔名）。
    3) 延續 Day 5：LocalStorage 永續化；延續 Day 4：可編輯中繼資料。
    4) 桌機為主：內容寬 1200px、4 欄網格（略窄可 3 欄）。
  -->
  <style>
    :root {
      --bg: #ffffff;
      --text: #2b2b2b;
      --muted: #6b6b6b;
      --primary: #ff8c42;
      --border: #e6e6e6;
      --card: #fafafa;
      --shadow: rgba(0,0,0,0.06);
      --overlay: rgba(0,0,0,0.5);
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; box-sizing: border-box; }

    /* ====== 頁首 ====== */
    header.site-header { border-bottom: 1px solid var(--border); background: linear-gradient(180deg, #fff, #fff6f0); }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand__logo { width: 40px; height: 40px; border-radius: 10px; background: var(--primary); display: inline-flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; }
    .brand__title { margin: 0; font-size: 22px; }
    .brand__subtitle { margin: 4px 0 0; color: var(--muted); font-size: 14px; }

    /* ====== 工具列（今天啟用搜尋） ====== */
    .toolbar { display: grid; grid-template-columns: 1fr 320px 140px 140px; gap: 12px; margin-top: 16px; align-items: center; }
    .toolbar input[type="text"], .toolbar select, .toolbar button { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; box-sizing: border-box; }
    .toolbar input[type="file"] { padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; }
    .toolbar button.action { background: var(--primary); color: #fff; border: none; cursor: pointer; }

    /* ====== 內容區：4 欄網格 ====== */
    main.gallery { margin-top: 20px; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

    /* ====== 卡片 ====== */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 2px 8px var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
    .thumb { aspect-ratio: 4 / 3; background: #f4f4f4; position: relative; display: flex; align-items: center; justify-content: center; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .meta { padding: 12px; display: grid; grid-template-rows: auto auto auto; gap: 6px; }
    .title-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .title { font-size: 15px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .time { font-size: 12px; color: var(--muted); }
    .tags { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { font-size: 11px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; color: #555; background: #fff; }
    .btn { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 13px; }
    .btn.edit { background: var(--primary); color: #fff; border: none; }

    /* 輕量狀態列 */
    .statusbar { display:flex; align-items:center; justify-content: space-between; margin: 8px 0 12px; color: var(--muted); font-size: 13px; }

    /* 空狀態 */
    .empty {
      border: 2px dashed var(--border); border-radius: 12px; padding: 24px; color: var(--muted);
      display:flex; align-items:center; justify-content:center; grid-column: 1 / -1;
      background:#fff;
    }

    /* 視窗略窄時允許 3 欄（仍屬桌機） */
    @media (max-width: 1199px) { .grid { grid-template-columns: repeat(3, 1fr); } }
  </style>
</head>
<body>
  <!-- ====== 頁首 ====== -->
  <header class="site-header">
    <div class="container">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">PA</div>
        <div>
          <h1 class="brand__title">線上相簿（Day 6）</h1>
          <p class="brand__subtitle">即時搜尋：標題／敘述／標籤／檔名</p>
        </div>
      </div>

      <div class="toolbar" role="region" aria-label="工具列">
        <input id="searchInput" type="text" placeholder="輸入關鍵字即可篩選（可輸入多個詞，以空白分隔）">
        <input id="fileInput" type="file" accept="image/*" multiple>
        <select disabled>
          <option selected>分類（Day 7 啟用）</option>
        </select>
        <select disabled>
          <option selected>排序（Day 8 啟用）</option>
        </select>
        <div style="grid-column: 1 / -1; font-size:13px; color:var(--muted);">
          提示：關鍵字會在「標題、敘述、標籤、檔名」中尋找，大小寫不敏感。例：<code>貓 咖啡</code>
        </div>
      </div>
    </div>
  </header>

  <!-- ====== 內容：搜尋 + 上傳 + 編輯 + 永續化 ====== -->
  <main class="gallery">
    <div class="container">
      <div class="statusbar">
        <div><span id="countAll">0</span> 張照片</div>
        <div>符合搜尋：<span id="countFiltered">0</span> 張</div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px;">
        <button id="clearBtn" class="btn" type="button" title="清空全部資料">清空全部</button>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </div>
  </main>

  <!-- ====== Modal：編輯圖片中繼資料 ====== -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div class="modal__header" id="modalTitle">編輯圖片資訊</div>
      <div class="modal__body">
        <div class="field">
          <label for="fTitle">標題</label>
          <input id="fTitle" type="text" placeholder="例：台北小旅行" />
        </div>
        <div class="field">
          <label for="fDesc">敘述</label>
          <textarea id="fDesc" placeholder="簡短描述這張照片...（非必填）"></textarea>
        </div>
        <div class="field">
          <label for="fTags">標籤（以逗號 , 分隔）</label>
          <input id="fTags" type="text" placeholder="例：旅遊, 朋友, 晚上" />
        </div>
      </div>
      <div class="modal__footer">
        <button id="btnCancel" class="btn secondary" type="button">取消</button>
        <button id="btnSave" class="btn primary" type="button">儲存</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container" style="border-top:1px solid var(--border); margin-top:32px; padding-top:16px; color:var(--muted); font-size:13px; text-align:center;">
      Day 6 完成：即時搜尋（標題／敘述／標籤／檔名）。
    </div>
  </footer>

  <script>
    // ============================
    // Day 6：搜尋（初學者版）
    // - 延續 Day 5 LocalStorage
    // - 延續 Day 4 編輯中繼資料
    // ============================

    const LS_KEY = 'pa_photos_v1';

    const fileInput = document.getElementById('fileInput');
    const searchInput = document.getElementById('searchInput');
    const grid = document.getElementById('grid');
    const clearBtn = document.getElementById('clearBtn');

    const countAll = document.getElementById('countAll');
    const countFiltered = document.getElementById('countFiltered');

    // Modal 元件相關
    const modalBackdrop = document.getElementById('modalBackdrop');
    const fTitle = document.getElementById('fTitle');
    const fDesc = document.getElementById('fDesc');
    const fTags = document.getElementById('fTags');
    const btnCancel = document.getElementById('btnCancel');
    const btnSave = document.getElementById('btnSave');

    /** @type {{ id:string, dataUrl:string, name:string, lastModified:number, size:number, title:string, desc:string, tags:string[] }[]} */
    let photos = [];
    let editingId = null;
    let query = '';

    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    function prettySize(bytes) {
      const units = ['B','KB','MB','GB'];
      let i = 0, num = bytes;
      while (num >= 1024 && i < units.length - 1) { num /= 1024; i++; }
      return `${num.toFixed(1)} ${units[i]}`;
    }

    function fileNameWithoutExt(name='') {
      const i = name.lastIndexOf('.');
      return i > 0 ? name.slice(0, i) : name || '未命名圖片';
    }

    function safeGetLS(key) { try { return localStorage.getItem(key); } catch (e) { console.warn('讀取 LocalStorage 失敗：', e); return null; } }
    function safeSetLS(key, val) { try { localStorage.setItem(key, val); return true; } catch (e) { alert('儲存失敗，可能超過 LocalStorage 容量。'); console.warn('寫入 LocalStorage 失敗：', e); return false; } }
    function saveToStorage() { return safeSetLS(LS_KEY, JSON.stringify(photos)); }
    function loadFromStorage() {
      const raw = safeGetLS(LS_KEY);
      if (!raw) return [];
      try { const arr = JSON.parse(raw); if (Array.isArray(arr)) return arr; } catch (e) { console.warn('解析 JSON 失敗：', e); }
      return [];
    }

    // 依查詢字串回傳過濾後的陣列（大小寫不敏感；多詞必須全部命中）
    function getFilteredPhotos() {
      const q = query.trim().toLowerCase();
      if (!q) return photos.slice();
      const tokens = q.split(/\s+/).filter(Boolean);
      return photos.filter(p => {
        const hay = [
          p.title || '',
          p.desc || '',
          (p.tags || []).join(' '),
          p.name || ''
        ].join(' ').toLowerCase();
        return tokens.every(tok => hay.includes(tok));
      });
    }

    function render() {
      const data = getFilteredPhotos();
      countAll.textContent = String(photos.length);
      countFiltered.textContent = String(data.length);

      const frag = document.createDocumentFragment();

      if (data.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = query ? '沒有符合搜尋的結果。試試其他關鍵字。' : '還沒有相片，請從上方上傳。';
        frag.appendChild(empty);
      } else {
        data.forEach(p => {
          const card = document.createElement('article');
          card.className = 'card';
          card.dataset.id = p.id;

          const thumb = document.createElement('div');
          thumb.className = 'thumb';
          const img = document.createElement('img');
          img.src = p.dataUrl;
          img.alt = p.title || p.name;
          thumb.appendChild(img);

          const meta = document.createElement('div');
          meta.className = 'meta';

          const titleRow = document.createElement('div');
          titleRow.className = 'title-row';
          const title = document.createElement('div');
          title.className = 'title';
          title.textContent = p.title || fileNameWithoutExt(p.name);

          const editBtn = document.createElement('button');
          editBtn.className = 'btn edit';
          editBtn.type = 'button';
          editBtn.textContent = '編輯';
          editBtn.addEventListener('click', () => openEditor(p.id));

          titleRow.appendChild(title);
          titleRow.appendChild(editBtn);

          const time = document.createElement('div');
          time.className = 'time';
          const dt = new Date(p.lastModified || Date.now());
          time.textContent = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}｜${prettySize(p.size||0)}`;

          const tagsWrap = document.createElement('div');
          tagsWrap.className = 'tags';
          (p.tags || []).filter(Boolean).forEach(t => {
            const chip = document.createElement('span');
            chip.className = 'tag';
            chip.textContent = t;
            tagsWrap.appendChild(chip);
          });

          meta.appendChild(titleRow);
          meta.appendChild(time);
          meta.appendChild(tagsWrap);

          card.appendChild(thumb);
          card.appendChild(meta);
          frag.appendChild(card);
        });
      }

      grid.innerHTML = '';
      grid.appendChild(frag);
    }

    // 讀取檔案為 DataURL（Promise 版）
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('讀檔失敗'));
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    // ========== 事件處理 ==========
    // 上傳檔案
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      const images = files.filter(f => f.type && f.type.startsWith('image/'));
      const nonImages = files.filter(f => !f.type || !f.type.startsWith('image/'));
      if (nonImages.length) alert('已略過非圖片檔案：\n' + nonImages.map(f => `• ${f.name}`).join('\n'));

      for (const file of images) {
        try {
          const dataUrl = await readFileAsDataURL(file);
          photos.push({
            id: uid(),
            dataUrl: String(dataUrl),
            name: file.name,
            lastModified: file.lastModified,
            size: file.size,
            title: fileNameWithoutExt(file.name),
            desc: '',
            tags: [],
          });
        } catch (err) {
          console.warn('轉換 DataURL 失敗：', err);
        }
      }

      saveToStorage();
      render();
      fileInput.value = '';
    });

    // 清空全部資料
    clearBtn.addEventListener('click', () => {
      if (!photos.length) return;
      if (confirm('確定要清空「所有已儲存」的相片與資料嗎？此動作不可回復。')) {
        photos = [];
        saveToStorage();
        render();
      }
    });

    // 搜尋輸入：即時過濾（基本版，無 debounce）
    searchInput.addEventListener('input', (e) => {
      query = e.target.value || '';
      render();
    });

    // ====== 編輯彈窗 ======
    function openEditor(id) {
      const p = photos.find(x => x.id === id);
      if (!p) return;
      editingId = id;
      fTitle.value = p.title || fileNameWithoutExt(p.name);
      fDesc.value = p.desc || '';
      fTags.value = (p.tags || []).join(', ');
      showModal(true);
      setTimeout(() => fTitle.focus(), 0);
    }

    function showModal(show) {
      modalBackdrop.style.display = show ? 'flex' : 'none';
      modalBackdrop.setAttribute('aria-hidden', show ? 'false' : 'true');
      if (!show) editingId = null;
    }

    function saveEditor() {
      const p = photos.find(x => x.id === editingId);
      if (!p) return;
      p.title = fTitle.value.trim();
      p.desc = fDesc.value.trim();
      p.tags = fTags.value.split(',').map(s => s.trim()).filter(Boolean);
      saveToStorage();
      render();
      showModal(false);
    }

    // ⚠️ 修正：避免重複宣告 btnCancel/btnSave（原本這裡又宣告一次會造成 SyntaxError）
    // 直接使用上方已取得的節點，僅綁定事件即可。
    btnCancel.addEventListener('click', () => showModal(false));
    btnSave.addEventListener('click', saveEditor);
    document.addEventListener('keydown', (ev) => {
      if (modalBackdrop.style.display === 'flex' && ev.key === 'Escape') showModal(false);
    });
    modalBackdrop.addEventListener('click', (ev) => { if (ev.target === modalBackdrop) showModal(false); });

    // ============================
    // 簡易自動化測試（不更動你的資料；僅 console 輸出）
    // ============================
    function runSelfTests() {
      console.groupCollapsed('🔎 Self-tests for Day 6');
      try {
        console.assert(btnCancel && btnSave, 'btnCancel / btnSave 應存在');
        const before = photos.length;
        const q0 = query; // 保存查詢字串
        query = '';
        const all = getFilteredPhotos();
        console.assert(all.length === before, '空白搜尋應回傳全部照片數');
        // 嘗試用已存在照片的標題測一次（若沒有照片則略過）
        if (before > 0) {
          const token = (photos[0].title || '').split(/\s+/)[0];
          if (token) {
            query = token;
            const res = getFilteredPhotos();
            console.assert(res.length >= 1, '以第一張照片的某個詞搜尋，應至少命中 1 張');
          }
        }
        query = q0; // 還原查詢字串
        console.log('✅ 自動化測試完成');
      } catch (err) {
        console.error('❌ 自動化測試失敗：', err);
      }
      console.groupEnd();
    }

    // 初始化：從 LocalStorage 載入並渲染
    (function init() {
      photos = loadFromStorage();
      render();
      runSelfTests();
      console.log('✅ Day 6：搜尋已啟用；目前照片數：', photos.length);
    })();
  </script>
</body>
</html>
