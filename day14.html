<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Day 14｜線上相簿 - 投影片播放（Slideshow）</title>
  <!--
    使用方式：
    1) 單一 HTML 檔，直接存成 index.html 開啟即可。
    2) 目標：在 Day 13（收藏/只看收藏）基礎上，新增「投影片播放」。
       - 進入方式：
         • 點任何卡片縮圖 → 從該張開始播放
         • 工具列的「播放全部」按鈕 → 從目前篩選結果第一張開始
       - 操作：上一張（← / A）、下一張（→ / D）、播放/暫停（Space）、退出（Esc）。
       - 自動播放：可選 2/3/5/8 秒；淡入淡出。
       - 內容來源：嚴格依「目前的搜尋/分類/只看收藏/排序」結果，並以當前順序播放。
    3) 延續：LocalStorage、搜尋、分類、排序、分頁（僅影響網格顯示；投影片播放使用完整篩選集合）。
  -->
  <style>
    :root { --bg:#ffffff; --text:#1f2328; --muted:#6b7280; --primary:#ff8c42; --danger:#ef4444; --border:#e5e7eb; --card:#f9fafb; --shadow:rgba(0,0,0,.06); --overlay:rgba(0,0,0,.5); --focus:#2563eb; --radius:12px; --container:1200px; --fs-xs:clamp(12px,1.1vw,13px); --fs-sm:clamp(13px,1.2vw,14px); --fs-md:clamp(14px,1.4vw,16px); --fs-lg:clamp(16px,1.6vw,18px); --fs-xl:clamp(18px,2vw,22px); --sidebar-w:260px; }
    @media (prefers-color-scheme: dark){ :root{ --bg:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --primary:#ff954f; --danger:#f87171; --border:#1f2937; --card:#0f172a; --shadow:rgba(0,0,0,.4); --overlay:rgba(0,0,0,.7); --focus:#60a5fa; } }

    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans CJK TC","Microsoft JhengHei",Helvetica,Arial,sans-serif; font-size:var(--fs-md); line-height:1.65; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }
    .container{max-width:var(--container); margin:0 auto; padding:24px; box-sizing:border-box}

    :where(a,button,input,select,textarea){outline:none}
    :where(a,button,input,select,textarea):focus-visible{box-shadow:0 0 0 3px color-mix(in srgb, var(--focus) 50%, transparent), 0 0 0 1.5px var(--focus) inset; border-radius:10px}
    button{min-height:40px}

    header.site-header{border-bottom:1px solid var(--border); background:linear-gradient(180deg,#fff,#fff7f1)}
    @media(prefers-color-scheme:dark){ header.site-header{ background:linear-gradient(180deg,#0b1220,#0b1220) } }
    .brand{display:flex; align-items:center; gap:12px}
    .brand__logo{width:44px;height:44px;border-radius:10px;background:var(--primary);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:var(--fs-lg)}
    .brand__title{margin:0;font-size:var(--fs-xl)}
    .brand__subtitle{margin:4px 0 0; color:var(--muted); font-size:var(--fs-sm)}

    .tabs{display:flex; gap:8px; margin-top:12px}
    .tab{padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:color-mix(in srgb, var(--card) 96%, var(--bg)); cursor:pointer; font-size:var(--fs-sm)}
    .tab[aria-selected="true"]{background:var(--primary); color:#fff; border-color:transparent; font-weight:700}

    .layout{ display:grid; grid-template-columns: var(--sidebar-w) 1fr; gap:16px; margin-top:16px; }
    @media (max-width: 990px){ .layout{ grid-template-columns: 1fr; } }

    .sidebar{ border:1px solid var(--border); border-radius:var(--radius); background:var(--card); padding:12px; position:sticky; top:16px; align-self:start; max-height:calc(100vh - 120px); overflow:auto }
    .sidebar h3{ margin:4px 8px 10px; font-size:var(--fs-sm); color:var(--muted); font-weight:700 }
    .cat-list{ display:flex; flex-direction:column; gap:6px }
    .cat-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-radius:10px; cursor:pointer; border:1px solid transparent; }
    .cat-item:hover{ background:color-mix(in srgb, var(--bg) 85%, #fff) }
    .cat-item.active{ background:var(--primary); color:#fff }
    .cat-item .name{ font-size:var(--fs-sm); overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .cat-item .count{ font-size:var(--fs-xs); color:inherit; opacity:.8 }

    .toolbar{ display:grid; gap:12px; align-items:center; grid-template-columns: 1fr 240px 140px 140px 140px 160px 160px; }
    @media (max-width: 1200px){ .toolbar{ grid-template-columns: 1fr 1fr 1fr; } }
    @media (max-width: 640px){ .toolbar{ grid-template-columns: 1fr; } }
    .toolbar input[type="text"], .toolbar select{ padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:color-mix(in srgb, var(--card) 96%, var(--bg)); font-size:var(--fs-sm); color:var(--text) }
    .toolbar input[type="file"]{ padding:8px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:var(--fs-sm) }
    .toolbar .toggle{ display:flex; align-items:center; gap:8px; font-size:var(--fs-sm) }

    .selectbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; background:color-mix(in srgb, var(--card) 95%, var(--bg)); border:1px dashed var(--border); border-radius:12px; padding:8px 12px; margin:8px 0; }
    .selectbar .muted{ color:var(--muted); font-size:var(--fs-sm) }
    .btn{ padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; font-size:var(--fs-sm) }
    .btn.primary{ background:var(--primary); color:#fff; border:none }
    .btn.danger{ background:var(--danger); color:#fff; border:none }

    .statusbar{ display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:var(--fs-sm); margin:8px 0 12px }

    .grid{ display:grid; gap:16px; grid-template-columns: repeat(4, 1fr) }
    @media (max-width: 1200px){ .grid{ grid-template-columns: repeat(3, 1fr) } }
    @media (max-width: 990px){ .grid{ grid-template-columns: repeat(2, 1fr) } }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr } }

    .card{ position:relative; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 2px 8px var(--shadow); overflow:hidden; display:flex; flex-direction:column }
    .thumb{ aspect-ratio: 4 / 3; background:#eef2f7; display:flex; align-items:center; justify-content:center; cursor:pointer }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block }
    .meta{ padding:12px; display:grid; gap:8px }
    .title-row{ display:flex; align-items:center; justify-content:space-between; gap:8px }
    .title{ font-size:var(--fs-md); font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .action-row{ display:flex; gap:8px; align-items:center }
    .fav-btn{ min-height:auto; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; font-size:14px; line-height:1 }
    .fav-btn[aria-pressed="true"]{ background:#ffe7df; border-color:#ffd2c3 }
    .time{ font-size:var(--fs-xs); color:var(--muted) }
    .tags{ display:flex; gap:6px; flex-wrap:wrap }
    .tag{ font-size:11px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); background:color-mix(in srgb, var(--bg) 70%, #fff) }
    .btn.edit{ background:var(--primary); color:#fff; border:none }

    .select-box{ position:absolute; top:8px; left:8px; background:rgba(255,255,255,.85); border:1px solid var(--border); border-radius:8px; padding:6px; display:flex; align-items:center; gap:6px }
    .select-box input{ width:18px; height:18px }
    .card.selected{ outline:3px solid color-mix(in srgb, var(--primary) 60%, transparent) }

    .empty{ border:2px dashed var(--border); border-radius:var(--radius); padding:24px; color:var(--muted); display:flex; align-items:center; justify-content:center; grid-column:1/-1; background:#fff0 }

    .pager{ display:flex; align-items:center; justify-content:center; gap:12px; margin-top:16px }
    .pager .btn{ background:var(--primary); color:#fff; border:none; border-radius:12px; padding:12px 18px; cursor:pointer; font-weight:700 }
    .pager .btn[disabled]{ opacity:.55; cursor:not-allowed }
    .pager .hint{ color:var(--muted); font-size:var(--fs-sm) }

    .album-card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; cursor:pointer }
    .album-card .cover{ aspect-ratio: 4/2; background:#e5e7eb; display:flex; align-items:center; justify-content:center }
    .album-card .cover img{ width:100%; height:100%; object-fit:cover }
    .album-card .info{ padding:12px; display:flex; align-items:center; justify-content:space-between }
    .album-card .name{ font-weight:700 }
    .album-card .count{ color:var(--muted); font-size:var(--fs-sm) }

    /* ====== 投影片 Overlay ====== */
    .ss-backdrop{ position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:1000 }
    .ss{ width:min(96vw,1200px); height:min(90vh,760px); background:color-mix(in srgb, var(--card) 96%, var(--bg)); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.35); display:grid; grid-template-rows:auto 1fr auto; overflow:hidden }
    .ss-header, .ss-footer{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:color-mix(in srgb, var(--bg) 85%, #fff); border-bottom:1px solid var(--border) }
    .ss-footer{ border-top:1px solid var(--border); border-bottom:none }
    .ss-title{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .ss-stage{ position:relative; background:#0b0f19; display:flex; align-items:center; justify-content:center }
    .ss-img{ max-width:100%; max-height:100%; opacity:0; transition:opacity .35s ease }
    .ss-img.show{ opacity:1 }
    .ss-ctrl{ display:flex; align-items:center; gap:8px }
    .icon-btn{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer }
    .icon-btn.primary{ background:var(--primary); color:#fff; border:none }
    .ss-counter{ color:var(--muted); font-size:var(--fs-sm) }
    .ss-nav{ position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none }
    .ss-nav button{ pointer-events:all; background:rgba(255,255,255,.75); border:1px solid var(--border); border-radius:999px; width:44px; height:44px; display:grid; place-items:center; cursor:pointer }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">PA</</div>
        <div>
          <h1 class="brand__title">線上相簿（Day 14）</h1>
          <p class="brand__subtitle">投影片播放（Slideshow）：全螢幕 Overlay、鍵盤控制、自動播放</p>
        </div>
      </div>
      <div class="tabs" role="tablist" aria-label="視圖切換">
        <button id="tabAll" class="tab" role="tab" aria-selected="true" aria-controls="viewAll">所有相片</button>
        <button id="tabAlbums" class="tab" role="tab" aria-selected="false" aria-controls="viewAlbums">分類總覽</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="viewAll" role="tabpanel" aria-labelledby="tabAll">
      <div class="layout">
        <aside class="sidebar" aria-label="分類">
          <h3>分類</h3>
          <div id="catList" class="cat-list"></div>
        </aside>
        <section>
          <div class="toolbar" role="region" aria-label="工具列">
            <input id="searchInput" type="text" placeholder="搜尋關鍵字（標題／敘述／標籤／檔名）" aria-label="搜尋">
            <input id="fileInput" type="file" accept="image/*" multiple aria-label="上傳圖片">
            <select id="sortBy" aria-label="排序依據">
              <option value="time" selected>依時間</option>
              <option value="title">依標題</option>
            </select>
            <select id="sortOrder" aria-label="升冪或降冪">
              <option value="desc" selected>降冪</option>
              <option value="asc">升冪</option>
            </select>
            <select id="pageSize" aria-label="每頁筆數">
              <option value="8">每頁 8 張</option>
              <option value="12" selected>每頁 12 張</option>
              <option value="16">每頁 16 張</option>
              <option value="24">每頁 24 張</option>
            </select>
            <label class="toggle" for="onlyFav">
              <input id="onlyFav" type="checkbox" /> 只看收藏
            </label>
            <div class="ss-ctrl">
              <button id="btnPlayAll" class="btn primary" type="button">播放全部（依目前篩選）</button>
              <label class="toggle" for="playInterval">間隔
                <select id="playInterval" aria-label="自動播放間隔">
                  <option value="2000">2 秒</option>
                  <option value="3000" selected>3 秒</option>
                  <option value="5000">5 秒</option>
                  <option value="8000">8 秒</option>
                </select>
              </label>
            </div>
            <div style="grid-column: 1 / -1; font-size: var(--fs-sm); color:var(--muted);">提示：點縮圖可從該張開始播放；投影片內容將以目前的搜尋/分類/只看收藏/排序為主。</div>
          </div>

          <div class="statusbar" aria-live="polite">
            <div><span id="countAll">0</span> 張照片</div>
            <div>目前分類：<strong id="currentCatLabel">全部</strong>｜已顯示：<span id="countShown">0</span>／符合：<span id="countFiltered">0</span></div>
          </div>

          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <button id="btnToggleSelect" class="btn" type="button">進入選取模式</button>
          </div>

          <div id="grid" class="grid" aria-live="polite"></div>
          <div class="pager">
            <button id="loadMoreBtn" class="btn" type="button">載入更多</button>
            <span class="hint" id="pagerHint"></span>
          </div>
        </section>
      </div>
    </section>

    <section id="viewAlbums" role="tabpanel" aria-labelledby="tabAlbums" hidden>
      <div class="statusbar" style="margin-top:12px">
        <div>分類總覽</div>
        <div id="albumCountHint" class="muted"></div>
      </div>
      <div id="albumGrid" class="grid"></div>
    </section>
  </main>

  <!-- 投影片 Overlay -->
  <div id="ssBackdrop" class="ss-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="ss" role="document" aria-labelledby="ssTitle">
      <div class="ss-header">
        <div class="ss-title" id="ssTitle">—</div>
        <div class="ss-ctrl">
          <button id="ssPrev" class="icon-btn" aria-label="上一張">←</button>
          <button id="ssNext" class="icon-btn" aria-label="下一張">→</button>
          <button id="ssPlay" class="icon-btn primary" aria-label="播放/暫停">播放</button>
          <span class="ss-counter" id="ssCounter">0 / 0</span>
          <button id="ssClose" class="icon-btn" aria-label="關閉（Esc）">✕</button>
        </div>
      </div>
      <div class="ss-stage">
        <img id="ssImg" class="ss-img" alt="slideshow image" />
        <div class="ss-nav">
          <button id="ssNavPrev" aria-label="上一張">⟨</button>
          <button id="ssNavNext" aria-label="下一張">⟩</button>
        </div>
      </div>
      <div class="ss-footer">
        <div id="ssMeta" style="font-size:var(--fs-sm); color:var(--muted)">—</div>
        <div style="display:flex; align-items:center; gap:8px">
          <label for="ssSpeed">速度
            <select id="ssSpeed">
              <option value="2000">2s</option>
              <option value="3000" selected>3s</option>
              <option value="5000">5s</option>
              <option value="8000">8s</option>
            </select>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯圖片資訊 Modal（沿用） -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true" style="display:none">
    <div class="modal" role="document" aria-labelledby="modalTitle" style="max-width:680px; background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:12px">
      <div class="modal__header" id="modalTitle" style="font-weight:700; margin-bottom:8px">編輯圖片資訊</div>
      <div class="modal__body" style="display:grid; gap:8px">
        <div class="field"><label for="fTitle">標題</label><input id="fTitle" type="text" placeholder="例：台北小旅行" /></div>
        <div class="field"><label for="fDesc">敘述</label><textarea id="fDesc" placeholder="簡短描述這張照片...（非必填）"></textarea></div>
        <div class="field"><label for="fTags">標籤（以逗號 , 分隔）</label><input id="fTags" type="text" placeholder="例：旅遊, 朋友, 晚上" /></div>
        <div class="field"><label for="fCategory">分類</label><input id="fCategory" list="catData" type="text" placeholder="例：旅遊 / 生活 / 寵物" /><datalist id="catData"></datalist></div>
      </div>
      <div class="modal__footer" style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end">
        <button id="btnCancel" class="btn" type="button">取消</button>
        <button id="btnSave" class="btn primary" type="button">儲存</button>
      </div>
    </div>
  </div>

  <footer class="container" style="border-top:1px solid var(--border); margin-top:24px; padding-top:16px; color:var(--muted); font-size: var(--fs-sm); text-align:center;">
    Day 14：投影片播放。支援鍵盤 ←/→、Space 播放/暫停、Esc 退出；內容依目前篩選集合。
  </footer>

  <script>
    // ============================
    // Day 14：投影片播放（在 Day 13 基礎上）
    // ============================
    const LS_KEY = 'pa_photos_v1';
    const DEFAULT_CAT = '未分類';

    // Tabs
    const tabAll = document.getElementById('tabAll');
    const tabAlbums = document.getElementById('tabAlbums');
    const viewAll = document.getElementById('viewAll');
    const viewAlbums = document.getElementById('viewAlbums');

    // 側邊分類
    const catListEl = document.getElementById('catList');
    const currentCatLabel = document.getElementById('currentCatLabel');

    // 工具列
    const fileInput = document.getElementById('fileInput');
    const searchInput = document.getElementById('searchInput');
    const sortBySelect = document.getElementById('sortBy');
    const sortOrderSelect = document.getElementById('sortOrder');
    const pageSizeSelect = document.getElementById('pageSize');
    const onlyFavCheckbox = document.getElementById('onlyFav');
    const btnPlayAll = document.getElementById('btnPlayAll');
    const playIntervalSel = document.getElementById('playInterval');

    // 內容/分頁
    const grid = document.getElementById('grid');
    const albumGrid = document.getElementById('albumGrid');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const pagerHint = document.getElementById('pagerHint');
    const countAll = document.getElementById('countAll');
    const countFiltered = document.getElementById('countFiltered');
    const countShown = document.getElementById('countShown');
    const albumCountHint = document.getElementById('albumCountHint');

    // 選取模式（承 Day 12）
    const btnToggleSelect = document.getElementById('btnToggleSelect');
    const selectBar = document.getElementById('selectBar');
    let btnSelectAll, btnSelectNone, btnDeleteSel, selCountEl; // 這些元素在 Day 14 的 UI 中省略選取列；保留變數以相容舊程式碼（若後續擴充可加入）

    // Modal
    const modalBackdrop = document.getElementById('modalBackdrop');
    const fTitle = document.getElementById('fTitle');
    const fDesc = document.getElementById('fDesc');
    const fTags = document.getElementById('fTags');
    const fCategory = document.getElementById('fCategory');
    const catData = document.getElementById('catData');
    const btnCancel = document.getElementById('btnCancel');
    const btnSave = document.getElementById('btnSave');

    // 投影片元素
    const ssBackdrop = document.getElementById('ssBackdrop');
    const ssImg = document.getElementById('ssImg');
    const ssTitle = document.getElementById('ssTitle');
    const ssMeta = document.getElementById('ssMeta');
    const ssCounter = document.getElementById('ssCounter');
    const ssClose = document.getElementById('ssClose');
    const ssPrev = document.getElementById('ssPrev');
    const ssNext = document.getElementById('ssNext');
    const ssNavPrev = document.getElementById('ssNavPrev');
    const ssNavNext = document.getElementById('ssNavNext');
    const ssSpeed = document.getElementById('ssSpeed');
    const ssPlay = document.getElementById('ssPlay');

    /** @type {{ id:string, dataUrl:string, name:string, lastModified:number, size:number, title:string, desc:string, tags:string[], category?:string, favorite?:boolean }[]} */
    let photos = [];
    let editingId = null;
    let query = '';
    let sortBy = 'time';
    let sortOrder = 'desc';
    let pageSize = 12;
    let visibleCount = pageSize;
    let currentCategory = '全部';
    let onlyFav = false;

    // Slideshow 狀態
    let ssIds = [];       // 依目前篩選排序的照片 id 陣列
    let ssIndex = 0;      // 目前索引
    let playing = false;  // 是否自動播放
    let timer = null;     // setInterval 句柄

    function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
    function prettySize(bytes){const u=['B','KB','MB','GB'];let i=0,n=bytes;while(n>=1024&&i<u.length-1){n/=1024;i++}return `${n.toFixed(1)} ${u[i]}`}
    function fileNameWithoutExt(name=''){const i=name.lastIndexOf('.');return i>0?name.slice(0,i):name||'未命名圖片'}

    function safeGetLS(key){try{return localStorage.getItem(key)}catch(e){console.warn('讀取 LS 失敗',e);return null}}
    function safeSetLS(key,val){try{localStorage.setItem(key,val);return true}catch(e){alert('儲存失敗，可能超過 LocalStorage 容量。');console.warn('寫入 LS 失敗',e);return false}}
    function saveToStorage(){return safeSetLS(LS_KEY, JSON.stringify(photos))}
    function loadFromStorage(){const raw=safeGetLS(LS_KEY);if(!raw) return [];try{const arr=JSON.parse(raw);if(Array.isArray(arr))return arr}catch(e){console.warn('解析 JSON 失敗',e)}return []}

    function allCategories(){ const set=new Set(); photos.forEach(p=>set.add((p.category&&p.category.trim())||DEFAULT_CAT)); set.add(DEFAULT_CAT); return Array.from(set).sort((a,b)=>a.localeCompare(b)); }
    function countByCategory(){ const map=new Map(); photos.forEach(p=>{ const c=(p.category&&p.category.trim())||DEFAULT_CAT; map.set(c, (map.get(c)||0)+1); }); return map; }

    function buildSidebar(){
      const counts = countByCategory();
      catListEl.innerHTML='';
      const total = photos.length;
      const allItem = makeCatItem('全部', total, currentCategory==='全部');
      catListEl.appendChild(allItem);
      allCategories().forEach(cat=>{
        const item = makeCatItem(cat, counts.get(cat)||0, currentCategory===cat);
        catListEl.appendChild(item);
      });
    }

    function makeCatItem(name,count,active){
      const el=document.createElement('div'); el.className='cat-item'+(active?' active':''); el.role='button'; el.tabIndex=0;
      const left=document.createElement('div'); left.className='name'; left.textContent=name;
      const right=document.createElement('div'); right.className='count'; right.textContent=String(count);
      el.appendChild(left); el.appendChild(right);
      const pick=()=>{ currentCategory=name; currentCatLabel.textContent=name; visibleCount=pageSize; render(); buildSidebar(); };
      el.addEventListener('click', pick);
      el.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); pick(); } });
      return el;
    }

    function buildCatDatalist(){ catData.innerHTML=''; allCategories().forEach(c=>{ const opt=document.createElement('option'); opt.value=c; catData.appendChild(opt); }); }

    function baseFilter(list){
      const q=(query||'').trim().toLowerCase();
      const tokens=q?q.split(/\s+/).filter(Boolean):[];
      return list.filter(p=>{
        const cat=(p.category&&p.category.trim())||DEFAULT_CAT;
        if(currentCategory!=='全部' && cat!==currentCategory) return false;
        if(onlyFav && !p.favorite) return false;
        if(!tokens.length) return true;
        const hay=[p.title||'',p.desc||'',(p.tags||[]).join(' '),p.name||''].join(' ').toLowerCase();
        return tokens.every(tok=>hay.includes(tok));
      });
    }
    function sortPhotos(list){
      const arr=list.slice(); const order=sortOrder==='asc'?1:-1;
      if(sortBy==='time'){
        arr.sort((a,b)=>{const t1=Number(a.lastModified||0),t2=Number(b.lastModified||0); return (t1===t2?0:(t1>t2?1:-1))*order; });
      }else{
        arr.sort((a,b)=>{const s1=(a.title||fileNameWithoutExt(a.name)).toLowerCase(); const s2=(b.title||fileNameWithoutExt(b.name)).toLowerCase(); if(s1===s2) return 0; return (s1>s2?1:-1)*order; });
      }
      return arr;
    }
    function getFilteredSorted(){ return sortPhotos(baseFilter(photos)); }
    function getVisibleData(){ return getFilteredSorted().slice(0, visibleCount); }

    function updatePagerUI(total){
      const shown = Math.min(visibleCount, total);
      countAll.textContent = String(photos.length);
      countFiltered.textContent = String(total);
      countShown.textContent = String(shown);
      const hasMore = shown < total;
      loadMoreBtn.disabled = !hasMore;
      pagerHint.textContent = hasMore ? `尚有 ${total - shown} 張未顯示` : (total===0 ? '沒有符合的相片' : '已顯示全部');
    }

    function toggleFavorite(id){
      const p = photos.find(x=>x.id===id); if(!p) return;
      p.favorite = !p.favorite;
      saveToStorage();
      render();
    }

    function render(){
      const data = getVisibleData();
      const total = getFilteredSorted().length;
      updatePagerUI(total);

      const frag=document.createDocumentFragment();
      if(data.length===0){
        const empty=document.createElement('div'); empty.className='empty';
        empty.textContent = (photos.length===0) ? '還沒有相片，請先上傳。' : '沒有符合目前條件的結果。';
        frag.appendChild(empty);
      }else{
        data.forEach(p=>{
          const card=document.createElement('article'); card.className='card'; card.dataset.id=p.id;
          const thumb=document.createElement('div'); thumb.className='thumb';
          const img=document.createElement('img'); img.src=p.dataUrl; img.alt=p.title||p.name; thumb.appendChild(img);
          thumb.addEventListener('click', ()=>startSlideshowFrom(p.id));

          const meta=document.createElement('div'); meta.className='meta';
          const titleRow=document.createElement('div'); titleRow.className='title-row';
          const title=document.createElement('div'); title.className='title'; title.textContent=p.title||fileNameWithoutExt(p.name);

          const actions=document.createElement('div'); actions.className='action-row';
          const favBtn=document.createElement('button'); favBtn.className='fav-btn'; favBtn.type='button'; favBtn.setAttribute('aria-label', p.favorite? '取消收藏' : '加入收藏'); favBtn.setAttribute('aria-pressed', String(!!p.favorite));
          favBtn.textContent = p.favorite ? '♥ 已收藏' : '♡ 收藏';
          favBtn.addEventListener('click',()=>toggleFavorite(p.id));

          const editBtn=document.createElement('button'); editBtn.className='btn edit'; editBtn.type='button'; editBtn.textContent='編輯'; editBtn.addEventListener('click',()=>openEditor(p.id));
          actions.appendChild(favBtn); actions.appendChild(editBtn);

          titleRow.appendChild(title); titleRow.appendChild(actions);

          const time=document.createElement('div'); time.className='time'; const dt=new Date(p.lastModified||Date.now()); const cat=(p.category&&p.category.trim())||DEFAULT_CAT;
          time.textContent=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}｜${prettySize(p.size||0)}｜分類：${cat}`;
          const tagsWrap=document.createElement('div'); tagsWrap.className='tags'; (p.tags||[]).filter(Boolean).forEach(t=>{const chip=document.createElement('span'); chip.className='tag'; chip.textContent=t; tagsWrap.appendChild(chip)});
          meta.appendChild(titleRow); meta.appendChild(time); meta.appendChild(tagsWrap);

          card.appendChild(thumb); card.appendChild(meta); frag.appendChild(card);
        })
      }
      grid.innerHTML=''; grid.appendChild(frag);
    }

    function renderAlbumOverview(){
      const cats = allCategories();
      const byCat = new Map();
      photos.forEach(p=>{ const c=(p.category&&p.category.trim())||DEFAULT_CAT; if(!byCat.has(c)) byCat.set(c, []); byCat.get(c).push(p); });
      albumGrid.innerHTML='';
      const frag=document.createDocumentFragment();
      cats.forEach(cat=>{
        const arr = byCat.get(cat)||[];
        const cover = arr[0];
        const card=document.createElement('article'); card.className='album-card'; card.tabIndex=0;
        const cov=document.createElement('div'); cov.className='cover';
        if(cover){ const img=document.createElement('img'); img.src=cover.dataUrl; img.alt=cat; cov.appendChild(img); }
        else{ cov.textContent = '（無封面）'; }
        const info=document.createElement('div'); info.className='info';
        const name=document.createElement('div'); name.className='name'; name.textContent=cat;
        const count=document.createElement('div'); count.className='count'; count.textContent=`${arr.length} 張`;
        info.appendChild(name); info.appendChild(count);
        card.appendChild(cov); card.appendChild(info);
        const pick=()=>{ switchToTab('all'); currentCategory=cat; currentCatLabel.textContent=cat; visibleCount=pageSize; render(); buildSidebar(); }
        card.addEventListener('click', pick);
        card.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); pick(); } });
        frag.appendChild(card);
      });
      albumGrid.appendChild(frag);
      albumCountHint.textContent = `共 ${cats.length} 個分類`;
    }

    function readFileAsDataURL(file){return new Promise((resolve,reject)=>{const r=new FileReader(); r.onerror=()=>reject(new Error('讀檔失敗')); r.onload=()=>resolve(r.result); r.readAsDataURL(file); })}

    function openEditor(id){ const p=photos.find(x=>x.id===id); if(!p) return; editingId=id; fTitle.value=p.title||fileNameWithoutExt(p.name); fDesc.value=p.desc||''; fTags.value=(p.tags||[]).join(', '); fCategory.value=(p.category&&p.category.trim())||DEFAULT_CAT; showModal(true); setTimeout(()=>fTitle.focus(),0) }
    function showModal(show){ modalBackdrop.style.display=show?'flex':'none'; modalBackdrop.setAttribute('aria-hidden',show?'false':'true'); if(!show) editingId=null }
    function saveEditor(){ const p=photos.find(x=>x.id===editingId); if(!p) return; p.title=fTitle.value.trim(); p.desc=fDesc.value.trim(); p.tags=fTags.value.split(',').map(s=>s.trim()).filter(Boolean); p.category=(fCategory.value||'').trim()||DEFAULT_CAT; saveToStorage(); buildSidebar(); buildCatDatalist(); render(); showModal(false) }

    function switchToTab(which){
      const toAll = which==='all';
      tabAll.setAttribute('aria-selected', String(toAll));
      tabAlbums.setAttribute('aria-selected', String(!toAll));
      viewAll.hidden = !toAll; viewAlbums.hidden = toAll;
      if(!toAll){ renderAlbumOverview(); }
    }

    // ===== Slideshow functions =====
    function buildSlideshowIds(){ ssIds = getFilteredSorted().map(p=>p.id); }
    function updateSsHeader(){ ssCounter.textContent = `${ssIds.length? (ssIndex+1):0} / ${ssIds.length}`; }
    function showSlide(index){
      if(!ssIds.length){ return; }
      ssIndex = (index + ssIds.length) % ssIds.length;
      const p = photos.find(x=>x.id===ssIds[ssIndex]);
      if(!p){ return; }
      ssImg.classList.remove('show'); // 為了淡入
      ssImg.src = p.dataUrl;
      ssImg.onload = ()=> ssImg.classList.add('show');
      ssTitle.textContent = p.title || fileNameWithoutExt(p.name);
      const dt=new Date(p.lastModified||Date.now());
      const time=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      const cat=(p.category&&p.category.trim())||DEFAULT_CAT;
      ssMeta.textContent = `${time}｜${prettySize(p.size||0)}｜分類：${cat}`;
      updateSsHeader();
    }
    function openSlideshow(){
      if(!ssIds.length){ alert('目前條件下沒有可播放的相片'); return; }
      ssBackdrop.style.display='flex';
      ssBackdrop.setAttribute('aria-hidden','false');
      document.documentElement.style.overflow='hidden';
      ssImg.focus?.();
    }
    function closeSlideshow(){
      pause();
      ssBackdrop.style.display='none';
      ssBackdrop.setAttribute('aria-hidden','true');
      document.documentElement.style.overflow='';
    }
    function play(){ if(playing||!ssIds.length) return; playing=true; ssPlay.textContent='暫停'; const interval=Number(ssSpeed.value||3000); timer=setInterval(()=>next(),interval); }
    function pause(){ playing=false; ssPlay.textContent='播放'; if(timer){ clearInterval(timer); timer=null; } }
    function togglePlay(){ playing? pause() : play(); }
    function next(){ if(!ssIds.length) return; showSlide(ssIndex+1); }
    function prev(){ if(!ssIds.length) return; showSlide(ssIndex-1); }

    function startSlideshowFrom(id){ buildSlideshowIds(); if(!ssIds.length) { alert('沒有可播放的相片'); return; } const idx=ssIds.indexOf(id); ssIndex = idx>=0? idx : 0; showSlide(ssIndex); openSlideshow(); }

    // ===== 事件 =====
    fileInput.addEventListener('change', async (e)=>{
      const files=Array.from(e.target.files||[]); if(!files.length) return;
      const images=files.filter(f=>f.type&&f.type.startsWith('image/'));
      const nonImages=files.filter(f=>!f.type||!f.type.startsWith('image/'));
      if(nonImages.length) alert('已略過非圖片檔案：\n'+nonImages.map(f=>'• '+f.name).join('\n'));
      for(const file of images){
        try{ const dataUrl=await readFileAsDataURL(file);
          photos.push({ id:uid(), dataUrl:String(dataUrl), name:file.name, lastModified:file.lastModified, size:file.size, title:fileNameWithoutExt(file.name), desc:'', tags:[], category:DEFAULT_CAT, favorite:false });
        }catch(err){ console.warn('轉換 DataURL 失敗：',err) }
      }
      saveToStorage(); buildSidebar(); buildCatDatalist(); visibleCount=pageSize; render(); fileInput.value='';
    });

    searchInput.addEventListener('input', e=>{ query=e.target.value||''; visibleCount=pageSize; render(); });
    sortBySelect.addEventListener('change', e=>{ sortBy=e.target.value; visibleCount=pageSize; render(); });
    sortOrderSelect.addEventListener('change', e=>{ sortOrder=e.target.value; visibleCount=pageSize; render(); });
    pageSizeSelect.addEventListener('change', e=>{ pageSize=Number(e.target.value)||12; visibleCount=pageSize; render(); });
    onlyFavCheckbox.addEventListener('change', e=>{ onlyFav = e.target.checked; visibleCount=pageSize; render(); });
    loadMoreBtn.addEventListener('click', ()=>{ const total=getFilteredSorted().length; visibleCount=Math.min(visibleCount+pageSize,total); render(); });

    // 播放控制
    btnPlayAll.addEventListener('click', ()=>{ buildSlideshowIds(); ssIndex=0; showSlide(0); openSlideshow(); if(playIntervalSel) ssSpeed.value = playIntervalSel.value; });
    ssClose.addEventListener('click', closeSlideshow);
    ssPrev.addEventListener('click', ()=>{ pause(); prev(); });
    ssNext.addEventListener('click', ()=>{ pause(); next(); });
    ssNavPrev.addEventListener('click', ()=>{ pause(); prev(); });
    ssNavNext.addEventListener('click', ()=>{ pause(); next(); });
    ssPlay.addEventListener('click', togglePlay);
    ssSpeed.addEventListener('change', ()=>{ if(playing){ pause(); play(); } });

    // 鍵盤控制
    document.addEventListener('keydown', (e)=>{
      const isOpen = ssBackdrop.style.display==='flex';
      if(!isOpen) return;
      if(e.key==='Escape'){ e.preventDefault(); closeSlideshow(); }
      else if(e.key==='ArrowRight' || e.key.toLowerCase()==='d'){ e.preventDefault(); pause(); next(); }
      else if(e.key==='ArrowLeft'  || e.key.toLowerCase()==='a'){ e.preventDefault(); pause(); prev(); }
      else if(e.key===' '){ e.preventDefault(); togglePlay(); }
    });

    tabAll.addEventListener('click', ()=>switchToTab('all'));
    tabAlbums.addEventListener('click', ()=>switchToTab('albums'));

    // Modal 事件
    btnCancel.addEventListener('click',()=>showModal(false));
    btnSave.addEventListener('click',saveEditor);
    modalBackdrop.addEventListener('click',ev=>{ if(ev.target===modalBackdrop) showModal(false) });
    document.addEventListener('keydown',ev=>{ if(modalBackdrop.style.display==='flex' && ev.key==='Escape') showModal(false) });

    // ============================
    // 自我測試（console）：播放序列、循環、速度切換
    // ============================
    function runSelfTests(){
      console.groupCollapsed('🔎 Self-tests for Day 14');
      try{
        const prev = photos.slice();
        photos = [
          {id:'1',name:'a.jpg',title:'A',lastModified:1000,dataUrl:'data:image/gif;base64,R0lGODlhAQABAAAAACw=',size:1,desc:'',tags:['aa'],category:'旅行',favorite:true},
          {id:'2',name:'b.jpg',title:'B',lastModified:2000,dataUrl:'data:image/gif;base64,R0lGODlhAQABAAAAACw=',size:1,desc:'',tags:['bb'],category:'生活',favorite:false},
          {id:'3',name:'c.jpg',title:'C',lastModified:1500,dataUrl:'data:image/gif;base64,R0lGODlhAQABAAAAACw=',size:1,desc:'',tags:['cc'],category:'旅行',favorite:false}
        ];
        // 排序：time desc 預設
        const list = getFilteredSorted();
        console.assert(list.map(p=>p.id).join(',')==='2,3,1','排序應為 2,3,1');
        // 只看收藏
        onlyFav = true; const listFav = getFilteredSorted(); console.assert(listFav.length===1 && listFav[0].id==='1','只看收藏應僅剩 id=1');
        // Slideshow ids 構建（恢復 onlyFav=false）
        onlyFav = false; buildSlideshowIds(); console.assert(ssIds.length===3,'ssIds 應長度 3');
        // 循環索引
        ssIds = ['x','y','z']; ssIndex=0; const idxs=[]; for(let i=0;i<5;i++){ ssIndex=(ssIndex+1)%ssIds.length; idxs.push(ssIndex); } console.assert(idxs.join(',')==='1,2,0,1,2','循環索引檢查');
        // 速度切換不應崩潰
        ssSpeed.value='2000'; play(); pause();
        photos = prev; console.log('✅ 自我測試通過');
      }catch(err){ console.error('❌ 自我測試失敗', err); }
      console.groupEnd();
    }

    // 初始化
    (function init(){
      photos = loadFromStorage();
      let patched=false; photos.forEach(p=>{ if(!('category' in p)) { p.category=DEFAULT_CAT; patched=true; } if(!('favorite' in p)) { p.favorite=false; patched=true; } }); if(patched) saveToStorage();
      sortBy = sortBySelect.value; sortOrder = sortOrderSelect.value; pageSize = Number(pageSizeSelect.value)||12; visibleCount = pageSize; currentCategory='全部'; currentCatLabel.textContent='全部';
      onlyFavCheckbox.checked = onlyFav;
      buildSidebar(); buildCatDatalist(); render();
      runSelfTests();
      console.log('✅ Day 14：Slideshow 啟用，照片數：', photos.length);
    })();
  </script>
</body>
</html>
