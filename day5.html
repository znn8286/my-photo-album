<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Day 5｜線上相簿 - LocalStorage 永續化（桌機）</title>
  <!--
    使用方式：
    1) 單一 HTML 檔，直接存成 index.html，用瀏覽器開啟即可。
    2) 今日目標：把 Day 4 的資料「存進 LocalStorage」，重整後不會消失。
    3) 注意：LocalStorage 容量有限（約 5MB）。若要大量相片，未來需改 IndexedDB 或後端。
  -->
  <style>
    :root {
      --bg: #ffffff;
      --text: #2b2b2b;
      --muted: #6b6b6b;
      --primary: #ff8c42;
      --border: #e6e6e6;
      --card: #fafafa;
      --shadow: rgba(0,0,0,0.06);
      --overlay: rgba(0,0,0,0.5);
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; box-sizing: border-box; }

    /* ====== 頁首 ====== */
    header.site-header { border-bottom: 1px solid var(--border); background: linear-gradient(180deg, #fff, #fff6f0); }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand__logo { width: 40px; height: 40px; border-radius: 10px; background: var(--primary); display: inline-flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; }
    .brand__title { margin: 0; font-size: 22px; }
    .brand__subtitle { margin: 4px 0 0; color: var(--muted); font-size: 14px; }

    /* ====== 工具列 ====== */
    .toolbar { display: grid; grid-template-columns: 1fr 320px 140px 140px; gap: 12px; margin-top: 16px; align-items: center; }
    .toolbar input[type="text"], .toolbar select, .toolbar button { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; box-sizing: border-box; }
    .toolbar input[type="file"] { padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; }
    .toolbar button.action { background: var(--primary); color: #fff; border: none; cursor: pointer; }
    .toolbar *[disabled] { opacity: .6; cursor: not-allowed; }

    /* ====== 內容區：4 欄網格 ====== */
    main.gallery { margin-top: 20px; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

    /* ====== 卡片 ====== */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 2px 8px var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
    .thumb { aspect-ratio: 4 / 3; background: #f4f4f4; position: relative; display: flex; align-items: center; justify-content: center; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .meta { padding: 12px; display: grid; grid-template-rows: auto auto auto; gap: 6px; }
    .title-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .title { font-size: 15px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .time { font-size: 12px; color: var(--muted); }
    .tags { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { font-size: 11px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; color: #555; background: #fff; }
    .btn { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 13px; }
    .btn.edit { background: var(--primary); color: #fff; border: none; }

    /* ====== Modal（編輯表單） ====== */
    .modal-backdrop { position: fixed; inset: 0; background: var(--overlay); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal { width: 560px; max-width: calc(100% - 40px); background: #fff; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,.15); overflow: hidden; }
    .modal__header { padding: 14px 16px; border-bottom: 1px solid var(--border); font-weight: 700; }
    .modal__body { padding: 16px; display: grid; gap: 12px; }
    .modal__footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
    .field { display: grid; gap: 6px; }
    .field label { font-size: 13px; color: #444; }
    .field input[type="text"], .field textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    .field textarea { resize: vertical; min-height: 80px; }

    .btn.secondary { background: #fff; }
    .btn.primary { background: var(--primary); color: #fff; border: none; }

    /* 視窗略窄時允許 3 欄 */
    @media (max-width: 1199px) { .grid { grid-template-columns: repeat(3, 1fr); } }
  </style>
</head>
<body>
  <!-- ====== 頁首 ====== -->
  <header class="site-header">
    <div class="container">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">PA</div>
        <div>
          <h1 class="brand__title">線上相簿（Day 5）</h1>
          <p class="brand__subtitle">LocalStorage 永續化：重整不遺失</p>
        </div>
      </div>

      <div class="toolbar" role="region" aria-label="工具列">
        <input id="searchInput" type="text" placeholder="搜尋（Day 6 啟用）" disabled>
        <input id="fileInput" type="file" accept="image/*" multiple>
        <select disabled>
          <option selected>分類（Day 7 啟用）</option>
        </select>
        <select disabled>
          <option selected>排序（Day 8 啟用）</option>
        </select>
        <div style="grid-column: 1 / -1; font-size:13px; color:var(--muted);">
          小提醒：為了示範簡單，今日將圖片以 <b>DataURL</b> 形式存入 LocalStorage（容量有限）。
        </div>
      </div>
    </div>
  </header>

  <!-- ====== 內容：上傳 + 編輯 + 永續化 ====== -->
  <main class="gallery">
    <div class="container">
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px;">
        <button id="clearBtn" class="btn" type="button" title="清空全部資料">清空全部</button>
        <button id="saveBtn" class="btn" type="button" title="手動儲存（通常自動）">手動儲存</button>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </div>
  </main>

  <!-- ====== Modal：編輯圖片中繼資料 ====== -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div class="modal__header" id="modalTitle">編輯圖片資訊</div>
      <div class="modal__body">
        <div class="field">
          <label for="fTitle">標題</label>
          <input id="fTitle" type="text" placeholder="例：台北小旅行" />
        </div>
        <div class="field">
          <label for="fDesc">敘述</label>
          <textarea id="fDesc" placeholder="簡短描述這張照片...（非必填）"></textarea>
        </div>
        <div class="field">
          <label for="fTags">標籤（以逗號 , 分隔）</label>
          <input id="fTags" type="text" placeholder="例：旅遊, 朋友, 晚上" />
        </div>
      </div>
      <div class="modal__footer">
        <button id="btnCancel" class="btn secondary" type="button">取消</button>
        <button id="btnSave" class="btn primary" type="button">儲存</button>
      </div>
    </div>
  </div>

  <!-- ====== 頁尾 ====== -->
  <footer class="site-footer">
    <div class="container" style="border-top:1px solid var(--border); margin-top:32px; padding-top:16px; color:var(--muted); font-size:13px; text-align:center;">
      Day 5 完成：LocalStorage 永續化。重整後仍能看到你的相片與中繼資料。
    </div>
  </footer>

  <script>
    // ============================
    // Day 5：LocalStorage 永續化（初學者版）
    // ============================

    const LS_KEY = 'pa_photos_v1';

    const fileInput = document.getElementById('fileInput');
    const grid = document.getElementById('grid');
    const clearBtn = document.getElementById('clearBtn');
    const saveBtn = document.getElementById('saveBtn');

    // Modal 元件相關
    const modalBackdrop = document.getElementById('modalBackdrop');
    const fTitle = document.getElementById('fTitle');
    const fDesc = document.getElementById('fDesc');
    const fTags = document.getElementById('fTags');
    const btnCancel = document.getElementById('btnCancel');
    const btnSave = document.getElementById('btnSave');

    /** @type {{ id:string, dataUrl:string, name:string, lastModified:number, size:number, title:string, desc:string, tags:string[] }[]} */
    let photos = [];
    let editingId = null;

    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    function prettySize(bytes) {
      const units = ['B','KB','MB','GB'];
      let i = 0, num = bytes;
      while (num >= 1024 && i < units.length - 1) { num /= 1024; i++; }
      return `${num.toFixed(1)} ${units[i]}`;
    }

    function fileNameWithoutExt(name='') {
      const i = name.lastIndexOf('.');
      return i > 0 ? name.slice(0, i) : name || '未命名圖片';
    }

    function safeGetLS(key) {
      try { return localStorage.getItem(key); } catch (e) { console.warn('讀取 LocalStorage 失敗：', e); return null; }
    }
    function safeSetLS(key, val) {
      try { localStorage.setItem(key, val); return true; } catch (e) { alert('儲存失敗，可能超過 LocalStorage 容量。\n請刪除部分相片或改用較小圖片。'); console.warn('寫入 LocalStorage 失敗：', e); return false; }
    }
    function saveToStorage() { return safeSetLS(LS_KEY, JSON.stringify(photos)); }
    function loadFromStorage() {
      const raw = safeGetLS(LS_KEY);
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) return arr;
      } catch (e) { console.warn('解析 LocalStorage JSON 失敗：', e); }
      return [];
    }

    function render() {
      const frag = document.createDocumentFragment();
      photos.forEach(p => {
        const card = document.createElement('article');
        card.className = 'card';
        card.dataset.id = p.id;

        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        const img = document.createElement('img');
        img.src = p.dataUrl; // 從 LocalStorage 讀回的 DataURL
        img.alt = p.title || p.name;
        thumb.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';

        const titleRow = document.createElement('div');
        titleRow.className = 'title-row';
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = p.title || fileNameWithoutExt(p.name);

        const editBtn = document.createElement('button');
        editBtn.className = 'btn edit';
        editBtn.type = 'button';
        editBtn.textContent = '編輯';
        editBtn.addEventListener('click', () => openEditor(p.id));

        titleRow.appendChild(title);
        titleRow.appendChild(editBtn);

        const time = document.createElement('div');
        time.className = 'time';
        const dt = new Date(p.lastModified || Date.now());
        time.textContent = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}｜${prettySize(p.size||0)}`;

        const tagsWrap = document.createElement('div');
        tagsWrap.className = 'tags';
        (p.tags || []).filter(Boolean).forEach(t => {
          const chip = document.createElement('span');
          chip.className = 'tag';
          chip.textContent = t;
          tagsWrap.appendChild(chip);
        });

        meta.appendChild(titleRow);
        meta.appendChild(time);
        meta.appendChild(tagsWrap);

        card.appendChild(thumb);
        card.appendChild(meta);
        frag.appendChild(card);
      });
      grid.innerHTML = '';
      grid.appendChild(frag);
    }

    function openEditor(id) {
      const p = photos.find(x => x.id === id);
      if (!p) return;
      editingId = id;
      fTitle.value = p.title || fileNameWithoutExt(p.name);
      fDesc.value = p.desc || '';
      fTags.value = (p.tags || []).join(', ');
      showModal(true);
      setTimeout(() => fTitle.focus(), 0);
    }

    function showModal(show) {
      modalBackdrop.style.display = show ? 'flex' : 'none';
      modalBackdrop.setAttribute('aria-hidden', show ? 'false' : 'true');
      if (!show) editingId = null;
    }

    function saveEditor() {
      const p = photos.find(x => x.id === editingId);
      if (!p) return;
      p.title = fTitle.value.trim();
      p.desc = fDesc.value.trim();
      p.tags = fTags.value.split(',').map(s => s.trim()).filter(Boolean);
      render();
      saveToStorage();
      showModal(false);
    }

    // 讀取檔案為 DataURL（Promise 版）
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('讀檔失敗'));
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    // 事件：上傳檔案
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      const images = files.filter(f => f.type && f.type.startsWith('image/'));
      const nonImages = files.filter(f => !f.type || !f.type.startsWith('image/'));
      if (nonImages.length) alert('已略過非圖片檔案：\n' + nonImages.map(f => `• ${f.name}`).join('\n'));

      for (const file of images) {
        try {
          const dataUrl = await readFileAsDataURL(file);
          photos.push({
            id: uid(),
            dataUrl: String(dataUrl),
            name: file.name,
            lastModified: file.lastModified,
            size: file.size,
            title: fileNameWithoutExt(file.name),
            desc: '',
            tags: [],
          });
        } catch (err) {
          console.warn('轉換 DataURL 失敗：', err);
        }
      }

      render();
      saveToStorage();
      fileInput.value = '';
    });

    // 事件：清空全部資料
    clearBtn.addEventListener('click', () => {
      if (!photos.length) return;
      if (confirm('確定要清空「所有已儲存」的相片與資料嗎？此動作不可回復。')) {
        photos = [];
        render();
        safeSetLS(LS_KEY, JSON.stringify(photos));
      }
    });

    // 手動儲存（通常不需要）
    saveBtn.addEventListener('click', () => {
      if (saveToStorage()) alert('已儲存到 LocalStorage。');
    });

    // Modal：取消 / 儲存 / ESC / 背景關閉
    btnCancel.addEventListener('click', () => showModal(false));
    btnSave.addEventListener('click', saveEditor);
    document.addEventListener('keydown', (ev) => {
      if (modalBackdrop.style.display === 'flex' && ev.key === 'Escape') showModal(false);
    });
    modalBackdrop.addEventListener('click', (ev) => {
      if (ev.target === modalBackdrop) showModal(false);
    });

    // 初始化：從 LocalStorage 載入並渲染
    (function init() {
      photos = loadFromStorage();
      render();
      console.log(' Day 5：LocalStorage 永續化已啟用。讀入照片數量：', photos.length);
    })();
  </script>
</body>
</html>

