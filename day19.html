<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Day 19ï½œç·šä¸Šç›¸ç°¿ - UI ç¾åŒ–ï¼ˆé™°å½±/åœ“è§’/hover/éª¨æ¶è¼‰å…¥ï¼‰</title>
  <!--
    ä½¿ç”¨æ–¹å¼ï¼š
    1) é€™æ˜¯å–®ä¸€ HTML æª”ï¼Œç›´æ¥å­˜æˆ index.html ä¸¦ä»¥ç€è¦½å™¨é–‹å•Ÿå³å¯ã€‚
    2) ä»Šæ—¥ç›®æ¨™ï¼š
       - ä¸€è‡´çš„é™°å½±ã€åœ“è§’èˆ‡ hover å‹•ç•«ï¼ˆå¡ç‰‡å‡èµ·ã€åœ–ç‰‡å¾®ç¸®æ”¾ï¼‰ã€‚
       - éª¨æ¶è¼‰å…¥ï¼ˆskeletonï¼‰ï¼šåˆ‡æ›åˆ†é¡/æœå°‹/è¦–åœ–æˆ–é¦–æ¬¡è¼‰å…¥æ™‚ï¼Œå±•ç¤ºéª¨æ¶å ä½é™ä½è·³å‹•ã€‚
       - ç¶­æŒ Day 18 çš„åŠŸèƒ½ï¼šç›¸ç°¿åˆ—è¡¨ã€ç›¸ç°¿å°é¢ã€å›æ”¶æ¡¶ã€æ‹–æ›³æ’åºï¼ˆå¦‚éœ€å¯å¾ Day 17 ç‰ˆæœ¬å¸¶å…¥ï¼‰ã€‚
    3) æç¤ºï¼šé€™ä»½æª”æ¡ˆå´é‡ UIï¼›è‹¥ä½ éœ€è¦æ‹–æ›³æ’åºï¼Œæ²¿ç”¨ Day 17 çš„ orderIndex æ¬„ä½å³å¯ï¼ˆæ­¤æª”ä¿ç•™æ¬„ä½ï¼Œç›¸å®¹ï¼‰ã€‚
  -->
  <style>
    /* ===== Design Tokens ===== */
    :root{
      --bg:#ffffff; --bg-elev:#f9fafb; --text:#1f2328; --muted:#6b7280; --primary:#ff8c42; --danger:#e11d48;
      --border:#e5e7eb; --radius:14px; --radius-sm:10px; --radius-lg:22px;
      --shadow-1: 0 1px 2px rgba(0,0,0,.04), 0 1px 1px rgba(0,0,0,.02);
      --shadow-2: 0 6px 18px rgba(17,24,39,.10), 0 2px 6px rgba(17,24,39,.06);
      --shadow-3: 0 14px 35px rgba(17,24,39,.16);
      --overlay: rgba(0,0,0,.55); --focus:#2563eb; --container:1200px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1220; --bg-elev:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --primary:#ff954f; --danger:#fb7185; --border:#1f2937; --overlay:rgba(0,0,0,.65); }
    }

    /* ===== Base ===== */
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans CJK TC","Microsoft JhengHei",Arial,sans-serif;line-height:1.65}
    .container{max-width:var(--container);margin:0 auto;padding:24px;box-sizing:border-box}

    header.site-header{border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fff,#fff7f1)}
    @media(prefers-color-scheme:dark){header.site-header{background:linear-gradient(180deg,#0b1220,#0b1220)}}
    .brand{display:flex;align-items:center;gap:14px}
    .brand__logo{width:48px;height:48px;border-radius:12px;background:var(--primary);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:900;box-shadow:var(--shadow-2)}
    .brand__title{margin:0;font-size:22px}
    .brand__subtitle{margin:4px 0 0;color:var(--muted);font-size:14px}

    /* Toolbar */
    .toolbar{display:grid;gap:12px;margin-top:16px;align-items:center;grid-template-columns:1fr 220px 150px 150px 150px 130px}
    @media(max-width:990px){.toolbar{grid-template-columns:1fr 1fr 1fr}}
    @media(max-width:640px){.toolbar{grid-template-columns:1fr}}
    .toolbar input[type=text],.toolbar select,.toolbar button{padding:12px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#fff;color:var(--text);box-shadow:var(--shadow-1)}
    .toolbar input[type=file]{padding:8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#fff}
    .toolbar .btn{background:var(--primary);color:#fff;border:none;cursor:pointer;border-radius:var(--radius-sm);padding:12px 14px;font-weight:700;box-shadow:var(--shadow-2);transition:transform .12s ease, box-shadow .12s ease}
    .toolbar .btn:hover{transform:translateY(-1px)}
    .toolbar .btn:active{transform:translateY(0);box-shadow:var(--shadow-1)}

    .switcher{display:flex;gap:8px;align-items:center}
    .switcher .tabbtn{padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#fff;cursor:pointer;transition:box-shadow .12s ease, transform .12s ease}
    .switcher .tabbtn:hover{box-shadow:var(--shadow-2);transform:translateY(-1px)}
    .switcher .tabbtn:active{transform:translateY(0)}
    .switcher .tabbtn.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:var(--shadow-2)}
    .badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;padding:0 6px;border-radius:999px;background:var(--border);color:var(--muted);font-size:12px;margin-left:6px}

    main.gallery{margin-top:18px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:990px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}

    /* Card */
    .card{background:var(--bg-elev);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-1);overflow:hidden;display:flex;flex-direction:column;transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
    .card:hover{transform:translateY(-3px);box-shadow:var(--shadow-2);border-color:rgba(255,140,66,.45)}
    .thumb{aspect-ratio:4/3;background:#eef2f7;position:relative;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;transform:scale(1);transition:transform .35s ease}
    .card:hover .thumb img{transform:scale(1.04)}
    .meta{padding:12px;display:grid;gap:8px}
    .title-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{font-size:12px;color:var(--muted)}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:#555;background:#fff;box-shadow:var(--shadow-1)}
    .actions{display:flex;gap:8px}
    .btn.small{padding:8px 10px;font-size:12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .btn.small:hover{box-shadow:var(--shadow-2);transform:translateY(-1px)}
    .btn.small:active{transform:translateY(0)}
    .btn.danger{background:var(--danger);color:#fff;border:none}
    .btn.cover{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .cover-ind{font-size:11px;color:var(--primary);font-weight:700;border:1px solid var(--primary);padding:2px 6px;border-radius:999px}

    .statusbar{display:flex;align-items:center;justify-content:space-between;margin:8px 0 12px;color:var(--muted);font-size:13px}
    .empty{border:2px dashed var(--border);border-radius:var(--radius);padding:24px;color:var(--muted);display:flex;align-items:center;justify-content:center;grid-column:1/-1;background:#fff0}

    .pager{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:16px}
    .pager .btn{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:12px 18px;cursor:pointer;font-weight:800;box-shadow:var(--shadow-2)}
    .pager .btn[disabled]{opacity:.55;cursor:not-allowed}
    .pager .hint{color:var(--muted);font-size:13px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal{width:560px;max-width:720px;background:var(--bg);border-radius:var(--radius-lg);border:1px solid var(--border);box-shadow:var(--shadow-3);overflow:hidden}
    .modal__header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:900}
    .modal__body{padding:16px;display:grid;gap:12px}
    .modal__footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
    .field{display:grid;gap:6px}
    .field label{font-size:13px;color:var(--muted)}
    .field input[type=text],.field textarea,.field select{width:100%;box-sizing:border-box;padding:12px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--text);box-shadow:var(--shadow-1)}
    .field textarea{resize:vertical;min-height:90px}
    .btn.secondary{background:#fff0;border:1px solid var(--border);color:var(--text)}
    .btn.primary{background:var(--primary);color:#fff;border:none}

    /* ===== Skeletonï¼ˆShimmerï¼‰ ===== */
    .skeleton{position:relative;overflow:hidden;background:linear-gradient(90deg, rgba(148,163,184,.25) 25%, rgba(148,163,184,.15) 37%, rgba(148,163,184,.25) 63%);background-size:400% 100%;animation:skeleton 1.1s ease-in-out infinite;border-radius:8px}
    @keyframes skeleton{0%{background-position:100% 0}100%{background-position:-100% 0}}
    .card.skel{border-color:transparent;box-shadow:var(--shadow-1)}
    .thumb.skel{aspect-ratio:4/3;border-bottom-left-radius:0;border-bottom-right-radius:0}
    .meta .skel-line{height:12px}
    .meta .skel-line.lg{height:16px}

    /* Focus visible */
    :focus-visible{outline:3px solid var(--focus);outline-offset:2px;border-radius:10px}
  </style>
  <!-- exif-jsï¼ˆå»¶çºŒ Day 15ï¼›è¼‰ä¸åˆ°ä¹Ÿä¸å½±éŸ¿ä»Šå¤©åŠŸèƒ½ï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" integrity="sha512-sSWq7J7V7x1Gk2YgG9XgVQwO4TtF2v3m7zq2jv1Wn0fS9zF+v4uE7wUuJ7c3OeJqf8i9mnnm2n6O1i8wCw3Wiw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">PA</div>
        <div>
          <h1 class="brand__title">ç·šä¸Šç›¸ç°¿ï¼ˆDay 19ï¼‰</h1>
          <p class="brand__subtitle">UI ç¾åŒ–ï¼šä¸€è‡´é™°å½±ï¼åœ“è§’ï¼hoverï¼éª¨æ¶è¼‰å…¥</p>
        </div>
      </div>

      <div class="toolbar" role="region" aria-label="å·¥å…·åˆ—">
        <input id="searchInput" type="text" placeholder="æœå°‹é—œéµå­—ï¼ˆæ¨™é¡Œï¼æ•˜è¿°ï¼æ¨™ç±¤ï¼æª”åï¼‰" aria-label="æœå°‹">
        <input id="fileInput" type="file" accept="image/*" multiple aria-label="ä¸Šå‚³åœ–ç‰‡">
        <select id="categorySelect" aria-label="åˆ†é¡"></select>
        <select id="sortBy" aria-label="æ’åºä¾æ“š">
          <option value="time" selected>ä¾æ™‚é–“</option>
          <option value="title">ä¾æ¨™é¡Œ</option>
          <option value="custom">è‡ªè¨‚ï¼ˆæ‹–æ›³ï¼‰</option>
        </select>
        <select id="sortOrder" aria-label="å‡å†ªæˆ–é™å†ª">
          <option value="desc" selected>é™å†ª</option>
          <option value="asc">å‡å†ª</option>
        </select>
        <select id="pageSize" aria-label="æ¯é ç­†æ•¸">
          <option value="8">æ¯é  8 å¼µ</option>
          <option value="12" selected>æ¯é  12 å¼µ</option>
          <option value="16">æ¯é  16 å¼µ</option>
          <option value="24">æ¯é  24 å¼µ</option>
        </select>
        <div class="switcher" style="grid-column: 1 / -1;">
          <button id="tabLibrary" class="tabbtn active" type="button">ç›¸ç°¿</button>
          <button id="tabAlbums" class="tabbtn" type="button">ç›¸ç°¿åˆ—è¡¨</button>
          <button id="tabTrash" class="tabbtn" type="button">å›æ”¶æ¡¶ <span id="trashBadge" class="badge">0</span></button>
        </div>
        <div style="grid-column: 1 / -1; font-size:13px; color:var(--muted);">
          æç¤ºï¼šæ­¤æ—¥è‘—é‡ç¾åŒ–èˆ‡éª¨æ¶è¼‰å…¥ã€‚å…¶é¤˜åŠŸèƒ½æ²¿ç”¨æ—¢æœ‰ç‰ˆæœ¬ã€‚
        </div>
      </div>
    </div>
  </header>

  <main class="gallery">
    <div class="container">
      <div class="statusbar" aria-live="polite">
        <div><span id="countAll">0</span> å¼µç…§ç‰‡</div>
        <div>å·²é¡¯ç¤ºï¼š<span id="countShown">0</span>ï¼ç¬¦åˆï¼š<span id="countFiltered">0</span> å¼µ</div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px;">
        <button id="emptyTrashBtn" class="btn danger small" type="button" title="æ°¸ä¹…æ¸…ç©ºå›æ”¶æ¡¶" style="display:none;">æ¸…ç©ºå›æ”¶æ¡¶</button>
        <button id="clearBtn" class="btn secondary small" type="button" title="æ¸…ç©ºå…¨éƒ¨è³‡æ–™">æ¸…ç©ºå…¨éƒ¨ï¼ˆå«å›æ”¶æ¡¶ & å°é¢ï¼‰</button>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div class="pager" id="pager" style="display:flex;">
        <button id="loadMoreBtn" class="btn" type="button">è¼‰å…¥æ›´å¤š</button>
        <span class="hint" id="pagerHint"></span>
      </div>
    </div>
  </main>

  <!-- ====== Modalï¼šç·¨è¼¯åœ–ç‰‡ä¸­ç¹¼è³‡æ–™ ====== -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div class="modal__header" id="modalTitle">ç·¨è¼¯åœ–ç‰‡è³‡è¨Š</div>
      <div class="modal__body">
        <div class="field">
          <label for="fTitle">æ¨™é¡Œ</label>
          <input id="fTitle" type="text" placeholder="ä¾‹ï¼šå°åŒ—å°æ—…è¡Œ" />
        </div>
        <div class="field">
          <label for="fDesc">æ•˜è¿°</label>
          <textarea id="fDesc" placeholder="ç°¡çŸ­æè¿°é€™å¼µç…§ç‰‡...ï¼ˆéå¿…å¡«ï¼‰"></textarea>
        </div>
        <div class="field">
          <label for="fTags">æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿ , åˆ†éš”ï¼‰</label>
          <input id="fTags" type="text" placeholder="ä¾‹ï¼šæ—…éŠ, æœ‹å‹, æ™šä¸Š" />
        </div>
        <div class="field">
          <label for="fCategory">åˆ†é¡</label>
          <input id="fCategory" list="catList" type="text" placeholder="ä¾‹ï¼šæ—…éŠ / ç”Ÿæ´» / å¯µç‰©" />
          <datalist id="catList"></datalist>
        </div>
      </div>
      <div class="modal__footer">
        <button id="btnCancel" class="btn secondary" type="button">å–æ¶ˆ</button>
        <button id="btnSave" class="btn primary" type="button">å„²å­˜</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container" style="border-top:1px solid var(--border); margin-top:24px; padding-top:16px; color:var(--muted); font-size:13px; text-align:center;">
      Day 19 å®Œæˆï¼šUI çµ±ä¸€é™°å½±/åœ“è§’/hover èˆ‡éª¨æ¶è¼‰å…¥ã€‚
    </div>
  </footer>

  <script>
    // ============================
    // Day 19ï¼šUI ç¾åŒ–ï¼ˆé™°å½±/åœ“è§’/hover/éª¨æ¶è¼‰å…¥ï¼‰
    // åŸºæ–¼ Day 18ï¼Œç›¸å®¹ç›¸ç°¿å°é¢/å›æ”¶æ¡¶ç­‰åŠŸèƒ½ã€‚
    // ============================
    const LS_KEY = 'pa_photos_v1';
    const LS_COVERS = 'pa_album_covers_v1';

    // å·¥å…·åˆ—/ç¯€é»
    const fileInput = document.getElementById('fileInput');
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const sortBySelect = document.getElementById('sortBy');
    const sortOrderSelect = document.getElementById('sortOrder');
    const pageSizeSelect = document.getElementById('pageSize');

    const grid = document.getElementById('grid');
    const pager = document.getElementById('pager');
    const clearBtn = document.getElementById('clearBtn');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const pagerHint = document.getElementById('pagerHint');

    const countAll = document.getElementById('countAll');
    const countFiltered = document.getElementById('countFiltered');
    const countShown = document.getElementById('countShown');

    // è¦–åœ–åˆ‡æ›
    const tabLibrary = document.getElementById('tabLibrary');
    const tabAlbums = document.getElementById('tabAlbums');
    const tabTrash = document.getElementById('tabTrash');
    const trashBadge = document.getElementById('trashBadge');
    const emptyTrashBtn = document.getElementById('emptyTrashBtn');

    // Modal
    const modalBackdrop = document.getElementById('modalBackdrop');
    const fTitle = document.getElementById('fTitle');
    const fDesc = document.getElementById('fDesc');
    const fTags = document.getElementById('fTags');
    const fCategory = document.getElementById('fCategory');
    const catList = document.getElementById('catList');
    const btnCancel = document.getElementById('btnCancel');
    const btnSave = document.getElementById('btnSave');

    /** @type {{ id:string, dataUrl:string, name:string, lastModified:number, size:number, title:string, desc:string, tags:string[], category?:string, exif?: { dateTakenMs?: number|null, make?: string|null, model?: string|null, orientation?: number|null }, isDeleted?: boolean, deletedAt?: number|null, orderIndex?: number }[]} */
    let photos = [];
    /** @type {{ [cat:string]: string }} */
    let albumCovers = {};

    let editingId = null;
    let query = '';
    let currentCategory = 'å…¨éƒ¨';
    let sortBy = 'time';
    let sortOrder = 'desc';
    let pageSize = 12;
    let visibleCount = pageSize;
    let showTrash = false;
    let showAlbums = false;

    let isLoadingUI = false; // éª¨æ¶è¼‰å…¥æ——æ¨™

    const DEFAULT_CAT = 'æœªåˆ†é¡';

    // ===== Utils =====
    function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
    function prettySize(bytes){const u=['B','KB','MB','GB'];let i=0,n=bytes;while(n>=1024&&i<u.length-1){n/=1024;i++}return `${n.toFixed(1)} ${u[i]}`}
    function fileNameWithoutExt(name=''){const i=name.lastIndexOf('.');return i>0?name.slice(0,i):name||'æœªå‘½ååœ–ç‰‡'}
    function fmt(dt){ const d=new Date(dt||Date.now()); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` }

    function safeGetLS(key){try{return localStorage.getItem(key)}catch(e){console.warn('è®€å– LS å¤±æ•—',e);return null}}
    function safeSetLS(key,val){try{localStorage.setItem(key,val);return true}catch(e){alert('å„²å­˜å¤±æ•—ï¼Œå¯èƒ½è¶…é LocalStorage å®¹é‡ã€‚');console.warn('å¯«å…¥ LS å¤±æ•—',e);return false}}
    function saveToStorage(){return safeSetLS(LS_KEY, JSON.stringify(photos))}
    function loadFromStorage(){const raw=safeGetLS(LS_KEY);if(!raw) return [];try{const arr=JSON.parse(raw);if(Array.isArray(arr))return arr}catch(e){console.warn('è§£æ JSON å¤±æ•—',e)}return []}
    function saveCovers(){ safeSetLS(LS_COVERS, JSON.stringify(albumCovers)); }
    function loadCovers(){ try{ const raw=safeGetLS(LS_COVERS); const obj = raw? JSON.parse(raw) : {}; return (obj && typeof obj==='object')? obj : {}; }catch(e){ return {}; } }

    // ===== åˆ†é¡ =====
    function getCategoryOf(p){ return (p.category&&p.category.trim())||DEFAULT_CAT; }
    function getAllCategories(){const set=new Set();photos.forEach(p=>{ if(p.isDeleted) return; set.add(getCategoryOf(p))});set.add(DEFAULT_CAT);return Array.from(set).sort((a,b)=>a.localeCompare(b))}
    function buildCategorySelect(){const cats=getAllCategories();const prev=currentCategory;categorySelect.innerHTML='';categorySelect.appendChild(new Option('å…¨éƒ¨','å…¨éƒ¨'));cats.forEach(c=>categorySelect.appendChild(new Option(c,c)));categorySelect.value=(cats.includes(prev)||prev==='å…¨éƒ¨')?prev:'å…¨éƒ¨';currentCategory=categorySelect.value}
    function buildCategoryDatalist(){const cats=getAllCategories();catList.innerHTML='';cats.forEach(c=>{const opt=document.createElement('option');opt.value=c;catList.appendChild(opt)})}

    // ===== ç¯©é¸/æ’åº =====
    function baseFilter(list){
      const q=(query||'').trim().toLowerCase();
      const tokens=q?q.split(/\s+/).filter(Boolean):[];
      return list.filter(p=>{
        if(showAlbums) return false; // ç›¸ç°¿åˆ—è¡¨ä¸é¡¯ç¤ºç›¸ç‰‡å¡
        const inTrash = !!p.isDeleted; if(showTrash? !inTrash : inTrash) return false; // è¦–åœ–åˆ‡æ›
        const cat=getCategoryOf(p);
        if(!showTrash && currentCategory!=='å…¨éƒ¨' && cat!==currentCategory) return false;
        if(!tokens.length) return true;
        const hay=[p.title||'',p.desc||'',(p.tags||[]).join(' '),p.name||''].join(' ').toLowerCase();
        return tokens.every(tok=>hay.includes(tok));
      })
    }
    function sortPhotos(list){
      const arr=list.slice();
      const order = sortOrder==='asc'?1:-1;
      if(sortBy==='custom'){
        arr.sort((a,b)=>{
          const aIdx = typeof a.orderIndex==='number'? a.orderIndex : Number.MAX_SAFE_INTEGER;
          const bIdx = typeof b.orderIndex==='number'? b.orderIndex : Number.MAX_SAFE_INTEGER;
          if(aIdx===bIdx) return 0; return (aIdx>bIdx?1:-1);
        });
      } else if(sortBy==='time'){
        arr.sort((a,b)=>{const t1=Number(a.lastModified||0),t2=Number(b.lastModified||0);return (t1===t2?0:(t1>t2?1:-1))*order})
      }else{ // title
        arr.sort((a,b)=>{const s1=(a.title||fileNameWithoutExt(a.name)).toLowerCase();const s2=(b.title||fileNameWithoutExt(b.name)).toLowerCase();if(s1===s2) return 0;return (s1>s2?1:-1)*order})
      }
      return arr
    }
    function getFilteredSorted(){return sortPhotos(baseFilter(photos))}
    function getVisibleData(){return getFilteredSorted().slice(0, visibleCount)}

    function updateCounters(){ const trashCount = photos.filter(p=>p.isDeleted).length; trashBadge.textContent = String(trashCount); }
    function updatePagerUI(total){
      const shown=Math.min(visibleCount,total);
      countAll.textContent=String(photos.filter(p=>!p.isDeleted).length);
      countFiltered.textContent=String(total);
      countShown.textContent=String(shown);
      const hasMore = shown < total;
      const showPager = !showAlbums;
      pager.style.display = showPager ? 'flex' : 'none';
      if(showPager){
        loadMoreBtn.disabled = !hasMore;
        pagerHint.textContent = hasMore ? `å°šæœ‰ ${total - shown} å¼µæœªé¡¯ç¤º` : (total===0 ? (showTrash?'å›æ”¶æ¡¶æ²’æœ‰å…§å®¹':'æ²’æœ‰ç¬¦åˆçš„ç›¸ç‰‡') : 'å·²é¡¯ç¤ºå…¨éƒ¨');
      }
      emptyTrashBtn.style.display = showTrash ? 'inline-flex' : 'none';
    }

    // ===== ç›¸ç°¿å°é¢ =====
    function getPhotosByCategory(cat){ return photos.filter(p=>!p.isDeleted && getCategoryOf(p)===cat); }
    function latestPhotoInCategory(cat){ const arr = getPhotosByCategory(cat).slice().sort((a,b)=>Number(b.lastModified||0)-Number(a.lastModified||0)); return arr[0]||null; }
    function coverPhotoForCategory(cat){ const id=albumCovers[cat]; if(id){ const p=photos.find(x=>x.id===id && !x.isDeleted && getCategoryOf(x)===cat); if(p) return p; } return latestPhotoInCategory(cat); }
    function setCoverForCategory(cat, photoId){ albumCovers[cat]=photoId; saveCovers(); softRender(); }
    function clearCoverForCategory(cat){ delete albumCovers[cat]; saveCovers(); softRender(); }
    function reconcileCovers(){ Object.keys(albumCovers).forEach(cat=>{ const pid=albumCovers[cat]; const p=photos.find(x=>x.id===pid); if(!p || p.isDeleted || getCategoryOf(p)!==cat) delete albumCovers[cat]; }); saveCovers(); }

    // ===== Skeleton =====
    function showSkeleton(n){
      const frag=document.createDocumentFragment();
      for(let i=0;i<n;i++){
        const card=document.createElement('article'); card.className='card skel';
        const th=document.createElement('div'); th.className='thumb skeleton'; card.appendChild(th);
        const meta=document.createElement('div'); meta.className='meta';
        const l1=document.createElement('div'); l1.className='skeleton skel-line lg';
        const l2=document.createElement('div'); l2.className='skeleton skel-line'; l2.style.width='70%';
        const l3=document.createElement('div'); l3.className='skeleton skel-line'; l3.style.width='40%';
        meta.appendChild(l1); meta.appendChild(l2); meta.appendChild(l3);
        card.appendChild(meta); frag.appendChild(card);
      }
      grid.innerHTML=''; grid.appendChild(frag);
    }

    // ç”¨æ–¼åˆ‡æ›æ¢ä»¶æ™‚çš„æŸ”æ€§é‡ç¹ªï¼šå…ˆç•«éª¨æ¶ï¼Œå¾®å»¶é²å¾ŒçœŸæ­£æ¸²æŸ“
    function softRender(){
      if(isLoadingUI){ return; }
      isLoadingUI = true; // é¡¯ç¤ºéª¨æ¶ï¼ˆä»¥ç•¶å‰ pageSize æ±ºå®šæ•¸é‡ï¼‰
      const total = getFilteredSorted().length || pageSize;
      showSkeleton(Math.min(pageSize, Math.max(6, Math.min(total, pageSize))));
      requestAnimationFrame(()=>{ setTimeout(()=>{ isLoadingUI=false; render(); }, 280); });
    }

    // ===== æ¸²æŸ“ =====
    function renderAlbumsView(){
      const cats = getAllCategories();
      const frag = document.createDocumentFragment();
      if(cats.length===0){ const empty=document.createElement('div'); empty.className='empty'; empty.textContent='ç›®å‰æ²’æœ‰ä»»ä½•åˆ†é¡ã€‚'; frag.appendChild(empty); }
      else{
        cats.forEach(cat=>{
          const card=document.createElement('article'); card.className='card';
          const thumb=document.createElement('div'); thumb.className='thumb';
          const cover = coverPhotoForCategory(cat);
          const img=document.createElement('img'); img.alt=cat+' å°é¢'; img.src = cover? cover.dataUrl : 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><rect width="100%" height="100%" fill="#eef2f7"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-family="sans-serif" font-size="20">${cat}</text></svg>`);
          thumb.appendChild(img);
          const meta=document.createElement('div'); meta.className='meta';
          const titleRow=document.createElement('div'); titleRow.className='title-row';
          const title=document.createElement('div'); title.className='title'; title.textContent=cat;
          const btnRow=document.createElement('div'); btnRow.className='actions';
          const viewBtn=document.createElement('button'); viewBtn.className='btn small'; viewBtn.type='button'; viewBtn.textContent='æŸ¥çœ‹'; viewBtn.addEventListener('click',()=>{ currentCategory=cat; categorySelect.value=cat; setTab('library'); });
          const clrBtn=document.createElement('button'); clrBtn.className='btn small secondary'; clrBtn.type='button'; clrBtn.textContent='æ¸…é™¤å°é¢'; clrBtn.addEventListener('click',()=>clearCoverForCategory(cat));
          btnRow.appendChild(viewBtn); btnRow.appendChild(clrBtn);
          titleRow.appendChild(title); titleRow.appendChild(btnRow);
          const metaLine=document.createElement('div'); metaLine.className='time';
          const count = getPhotosByCategory(cat).length;
          metaLine.textContent = `ç›¸ç‰‡ ${count} å¼µ ${albumCovers[cat]? 'ï½œå·²æŒ‡å®šå°é¢' : (cover? 'ï½œé è¨­å°é¢ï¼ˆæœ€æ–°ï¼‰' : '')}`;
          meta.appendChild(titleRow); meta.appendChild(metaLine);
          card.appendChild(thumb); card.appendChild(meta); frag.appendChild(card);
        });
      }
      grid.innerHTML=''; grid.appendChild(frag);
      // æ›´æ–°çµ±è¨ˆ UIï¼ˆç›¸ç°¿åˆ—è¡¨ä¸é¡¯ç¤ºåˆ†é ï¼‰
      countFiltered.textContent='â€”'; countShown.textContent='â€”'; updateCounters(); pager.style.display='none';
    }

    function renderPhotosView(){
      const data = getVisibleData();
      const total = getFilteredSorted().length;
      updateCounters();
      updatePagerUI(total);
      const frag=document.createDocumentFragment();
      if(data.length===0){ const empty=document.createElement('div'); empty.className='empty'; empty.textContent = showTrash ? 'å›æ”¶æ¡¶æ˜¯ç©ºçš„ã€‚' : (photos.filter(p=>!p.isDeleted).length===0?'é‚„æ²’æœ‰ç›¸ç‰‡ï¼Œè«‹å¾ä¸Šæ–¹ä¸Šå‚³ã€‚':'æ²’æœ‰ç¬¦åˆç›®å‰æœå°‹/åˆ†é¡çš„çµæœã€‚'); frag.appendChild(empty); }
      else{
        data.forEach((p)=>{
          const card=document.createElement('article'); card.className='card'; card.dataset.id=p.id;
          const thumb=document.createElement('div'); thumb.className='thumb';
          const img=document.createElement('img'); img.src=p.dataUrl; img.alt=p.title||p.name; thumb.appendChild(img);
          const meta=document.createElement('div'); meta.className='meta';
          const titleRow=document.createElement('div'); titleRow.className='title-row';
          const title=document.createElement('div'); title.className='title'; title.textContent=p.title||fileNameWithoutExt(p.name);

          const btnRow=document.createElement('div'); btnRow.className='actions';
          if(showTrash){
            const restoreBtn=document.createElement('button'); restoreBtn.className='btn small'; restoreBtn.type='button'; restoreBtn.textContent='é‚„åŸ'; restoreBtn.addEventListener('click',()=>restorePhoto(p.id));
            const delBtn=document.createElement('button'); delBtn.className='btn small danger'; delBtn.type='button'; delBtn.textContent='æ°¸ä¹…åˆªé™¤'; delBtn.addEventListener('click',()=>permanentlyDelete(p.id));
            btnRow.appendChild(restoreBtn); btnRow.appendChild(delBtn);
          }else{
            const editBtn=document.createElement('button'); editBtn.className='btn small'; editBtn.type='button'; editBtn.textContent='ç·¨è¼¯'; editBtn.addEventListener('click',()=>openEditor(p.id));
            const trashBtn=document.createElement('button'); trashBtn.className='btn small danger'; trashBtn.type='button'; trashBtn.textContent='åˆªé™¤'; trashBtn.addEventListener('click',()=>moveToTrash(p.id));
            const coverBtn=document.createElement('button'); coverBtn.className='btn small cover'; coverBtn.type='button'; coverBtn.textContent='è¨­ç‚ºå°é¢'; coverBtn.addEventListener('click',()=>{ const cat=getCategoryOf(p); setCoverForCategory(cat, p.id); });
            btnRow.appendChild(editBtn); btnRow.appendChild(trashBtn); btnRow.appendChild(coverBtn);
          }
          titleRow.appendChild(title); titleRow.appendChild(btnRow);
          const time=document.createElement('div'); time.className='time'; const dt=new Date(p.lastModified||Date.now());
          const cat=getCategoryOf(p);
          const isCover = albumCovers[cat] === p.id;
          const coverBadge = isCover ? `ï½œ`+`<span class="cover-ind">${cat} å°é¢</span>` : '';
          time.innerHTML=`æ™‚é–“ï¼š${fmt(dt)}ï½œ${prettySize(p.size||0)}ï½œåˆ†é¡ï¼š${cat} ${coverBadge}`;
          const tagsWrap=document.createElement('div'); tagsWrap.className='tags'; (p.tags||[]).filter(Boolean).forEach(t=>{const chip=document.createElement('span'); chip.className='tag'; chip.textContent=t; tagsWrap.appendChild(chip)});
          meta.appendChild(titleRow); meta.appendChild(time); meta.appendChild(tagsWrap);
          card.appendChild(thumb); card.appendChild(meta); frag.appendChild(card);
        })
      }
      grid.innerHTML=''; grid.appendChild(frag);
    }

    function render(){ if(showAlbums){ renderAlbumsView(); } else { renderPhotosView(); } }

    // ===== æª”æ¡ˆ/å­˜å– =====
    function readFileAsDataURL(file){return new Promise((resolve,reject)=>{const r=new FileReader();r.onerror=()=>reject(new Error('è®€æª”å¤±æ•—'));r.onload=()=>resolve(r.result);r.readAsDataURL(file)})}

    // ===== åˆªé™¤/é‚„åŸ/æ°¸ä¹…åˆªé™¤ =====
    function moveToTrash(id){ const p=photos.find(x=>x.id===id); if(!p) return; const cat=getCategoryOf(p); if(albumCovers[cat]===p.id){ delete albumCovers[cat]; saveCovers(); } p.isDeleted=true; p.deletedAt=Date.now(); saveToStorage(); softRender(); }
    function restorePhoto(id){ const p=photos.find(x=>x.id===id); if(!p) return; if(!p.isDeleted) return; p.isDeleted=false; p.deletedAt=null; saveToStorage(); softRender(); }
    function permanentlyDelete(id){ const idx=photos.findIndex(x=>x.id===id); if(idx<0) return; const p=photos[idx]; const cat=p?getCategoryOf(p):null; if(p && albumCovers[cat]===p.id){ delete albumCovers[cat]; saveCovers(); } if(confirm('æ­¤å‹•ä½œç„¡æ³•é‚„åŸã€‚ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ')){ photos.splice(idx,1); saveToStorage(); softRender(); } }
    function emptyTrash(){ if(!photos.some(p=>p.isDeleted)) return alert('å›æ”¶æ¡¶ç›®å‰æ˜¯ç©ºçš„'); if(!confirm('å°‡æ°¸ä¹…åˆªé™¤å›æ”¶æ¡¶å…§çš„æ‰€æœ‰é …ç›®ï¼ˆåŒæ™‚æ¸…ç†å°é¢æŒ‡å‘ï¼‰ï¼Œç„¡æ³•å¾©åŸã€‚è¦ç¹¼çºŒå—ï¼Ÿ')) return; const idsToDelete = photos.filter(p=>p.isDeleted).map(p=>p.id); photos = photos.filter(p=>!p.isDeleted); Object.keys(albumCovers).forEach(cat=>{ if(idsToDelete.includes(albumCovers[cat])) delete albumCovers[cat]; }); saveCovers(); saveToStorage(); softRender(); }

    // ===== ç·¨è¼¯å½ˆçª— =====
    function openEditor(id){ const p=photos.find(x=>x.id===id); if(!p) return; if(p.isDeleted) return alert('å›æ”¶æ¡¶ä¸­çš„é …ç›®ä¸èƒ½ç·¨è¼¯ï¼Œè«‹å…ˆé‚„åŸã€‚'); const oldCat=getCategoryOf(p); editingId=id; fTitle.value=p.title||fileNameWithoutExt(p.name); fDesc.value=p.desc||''; fTags.value=(p.tags||[]).join(', '); fCategory.value=oldCat; showModal(true); setTimeout(()=>fTitle.focus(),0) }
    function showModal(show){ modalBackdrop.style.display=show?'flex':'none'; modalBackdrop.setAttribute('aria-hidden',show?'false':'true'); if(!show) editingId=null }
    function saveEditor(){ const p=photos.find(x=>x.id===editingId); if(!p) return; const oldCat=getCategoryOf(p); p.title=fTitle.value.trim(); p.desc=fDesc.value.trim(); p.tags=fTags.value.split(',').map(s=>s.trim()).filter(Boolean); p.category=(fCategory.value||'').trim()||DEFAULT_CAT; const newCat=getCategoryOf(p); if(oldCat!==newCat && albumCovers[oldCat]===p.id){ delete albumCovers[oldCat]; saveCovers(); } saveToStorage(); buildCategorySelect(); buildCategoryDatalist(); softRender(); showModal(false) }
    btnCancel.addEventListener('click',()=>showModal(false))
    btnSave.addEventListener('click',saveEditor)
    document.addEventListener('keydown',ev=>{ if(modalBackdrop.style.display==='flex' && ev.key==='Escape') showModal(false) })
    modalBackdrop.addEventListener('click',ev=>{ if(ev.target===modalBackdrop) showModal(false) })

    // ===== äº‹ä»¶ï¼šä¸Šå‚³/æ¸…ç©º/åˆ‡æ›/æœå°‹/æ’åº/åˆ†é  =====
    fileInput.addEventListener('change', async (e)=>{
      const files=Array.from(e.target.files||[]); if(!files.length) return;
      const images=files.filter(f=>f.type&&f.type.startsWith('image/'));
      const nonImages=files.filter(f=>!f.type||!f.type.startsWith('image/'));
      if(nonImages.length) alert('å·²ç•¥ééåœ–ç‰‡æª”æ¡ˆï¼š\n'+nonImages.map(f=>'â€¢ '+f.name).join('\n'));
      for(const file of images){
        try{ const dataUrl=await readFileAsDataURL(file);
          const maxOrder = photos.reduce((m,p)=>Math.max(m, typeof p.orderIndex==='number'?p.orderIndex:-1), -1);
          photos.push({id:uid(),dataUrl:String(dataUrl),name:file.name,lastModified:file.lastModified,size:file.size,title:fileNameWithoutExt(file.name),desc:'',tags:[],category:DEFAULT_CAT,isDeleted:false,deletedAt:null, orderIndex: maxOrder+10});
        }catch(err){ console.warn('è½‰æ› DataURL å¤±æ•—ï¼š',err) }
      }
      saveToStorage(); buildCategorySelect(); buildCategoryDatalist(); e.target.value=''; softRender();
    });

    clearBtn.addEventListener('click',()=>{ if(!photos.length && Object.keys(albumCovers).length===0) return; if(confirm('å°‡åˆªé™¤æ‰€æœ‰ç›¸ç‰‡ã€å›æ”¶æ¡¶å…§å®¹èˆ‡å°é¢è¨­å®šï¼ˆä¸å¯å¾©åŸï¼‰ã€‚ç¢ºå®šï¼Ÿ')){ photos=[]; albumCovers={}; saveToStorage(); saveCovers(); buildCategorySelect(); buildCategoryDatalist(); softRender(); } })
    emptyTrashBtn.addEventListener('click', emptyTrash);

    searchInput.addEventListener('input',e=>{ query=e.target.value||''; visibleCount = pageSize; softRender() })
    categorySelect.addEventListener('change',e=>{ currentCategory=e.target.value; setTab('library'); visibleCount = pageSize; softRender() })
    sortBySelect.addEventListener('change',e=>{ sortBy=e.target.value; visibleCount = pageSize; softRender() })
    sortOrderSelect.addEventListener('change',e=>{ sortOrder=e.target.value; visibleCount = pageSize; softRender() })
    pageSizeSelect.addEventListener('change',e=>{ pageSize=Number(e.target.value)||12; visibleCount = pageSize; softRender() })
    loadMoreBtn.addEventListener('click',()=>{ const total=getFilteredSorted().length; visibleCount=Math.min(visibleCount+pageSize, total); softRender() })

    function setTab(which){
      showAlbums = (which==='albums');
      showTrash = (which==='trash');
      tabLibrary.classList.toggle('active', which==='library');
      tabAlbums.classList.toggle('active', which==='albums');
      tabTrash.classList.toggle('active', which==='trash');
      visibleCount = pageSize;
      softRender();
    }
    tabLibrary.addEventListener('click',()=>setTab('library'));
    tabAlbums.addEventListener('click',()=>setTab('albums'));
    tabTrash.addEventListener('click',()=>setTab('trash'));

    // ============================
    // è‡ªæˆ‘æ¸¬è©¦ï¼ˆconsoleï¼‰ï¼šéª¨æ¶ & è¦–åœ–åˆ‡æ›ä¸çˆ†éŒ¯
    // ============================
    function runSelfTests(){
      console.groupCollapsed('ğŸ” Self-tests for Day 19');
      try{
        // 1) sortPhotos title asc
        const arr=[{title:'b',name:'b'},{title:'a',name:'a'}];
        const sorted = (function(){ const prevSortBy=sortBy, prevOrder=sortOrder; sortBy='title'; sortOrder='asc'; const r=sortPhotos(arr); sortBy=prevSortBy; sortOrder=prevOrder; return r; })();
        console.assert(sorted[0].title==='a','æ¨™é¡Œå‡å†ªæ’åºæ­£ç¢º');
        // 2) skeleton æ¸²æŸ“ï¼ˆä¸ç›´æ¥é©— DOMï¼Œè‡³å°‘å‘¼å«ä¸ throwï¼‰
        showSkeleton(3);
        console.assert(grid.children.length===3,'éª¨æ¶å¼µæ•¸ 3');
        console.log('âœ… è‡ªæˆ‘æ¸¬è©¦é€šé');
      }catch(err){ console.error('âŒ è‡ªæˆ‘æ¸¬è©¦å¤±æ•—', err); }
      console.groupEnd();
    }

    // ===== åˆå§‹åŒ– =====
    (function init(){
      photos = loadFromStorage();
      albumCovers = loadCovers();
      // æ¬„ä½å‡ç´š
      let patched=false; photos.forEach(p=>{ if(!('category' in p)) { p.category=DEFAULT_CAT; patched=true } if(!('isDeleted' in p)) { p.isDeleted=false; patched=true } if(!('deletedAt' in p)) { p.deletedAt=null; patched=true } if(!('orderIndex' in p)) { p.orderIndex = 0; patched=true } }); if(patched) saveToStorage();
      reconcileCovers();
      buildCategorySelect(); buildCategoryDatalist();
      // é è¨­ç‹€æ…‹
      sortBy = sortBySelect.value; sortOrder = sortOrderSelect.value; pageSize = Number(pageSizeSelect.value)||12; visibleCount = pageSize; showTrash=false; showAlbums=false;
      // é¦–æ¬¡ï¼šé¡¯ç¤ºéª¨æ¶å†æ¸²æŸ“
      softRender();
      runSelfTests();
      console.log('âœ… Day 19ï¼šUI ç¾åŒ–å•Ÿç”¨ã€‚ç…§ç‰‡æ•¸ï¼š', photos.length);
    })();
  </script>
</body>
</html>