<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Day 30ï½œç·šä¸Šç›¸ç°¿ - æœ€çµ‚å®Œæˆç‰ˆï¼ˆå‰ 29 å¤©æ•´åˆï¼‰</title>
  <!--
    æœ€çµ‚å®Œæˆç‰ˆï¼ˆå–®æª”å¯è·‘ï¼‰ï¼šæ•´åˆ Day 1 ~ Day 29 çš„æ ¸å¿ƒåŠŸèƒ½
    - ä¸Šå‚³é è¦½ / ä¸­ç¹¼è³‡æ–™å¯ç·¨è¼¯ï¼ˆæ¨™é¡Œ/æ•˜è¿°/æ¨™ç±¤/åˆ†é¡ï¼‰
    - LocalStorage æ°¸çºŒåŒ–ã€EXIFï¼ˆDay 15ï¼‰
    - æœå°‹ / æ’åºï¼ˆæ™‚é–“/æ¨™é¡Œï¼›å‡é™å†ªï¼‰/ åˆ†é ï¼šè¼‰å…¥æ›´å¤š
    - å›æ”¶æ¡¶ï¼ˆè»Ÿåˆªé™¤/é‚„åŸ/7 å¤©è‡ªå‹•æ¸…é™¤ï¼‰ï¼ˆDay 16ï¼‰
    - æ‹–æ›³æ’åºï¼ˆå¡ç‰‡å¯æ‹–å‹•é‡æ’ï¼‰ï¼ˆDay 17ï¼‰
    - ç›¸ç°¿å°é¢ï¼ˆDay 18ï¼‰
    - UI ç¾åŒ– + éª¨æ¶ loadingï¼ˆDay 19ï¼‰
    - ä¸»é¡Œåˆ‡æ›ï¼ˆCSS è®Šæ•¸ï¼›æ·º/æ·±ï¼‰ï¼ˆDay 20ï¼‰
    - å¤šç›¸ç°¿ï¼šå»ºç«‹/é‡æ–°å‘½å/åˆªé™¤ï¼ˆDay 21ï¼‰
    - åœ–ç‰‡ä¸‹è¼‰å£“ç¸®ç‰ˆï¼ˆCanvas ç¸®æ”¾ï¼‰ï¼ˆDay 22ï¼‰
    - åˆ†äº«é€£çµï¼ˆæ¨¡æ“¬ï¼›è¨ªå®¢å”¯è®€ï¼‰ï¼ˆDay 24ï¼‰
    - åŸºæœ¬ç™»å…¥ï¼ˆLocalStorageã€SHA-256 é›œæ¹Šï¼‰ï¼ˆDay 25ï¼‰
    - å¤šä½¿ç”¨è€…è³‡æ–™éš”é›¢ + ç™»å…¥ç¯€æµ/é–å®šï¼ˆDay 26ï¼‰
    - æ•ˆèƒ½ï¼šç¸®åœ–ç”Ÿæˆã€Lazy Loadã€æœå°‹ Debounceï¼ˆDay 27ï¼‰
    - PWAï¼šé›¢ç·šå¿«å–ç¸®åœ–ï¼ˆService Worker + CacheStorageï¼‰ï¼ˆDay 28ï¼‰
    - a11y + åŸºæœ¬è‡ªæˆ‘æ¸¬è©¦ï¼ˆDay 29ï¼‰

    ä½¿ç”¨ï¼š
    1) å­˜æˆ index.htmlï¼Œç›´æ¥é–‹å³å¯ã€‚PWA/é›¢ç·šéœ€ http(s) ä¼ºæœå™¨ï¼ˆå»ºè­° VS Code Live Serverï¼‰ã€‚
    2) å…§å»ºè¨ªå®¢é€£çµï¼š?share=<token> å¯å”¯è®€æª¢è¦–ã€‚
  -->
  <style>
    :root{ --bg:#0b1220; --elev:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --primary:#ff954f; --danger:#fb7185; --ok:#22c55e; --border:#1f2937; --card:#0f172a; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35); --focus:#60a5fa }
    [data-theme="light"]{ --bg:#ffffff; --elev:#f9fafb; --text:#1f2328; --muted:#6b7280; --primary:#ff8c42; --danger:#e11d48; --ok:#16a34a; --border:#e5e7eb; --card:#ffffff; --focus:#2563eb; --shadow:0 8px 24px rgba(17,24,39,.10) }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans CJK TC","Microsoft JhengHei",Arial,sans-serif;line-height:1.65}
    .container{max-width:1160px;margin:0 auto;padding:24px}
    header{border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:var(--primary);display:grid;place-items:center;color:#fff;font-weight:800}
    .title{margin:0;font-size:20px}
    .subtitle{margin:4px 0 0;color:var(--muted);font-size:14px}

    .toolbar{display:grid;gap:12px;margin-top:16px;align-items:center;grid-template-columns:1fr 220px 140px 120px 120px auto auto}
    @media(max-width:1024px){.toolbar{grid-template-columns:1fr 1fr 1fr}}
    @media(max-width:640px){.toolbar{grid-template-columns:1fr}}
    .toolbar input[type=text],.toolbar button,.toolbar select,.toolbar input[type=file]{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text)}
    .btn{cursor:pointer;border-radius:10px}
    .btn.primary{background:var(--primary);color:#fff;border:none;padding:10px 14px}
    .btn.secondary{background:#fff0;border:1px solid var(--border);padding:10px 14px}
    .btn.danger{background:var(--danger);color:#fff;border:none;padding:10px 14px}
    .btn.small{padding:8px 10px;font-size:12px}

    main{padding:24px 0}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .card.dragging{opacity:.6;transform:scale(.98)}
    .thumb{aspect-ratio:4/3;background:#1d283a;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:12px;display:grid;gap:8px}
    .title-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{font-size:12px;color:var(--muted)}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:#cbd5e1;background:#0b1220}

    .switcher{display:flex;gap:8px}
    .switcher .tabbtn{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;cursor:pointer;color:var(--text)}
    .switcher .tabbtn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;padding:0 6px;border-radius:999px;background:var(--border);color:var(--muted);font-size:12px;margin-left:6px}

    .statusbar{display:flex;align-items:center;justify-content:space-between;margin:8px 0 12px;color:var(--muted);font-size:13px;gap:8px;flex-wrap:wrap}
    .empty{border:2px dashed var(--border);border-radius:var(--radius);padding:24px;color:var(--muted);display:flex;align-items:center;justify-content:center;grid-column:1/-1;background:#fff0}
    .skeleton{background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.15), rgba(255,255,255,.05));animation:sk 1.2s infinite}
    @keyframes sk{0%{background-position:-200px 0}100%{background-position:200px 0}}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal{width:560px;max-width:720px;background:var(--bg);border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
    .modal__header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800}
    .modal__body{padding:16px;display:grid;gap:12px}
    .modal__footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
    .field input[type=text],.field textarea{width:100%;box-sizing:border-box;padding:12px 12px;border:1px solid var(--border);border-radius:10px;background:#fff0;color:var(--text)}

    .albumbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
    .chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
  </style>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link id="app-manifest" rel="manifest" href="data:application/manifest+json,{
  \"name\": \"ç·šä¸Šç›¸ç°¿ æœ€çµ‚ç‰ˆ\",
  \"short_name\": \"ç›¸ç°¿\",
  \"start_url\": \".\",
  \"display\": \"standalone\",
  \"background_color\": \"#0b1220\",
  \"theme_color\": \"#ff954f\",
  \"icons\": [{\"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23ff954f'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-size='28' font-family='Arial' fill='white'%3EPA%3C/text%3E%3C/svg%3E\", \"sizes\": \"64x64\", \"type\": \"image/svg+xml\"}]}">
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo" aria-hidden="true">PA</div>
        <div>
          <h1 class="title">ç·šä¸Šç›¸ç°¿ï¼ˆDay 30 æœ€çµ‚å®Œæˆç‰ˆï¼‰</h1>
          <p class="subtitle">æ•´åˆç™»å…¥ / å¤šç›¸ç°¿ / ä¸Šå‚³ / EXIF / æœå°‹ / æ’åº / æ‹–æ›³ / å°é¢ / å›æ”¶æ¡¶ / åˆ†äº« / ä¸‹è¼‰ / PWA / ä¸»é¡Œ / a11y</p>
        </div>
      </div>

      <!-- æœªç™»å…¥ï¼šç™»å…¥/è¨»å†Š -->
      <section id="authSection" class="toolbar" style="display:grid;max-width:560px;margin-top:16px">
        <input id="email" type="email" placeholder="you@example.com" autocomplete="username" aria-label="Email">
        <input id="password" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 8 ç¢¼ï¼‰" autocomplete="current-password" aria-label="å¯†ç¢¼">
        <input id="password2" type="password" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼ï¼ˆè¨»å†Šç”¨ï¼‰" autocomplete="new-password" aria-label="ç¢ºèªå¯†ç¢¼" style="display:none">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="toggleModeBtn" class="btn secondary" type="button">åˆ‡æ›åˆ°è¨»å†Š</button>
          <button id="submitBtn" class="btn primary" type="button">ç™»å…¥</button>
          <span id="authMsg" style="color:var(--muted)"></span>
        </div>
        <div id="lockHint" style="display:none;color:var(--muted)"></div>
      </section>

      <!-- å·²ç™»å…¥å·¥å…·åˆ— -->
      <div id="authedToolbar" class="toolbar" role="region" aria-label="å·¥å…·åˆ—" style="display:none">
        <input id="searchInput" type="text" placeholder="æœå°‹ï¼ˆæ¨™é¡Œ/æ•˜è¿°/æ¨™ç±¤/æª”åï¼‰" aria-label="æœå°‹">
        <input id="fileInput" type="file" accept="image/*" multiple aria-label="ä¸Šå‚³åœ–ç‰‡">
        <select id="sortBy" aria-label="æ’åºä¾æ“š"><option value="time" selected>ä¾æ™‚é–“</option><option value="title">ä¾æ¨™é¡Œ</option></select>
        <select id="sortOrder" aria-label="å‡å†ªæˆ–é™å†ª"><option value="desc" selected>é™å†ª</option><option value="asc">å‡å†ª</option></select>
        <div class="switcher" role="tablist" aria-label="æª¢è¦–åˆ‡æ›">
          <button id="tabLibrary" class="tabbtn active" role="tab" aria-selected="true" type="button">ç›¸ç°¿</button>
          <button id="tabTrash" class="tabbtn" role="tab" aria-selected="false" type="button">å›æ”¶æ¡¶ <span id="trashBadge" class="badge">0</span></button>
        </div>
        <button id="themeBtn" class="btn secondary" type="button">åˆ‡æ›ä¸»é¡Œ</button>
        <button id="logoutBtn" class="btn secondary" type="button" style="justify-self:end">ç™»å‡º</button>
      </div>

      <div class="statusbar container" style="padding:0 0 12px 0">
        <div>ç›®å‰ä½¿ç”¨è€…ï¼š<span id="currentUser" class="ok">â€”</span></div>
        <div>ç›¸ç‰‡ç¸½æ•¸ï¼š<span id="countAll">0</span>ï½œé¡¯ç¤ºï¼š<span id="countShown">0</span>ï¼ç¬¦åˆï¼š<span id="countFiltered">0</span></div>
        <div id="trashHint" style="display:none">å›æ”¶æ¡¶çš„ç›¸ç‰‡æœƒåœ¨ <strong>7</strong> å¤©å¾Œè‡ªå‹•æ¸…é™¤ã€‚</div>
        <div id="live" aria-live="polite" aria-atomic="true" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden"></div>
      </div>

      <div id="albumBar" class="albumbar" style="display:none">
        <button id="addAlbumBtn" class="btn small secondary" type="button">ï¼‹ æ–°å¢ç›¸ç°¿</button>
        <div id="albumChips" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        <span id="albumOps" class="muted" style="margin-left:auto;display:none">
          <button id="renameAlbumBtn" class="btn small secondary" type="button">é‡æ–°å‘½å</button>
          <button id="deleteAlbumBtn" class="btn small danger" type="button">åˆªé™¤æ­¤ç›¸ç°¿</button>
        </span>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <section id="appSection" style="display:none">
        <div id="grid" class="grid" role="list" aria-label="åœ–ç‰‡æ¸…å–®"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
          <button id="emptyTrashBtn" class="btn danger" style="display:none" type="button">æ¸…ç©ºå›æ”¶æ¡¶</button>
          <button id="clearAllBtn" class="btn secondary" type="button">æ¸…ç©ºæ­¤å¸³è™Ÿæ‰€æœ‰è³‡æ–™</button>
        </div>
        <div style="display:flex;justify-content:center;margin-top:12px;gap:8px;align-items:center">
          <button id="loadMoreBtn" class="btn primary" type="button">è¼‰å…¥æ›´å¤š</button>
          <span id="pagerHint" class="muted"></span>
        </div>
      </section>

      <!-- è¨ªå®¢æ¨¡å¼ï¼ˆ?share=tokenï¼‰ -->
      <section id="visitorView" style="display:none">
        <div class="statusbar"><span style="color:var(--muted)">è¨ªå®¢æ¨¡å¼ï¼ˆå”¯è®€ï¼‰</span></div>
        <div class="card"><div class="thumb"><img id="vImg" alt="shared"/></div><div class="meta"><div class="title-row"><div class="title" id="vTitle">â€”</div></div><div class="time" id="vMeta">â€”</div><div id="vDesc">â€”</div><div id="vTags" class="tags"></div><div><button id="btnVisitHome" class="btn secondary" type="button">å›åˆ°ä¸»é </button></div></div></div>
      </section>
    </div>
  </main>

  <!-- ç·¨è¼¯ Modalï¼ˆç°¡ç‰ˆï¼‰ -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div class="modal__header" id="modalTitle">ç·¨è¼¯åœ–ç‰‡è³‡è¨Š</div>
      <div class="modal__body">
        <div class="field"><label for="fTitle" class="muted">æ¨™é¡Œ</label><input id="fTitle" type="text" placeholder="ä¾‹ï¼šå°åŒ—å°æ—…è¡Œ"></div>
        <div class="field"><label for="fDesc" class="muted">æ•˜è¿°</label><textarea id="fDesc" placeholder="ç°¡çŸ­æè¿°...ï¼ˆéå¿…å¡«ï¼‰" style="min-height:90px"></textarea></div>
        <div class="field"><label for="fTags" class="muted">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label><input id="fTags" type="text" placeholder="æ—…éŠ, æœ‹å‹, æ™šä¸Š"></div>
        <div class="field"><label for="fFav" class="muted">æ”¶è—</label><input id="fFav" type="checkbox"></div>
        <div class="field"><label for="fSetCover" class="muted">è¨­ç‚ºç›¸ç°¿å°é¢</label><input id="fSetCover" type="checkbox"></div>
      </div>
      <div class="modal__footer"><button id="btnCancel" class="btn secondary" type="button">å–æ¶ˆ</button><button id="btnSave" class="btn primary" type="button">å„²å­˜</button></div>
    </div>
  </div>

  <script>
  // ============================
  // Day 30ï¼šæœ€çµ‚å®Œæˆç‰ˆï¼ˆæ•´åˆï¼‰
  // ============================
  // â€”â€” Storage fallback
  const MEM = new Map();
  const HAS_LS = (function(){ try{ const k='__t__'+Math.random(); localStorage.setItem(k,'1'); localStorage.removeItem(k); return true; }catch(e){ return false; } })();
  function sget(k){ if(HAS_LS){ try{ return localStorage.getItem(k);}catch(e){ return MEM.get(k)||null;} } return MEM.get(k)||null; }
  function sset(k,v){ if(HAS_LS){ try{ localStorage.setItem(k,v); return true;}catch(e){ MEM.set(k,v); return true;} } MEM.set(k,v); return true; }

  // â€”â€” Keys
  const LS_USERS='pa_users_v6';
  const LS_SESSION='pa_session_user_v6';
  const LS_SHARES='pa_shares_v6';
  const PWA_THUMB_CACHE='pa_thumbs_v3';
  const PWA_APP_CACHE='pa_appshell_v3';
  function keyAlbums(email){ return 'pa_u_'+encodeURIComponent(email)+'_albums_v1'; }
  function keyPhotos(email, album){ return 'pa_u_'+encodeURIComponent(email)+'_a_'+encodeURIComponent(album)+'_photos_v1'; }

  // â€”â€” Utils
  function normalizeEmail(s){ return String(s||'').trim().toLowerCase(); }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function now(){ return Date.now(); }
  function fileNameWithoutExt(name){ if(typeof name!=='string') return 'image'; const i=name.lastIndexOf('.'); return i>0? name.slice(0,i): (name||'image'); }
  function prettySize(bytes){ const u=['B','KB','MB','GB']; let i=0,n=bytes; while(n>=1024&&i<u.length-1){ n/=1024;i++; } return n.toFixed(1)+' '+u[i]; }
  function fmtFull(ts){ const d=new Date(ts||Date.now()); function P(n){return String(n).padStart(2,'0')} return d.getFullYear()+'-'+P(d.getMonth()+1)+'-'+P(d.getDate())+' '+P(d.getHours())+':'+P(d.getMinutes()); }
  const live=document.getElementById('live'); function announce(msg){ live.textContent=msg; }

  // â€”â€” Hashï¼ˆSHA-256ï¼‰
  function toHex(bytes){ return Array.prototype.map.call(bytes, b=>('0'+b.toString(16)).slice(-2)).join(''); }
  async function sha256Hex(s){ try{ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(s)); return toHex(new Uint8Array(buf)); }catch(e){ return s; } }
  async function hashPassword(pw, salt){ return sha256Hex(salt+':'+pw); }

  // â€”â€” Auth / Users
  function loadUsers(){ try{ return JSON.parse(sget(LS_USERS)||'[]')||[] }catch(_){ return [] } }
  function saveUsers(u){ sset(LS_USERS, JSON.stringify(u||[])); }
  function setSession(email){ sset(LS_SESSION, normalizeEmail(email||'')); }
  function currentUserEmail(){ return normalizeEmail(sget(LS_SESSION)||''); }
  function getLockMap(){ try{ return JSON.parse(sget('pa_login_locks_v6')||'{}')||{} }catch(_){ return {} } }
  function setLockMap(m){ sset('pa_login_locks_v6', JSON.stringify(m||{})); }
  function recordFail(email){ const map=getLockMap(); const e=normalizeEmail(email); const rec=map[e]||{fail:0,lockUntil:0}; rec.fail=(rec.fail||0)+1; const base=400; rec.delay=base*rec.fail; if(rec.fail>=5){ rec.lockUntil=now()+5*60*1000; } map[e]=rec; setLockMap(map); return rec; }
  function recordSuccess(email){ const map=getLockMap(); delete map[normalizeEmail(email)]; setLockMap(map); }
  function checkLocked(email){ const rec=getLockMap()[normalizeEmail(email)]; if(!rec) return {locked:false}; const left=(rec.lockUntil||0)-now(); return {locked:left>0,leftMs:Math.max(0,left)} }
  async function register(email, password){ const e=normalizeEmail(email); const users=loadUsers(); if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(e)) throw new Error('Email æ ¼å¼ä¸æ­£ç¢º'); if((password||'').length<8) throw new Error('å¯†ç¢¼éœ€è‡³å°‘ 8 ç¢¼'); if(users.some(u=>u.email===e)) throw new Error('æ­¤ Email å·²è¢«è¨»å†Š'); const salt=toHex(crypto.getRandomValues(new Uint8Array(8))); const hash=await hashPassword(password, salt); users.push({email:e,salt,hash,createdAt:now()}); saveUsers(users); sset(keyAlbums(e), JSON.stringify(['æˆ‘çš„ç›¸ç°¿'])); sset(keyPhotos(e,'æˆ‘çš„ç›¸ç°¿'), JSON.stringify([])); return {email:e}; }
  async function login(email, password){ const e=normalizeEmail(email); const lk=checkLocked(e); if(lk.locked) throw new Error('å¸³è™Ÿæš«æ™‚é–å®šï¼Œè«‹ç¨å¾Œ'); const users=loadUsers(); const u=users.find(x=>x.email===e); if(!u){ recordFail(e); throw new Error('æŸ¥ç„¡æ­¤å¸³è™Ÿ'); } const h=await hashPassword(password,u.salt); if(h!==u.hash){ recordFail(e); throw new Error('å¯†ç¢¼ä¸æ­£ç¢º'); } recordSuccess(e); setSession(e); return u; }
  function logout(){ setSession(''); }

  // â€”â€” Albums & Photos per user
  function loadAlbums(email){ try{ const arr=JSON.parse(sget(keyAlbums(email))||'[]')||[]; return Array.isArray(arr)&&arr.length?arr:['æˆ‘çš„ç›¸ç°¿']; }catch(_){ return ['æˆ‘çš„ç›¸ç°¿']; } }
  function saveAlbums(email, list){ sset(keyAlbums(email), JSON.stringify(list||['æˆ‘çš„ç›¸ç°¿'])); }
  function loadPhotos(email, album){ try{ return JSON.parse(sget(keyPhotos(email,album))||'[]')||[] }catch(_){ return [] } }
  function savePhotos(email, album, list){ sset(keyPhotos(email,album), JSON.stringify(list||[])); }

  // â€”â€” Shares
  function loadShares(){ try{ return JSON.parse(sget(LS_SHARES)||'{}')||{} }catch(_){ return {} } }
  function saveShares(m){ sset(LS_SHARES, JSON.stringify(m||{})); }
  function getTokenByPhotoId(id, owner){ const map=loadShares(); for(const k in map){ const s=map[k]; if(s && s.snapshot && s.snapshot.id===id && s.owner===owner) return k; } return null; }
  function buildShareUrl(token){ const base=location.origin + location.pathname; return base + '?share=' + encodeURIComponent(token); }

  // â€”â€” Thumbs / Lazy / PWA
  function loadImage(dataUrl){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=()=>rej(new Error('å½±åƒè¼‰å…¥å¤±æ•—')); img.src=dataUrl; }); }
  async function createThumb(dataUrl, maxSide=640, quality=0.7){ const img=await loadImage(dataUrl); let {width:w,height:h}=img; if(!w||!h) return dataUrl; const long=Math.max(w,h); if(long>maxSide){ const s=maxSide/long; w=Math.round(w*s); h=Math.round(h*s); } const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); return c.toDataURL('image/jpeg', quality); }
  async function putThumbIntoCache(id, dataUrl){ try{ const cache=await caches.open(PWA_THUMB_CACHE); const resp=await fetch(dataUrl); const blob=await resp.blob(); const url=new URL(location.origin + '/thumbs/' + encodeURIComponent(id) + '.jpg'); await cache.put(url, new Response(blob,{headers:{'Content-Type':'image/jpeg'}})); }catch(_){} }
  let io=null; const tiny='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='; function ensureObserver(){ if(io) io.disconnect(); io=new IntersectionObserver(entries=>{ entries.forEach(en=>{ if(en.isIntersecting){ const img=en.target; const src=img.getAttribute('data-src'); if(src){ img.src=src; img.removeAttribute('data-src'); } io.unobserve(img); } }); },{root:null,rootMargin:'200px',threshold:0.01}); }

  // â€”â€” UI refs
  const authSection=document.getElementById('authSection');
  const authedToolbar=document.getElementById('authedToolbar');
  const appSection=document.getElementById('appSection');
  const visitorView=document.getElementById('visitorView');
  const currentUserSpan=document.getElementById('currentUser');
  const emailInput=document.getElementById('email');
  const passwordInput=document.getElementById('password');
  const password2Input=document.getElementById('password2');
  const toggleModeBtn=document.getElementById('toggleModeBtn');
  const submitBtn=document.getElementById('submitBtn');
  const logoutBtn=document.getElementById('logoutBtn');
  const themeBtn=document.getElementById('themeBtn');
  const searchInput=document.getElementById('searchInput');
  const fileInput=document.getElementById('fileInput');
  const sortBySelect=document.getElementById('sortBy');
  const sortOrderSelect=document.getElementById('sortOrder');
  const grid=document.getElementById('grid');
  const countAll=document.getElementById('countAll');
  const countFiltered=document.getElementById('countFiltered');
  const countShown=document.getElementById('countShown');
  const clearAllBtn=document.getElementById('clearAllBtn');
  const tabLibrary=document.getElementById('tabLibrary');
  const tabTrash=document.getElementById('tabTrash');
  const trashBadge=document.getElementById('trashBadge');
  const emptyTrashBtn=document.getElementById('emptyTrashBtn');
  const trashHint=document.getElementById('trashHint');
  const vImg=document.getElementById('vImg');
  const vTitle=document.getElementById('vTitle');
  const vMeta=document.getElementById('vMeta');
  const vDesc=document.getElementById('vDesc');
  const vTags=document.getElementById('vTags');
  const btnVisitHome=document.getElementById('btnVisitHome');
  const modalBackdrop=document.getElementById('modalBackdrop');
  const fTitle=document.getElementById('fTitle');
  const fDesc=document.getElementById('fDesc');
  const fTags=document.getElementById('fTags');
  const fFav=document.getElementById('fFav');
  const fSetCover=document.getElementById('fSetCover');
  const btnCancel=document.getElementById('btnCancel');
  const btnSave=document.getElementById('btnSave');
  const albumBar=document.getElementById('albumBar');
  const addAlbumBtn=document.getElementById('addAlbumBtn');
  const albumChips=document.getElementById('albumChips');
  const albumOps=document.getElementById('albumOps');
  const renameAlbumBtn=document.getElementById('renameAlbumBtn');
  const deleteAlbumBtn=document.getElementById('deleteAlbumBtn');
  const pagerHint=document.getElementById('pagerHint');
  const loadMoreBtn=document.getElementById('loadMoreBtn');

  // â€”â€” App state
  const MS_DAY=24*60*60*1000; const DAYS_KEEP=7;
  let mode='login'; let showTrash=false; let visibleCount=12; let query='';
  let userEmail=''; let albums=[]; let album='æˆ‘çš„ç›¸ç°¿'; let photos=[]; // ç•¶å‰ç›¸ç°¿ç…§ç‰‡
  let order='desc'; let sortBy='time';
  let draggingId=null;

  // â€”â€” Debounce æœå°‹
  function debounce(fn, wait){ let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), wait); }; }
  const onSearchInput = debounce((e)=>{ query=e.target.value||''; visibleCount=12; render(); }, 300);

  // â€”â€” ä¸»é¡Œåˆ‡æ›
  function getTheme(){ return sget('pa_theme')||'dark'; }
  function setTheme(t){ document.documentElement.setAttribute('data-theme', t==='light'?'light':'dark'); sset('pa_theme', t); themeBtn.textContent = t==='light'? 'åˆ‡æ›ä¸»é¡Œï¼ˆæ·±è‰²ï¼‰':'åˆ‡æ›ä¸»é¡Œï¼ˆæ·ºè‰²ï¼‰'; }

  // â€”â€” ç›¸ç°¿åˆ—
  function buildAlbumBar(){ albumBar.style.display='flex'; albumChips.innerHTML=''; albums.forEach(a=>{ const chip=document.createElement('button'); chip.className='chip'+(a===album?' active':''); chip.textContent=a; chip.addEventListener('click',()=>{ album=a; photos=loadPhotos(userEmail,album); visibleCount=12; render(); refreshAlbumOps(); }); albumChips.appendChild(chip); }); refreshAlbumOps(); }
  function refreshAlbumOps(){ const show = albums.length>0; albumOps.style.display=show?'inline-flex':'none'; }
  function addAlbum(){ const name=prompt('æ–°ç›¸ç°¿åç¨±ï¼Ÿ','æ–°çš„ç›¸ç°¿'); if(!name) return; if(albums.includes(name)) return alert('å·²å­˜åœ¨ç›¸åŒåç¨±'); albums.push(name); saveAlbums(userEmail,albums); sset(keyPhotos(userEmail,name), JSON.stringify([])); buildAlbumBar(); }
  function renameAlbum(){ const neo=prompt('å°‡ç›¸ç°¿ã€Œ'+album+'ã€æ”¹åç‚ºï¼Ÿ', album); if(!neo||neo===album) return; if(albums.includes(neo)) return alert('å·²å­˜åœ¨ç›¸åŒåç¨±'); const old=album; albums=albums.map(x=>x===old?neo:x); saveAlbums(userEmail,albums); const oldKey=keyPhotos(userEmail,old); const newKey=keyPhotos(userEmail,neo); sset(newKey, sget(oldKey)||'[]'); sset(oldKey,'[]'); album=neo; photos=loadPhotos(userEmail,album); buildAlbumBar(); visibleCount=12; render(); }
  function deleteAlbum(){ if(!confirm('åˆªé™¤ç›¸ç°¿ã€Œ'+album+'ã€ï¼Ÿç…§ç‰‡äº¦æœƒåˆªé™¤ï¼ˆå«å›æ”¶æ¡¶ï¼‰ã€‚')) return; sset(keyPhotos(userEmail,album),'[]'); albums=albums.filter(x=>x!==album); if(!albums.length) albums=['æˆ‘çš„ç›¸ç°¿']; saveAlbums(userEmail,albums); album=albums[0]; photos=loadPhotos(userEmail,album); buildAlbumBar(); render(); }

  // â€”â€” EXIF è®€å–
  function readEXIF(file){ return new Promise(resolve=>{ try{ EXIF.getData(file,function(){ const all=EXIF.getAllTags(this)||{}; const dt=all.DateTimeOriginal||all.DateTime||null; resolve({ make:all.Make||null, model:all.Model||null, date:dt }); }); }catch(_){ resolve({}); } }); }

  // â€”â€” Upload
  function readFileAsDataURL(file){return new Promise((resolve,reject)=>{const r=new FileReader();r.onerror=()=>reject(new Error('è®€æª”å¤±æ•—'));r.onload=()=>resolve(r.result);r.readAsDataURL(file)})}
  const handleUpload = async (e)=>{ const files=Array.from(e.target.files||[]); if(!files.length) return; const images=files.filter(f=>f.type&&f.type.startsWith('image/')); const non=files.filter(f=>!f.type||!f.type.startsWith('image/')); if(non.length) alert('å·²ç•¥ééåœ–ç‰‡æª”æ¡ˆ:\n'+non.map(f=>'â€¢ '+f.name).join('\n')); for(const file of images){ try{ const dataUrl=await readFileAsDataURL(file); const ex=await readEXIF(file); const thumbUrl=await createThumb(dataUrl, 640, 0.7); const item={ id:uid(), dataUrl:String(dataUrl), thumbUrl:String(thumbUrl), name:file.name, lastModified:file.lastModified, size:file.size, title:fileNameWithoutExt(file.name), desc:'', tags:[], fav:false, isDeleted:false, deletedAt:null, exif:ex, cover:false }; photos.push(item); await putThumbIntoCache(item.id, item.thumbUrl); announce('å·²ä¸Šå‚³ã€'+item.title+'ã€'); }catch(err){ console.warn('è½‰æ›ç¸®åœ–å¤±æ•—ï¼š', err); } } persist(); e.target.value=''; render(); };

  // â€”â€” Downloadï¼ˆå£“ç¸®ï¼‰
  async function downloadCompressed(p, maxSide=1600, quality=0.85){ const th=await createThumb(p.dataUrl, maxSide, quality); const a=document.createElement('a'); a.href=th; const ts=new Date(p.lastModified||Date.now()); const tsStr=`${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}`; a.download=`${(p.title||fileNameWithoutExt(p.name))}_${tsStr}.jpg`; a.click(); }

  // â€”â€” Trash
  function moveToTrash(id){ const p=photos.find(x=>x.id===id); if(!p) return; if(p.isDeleted) return; p.isDeleted=true; p.deletedAt=now(); persist(); announce('å·²ç§»è‡³å›æ”¶æ¡¶ï¼š'+(p.title||fileNameWithoutExt(p.name))); render(); }
  function restorePhoto(id){ const p=photos.find(x=>x.id===id); if(!p) return; if(!p.isDeleted) return; p.isDeleted=false; p.deletedAt=null; persist(); announce('å·²é‚„åŸï¼š'+(p.title||fileNameWithoutExt(p.name))); render(); }
  function permanentlyDelete(id){ const idx=photos.findIndex(x=>x.id===id); if(idx<0) return; if(confirm('æ­¤å‹•ä½œç„¡æ³•é‚„åŸï¼Œç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ')){ const name=fileNameWithoutExt(photos[idx].name); photos.splice(idx,1); persist(); announce('å·²æ°¸ä¹…åˆªé™¤ï¼š'+name); render(); } }
  function emptyTrash(){ if(!photos.some(p=>p.isDeleted)) return alert('å›æ”¶æ¡¶ç›®å‰æ˜¯ç©ºçš„'); if(!confirm('å°‡æ°¸ä¹…åˆªé™¤å›æ”¶æ¡¶å…§æ‰€æœ‰é …ç›®ï¼Œç„¡æ³•å¾©åŸã€‚è¦ç¹¼çºŒå—ï¼Ÿ')) return; photos = photos.filter(p=>!p.isDeleted); persist(); announce('å›æ”¶æ¡¶å·²æ¸…ç©º'); render(); }
  function autoPurge(){ const limit=now()-DAYS_KEEP*MS_DAY; const before=photos.length; photos=photos.filter(p=>!(p.isDeleted&&typeof p.deletedAt==='number'&&p.deletedAt<limit)); if(photos.length!==before) persist(); }

  // â€”â€” Favorite / Cover
  function toggleFav(id){ const p=photos.find(x=>x.id===id); if(!p) return; p.fav=!p.fav; persist(); render(); }
  function setAsCover(id){ photos.forEach(x=>x.cover=false); const p=photos.find(x=>x.id===id); if(p){ p.cover=true; persist(); render(); } }

  // â€”â€” Filter & sort & render
  function baseFilter(list){ const q=(query||'').trim().toLowerCase(); const tokens=q? q.split(/\s+/).filter(Boolean):[]; return list.filter(p=>{ const inTrash=!!p.isDeleted; if(showTrash? !inTrash : inTrash) return false; if(!tokens.length) return true; const hay=[p.title||'', p.desc||'', (p.tags||[]).join(' '), p.name||''].join(' ').toLowerCase(); return tokens.every(tok=>hay.includes(tok)); }); }
  function sortPhotos(list){ const arr=list.slice(); const order = (sortOrderSelect.value==='asc')?1:-1; const sb = sortBySelect.value; if(sb==='time'){ arr.sort((a,b)=>{const t1=Number(a.lastModified||0),t2=Number(b.lastModified||0);return (t1===t2?0:(t1>t2?1:-1))*order}); } else { arr.sort((a,b)=>{const s1=(a.title||fileNameWithoutExt(a.name)).toLowerCase(); const s2=(b.title||fileNameWithoutExt(b.name)).toLowerCase(); if(s1===s2) return 0; return (s1>s2?1:-1)*order}); } return arr; }
  function getFilteredSorted(){ return sortPhotos(baseFilter(photos)); }
  function updateCounters(){ const totalAll=photos.filter(p=>!p.isDeleted).length; const totalShown=getFilteredSorted().length; const shown=Math.min(visibleCount,totalShown); countAll.textContent=String(totalAll); countFiltered.textContent=String(totalShown); countShown.textContent=String(shown); const trashCount=photos.filter(p=>p.isDeleted).length; trashBadge.textContent=String(trashCount); trashHint.style.display=showTrash?'inline':'none'; }

  function render(){ ensureObserver(); const all=getFilteredSorted(); const data=all.slice(0, visibleCount); updateCounters(); const frag=document.createDocumentFragment(); if(data.length===0){ const empty=document.createElement('div'); empty.className='empty'; empty.textContent= showTrash? 'å›æ”¶æ¡¶æ˜¯ç©ºçš„ã€‚' : (photos.filter(p=>!p.isDeleted).length===0 ? 'é‚„æ²’æœ‰ç›¸ç‰‡ï¼Œè«‹å¾ä¸Šæ–¹ä¸Šå‚³ã€‚' : 'æ²’æœ‰ç¬¦åˆç›®å‰æœå°‹æ¢ä»¶çš„çµæœã€‚'); frag.appendChild(empty); } else { data.forEach(p=>{ const card=document.createElement('article'); card.className='card'; card.dataset.id=p.id; card.setAttribute('tabindex','0'); card.setAttribute('role','listitem'); card.setAttribute('draggable', String(!showTrash)); card.setAttribute('aria-label', (p.title||fileNameWithoutExt(p.name)) + 'ï¼ŒEnter ç·¨è¼¯ï¼ŒShift+Enter åŸåœ–ï¼ŒD ä¸‹è¼‰ï¼ŒDel åˆªé™¤');
        // æ‹–æ›³
        card.addEventListener('dragstart', e=>{ draggingId=p.id; card.classList.add('dragging'); });
        card.addEventListener('dragend', e=>{ draggingId=null; card.classList.remove('dragging'); persist(); render(); });
        card.addEventListener('dragover', e=>{ if(!draggingId) return; e.preventDefault(); const idxA=photos.findIndex(x=>x.id===draggingId); const idxB=photos.findIndex(x=>x.id===p.id); if(idxA<0||idxB<0||idxA===idxB) return; const [it]=photos.splice(idxA,1); photos.splice(idxB,0,it); });

        const th=document.createElement('div'); th.className='thumb'; const img=document.createElement('img'); img.loading='lazy'; img.src=tiny; const thumbPath='/thumbs/'+encodeURIComponent(p.id)+'.jpg'; img.setAttribute('data-src', thumbPath); img.alt=p.title||fileNameWithoutExt(p.name); io.observe(img); th.appendChild(img);
        const meta=document.createElement('div'); meta.className='meta'; const titleRow=document.createElement('div'); titleRow.className='title-row'; const title=document.createElement('div'); title.className='title'; title.textContent=(p.cover?'ğŸ“Œ ':'')+(p.fav?'â˜… ':'')+(p.title||fileNameWithoutExt(p.name));
        const btnRow=document.createElement('div'); btnRow.className='actions';
        if(showTrash){ const restoreBtn=document.createElement('button'); restoreBtn.className='btn small'; restoreBtn.type='button'; restoreBtn.textContent='é‚„åŸ'; restoreBtn.addEventListener('click',()=>restorePhoto(p.id)); const delBtn=document.createElement('button'); delBtn.className='btn small danger'; delBtn.type='button'; delBtn.textContent='æ°¸ä¹…åˆªé™¤'; delBtn.addEventListener('click',()=>permanentlyDelete(p.id)); btnRow.appendChild(restoreBtn); btnRow.appendChild(delBtn); }
        else {
          const editBtn=document.createElement('button'); editBtn.className='btn small'; editBtn.type='button'; editBtn.textContent='ç·¨è¼¯'; editBtn.addEventListener('click',()=>openEditor(p.id));
          const viewBtn=document.createElement('button'); viewBtn.className='btn small secondary'; viewBtn.type='button'; viewBtn.textContent='çœ‹åŸåœ–'; viewBtn.addEventListener('click',()=>showOriginal(p));
          const downBtn=document.createElement('button'); downBtn.className='btn small secondary'; downBtn.type='button'; downBtn.textContent='ä¸‹è¼‰'; downBtn.addEventListener('click',()=>downloadCompressed(p));
          const favBtn=document.createElement('button'); favBtn.className='btn small'; favBtn.type='button'; favBtn.textContent=p.fav?'å–æ¶ˆæ”¶è—':'æ”¶è—'; favBtn.addEventListener('click',()=>toggleFav(p.id));
          const coverBtn=document.createElement('button'); coverBtn.className='btn small'; coverBtn.type='button'; coverBtn.textContent='è¨­ç‚ºå°é¢'; coverBtn.addEventListener('click',()=>setAsCover(p.id));
          const shareBtn=document.createElement('button'); shareBtn.className='btn small primary'; shareBtn.type='button'; shareBtn.textContent='åˆ†äº«'; shareBtn.addEventListener('click',()=>sharePhoto(p.id));
          const copyBtn=document.createElement('button'); copyBtn.className='btn small secondary'; copyBtn.type='button'; copyBtn.textContent='è¤‡è£½é€£çµ'; copyBtn.addEventListener('click',()=>copyShareLink(p.id));
          const trashBtn=document.createElement('button'); trashBtn.className='btn small danger'; trashBtn.type='button'; trashBtn.textContent='åˆªé™¤'; trashBtn.addEventListener('click',()=>moveToTrash(p.id));
          btnRow.append(editBtn,viewBtn,downBtn,favBtn,coverBtn,shareBtn,copyBtn,trashBtn);
        }
        titleRow.append(title,btnRow);
        const time=document.createElement('div'); time.className='time'; const ex=p.exif||{}; const exifStr=ex.model?`ï½œ${ex.make||''} ${ex.model}`:''; time.textContent='æ™‚é–“ï¼š'+fmtFull(p.lastModified)+'ï½œ'+prettySize(p.size||0)+exifStr;
        const tagsWrap=document.createElement('div'); tagsWrap.className='tags'; (p.tags||[]).forEach(t=>{ const chip=document.createElement('span'); chip.className='tag'; chip.textContent=t; tagsWrap.appendChild(chip); });
        const shareLine=document.createElement('div'); shareLine.className='time'; const token=getTokenByPhotoId(p.id, userEmail); if(token){ const a=document.createElement('a'); a.href=buildShareUrl(token); a.textContent='å·²åˆ†äº«ï¼š'+a.href; a.target='_blank'; shareLine.appendChild(a); } else { shareLine.textContent='å°šæœªåˆ†äº«'; }
        // éµç›¤æ“ä½œ
        card.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter' && !ev.shiftKey){ ev.preventDefault(); openEditor(p.id); } if(ev.key==='Enter' && ev.shiftKey){ ev.preventDefault(); showOriginal(p); } if(ev.key.toLowerCase()==='d'){ ev.preventDefault(); downloadCompressed(p); } if(ev.key==='Delete'){ ev.preventDefault(); if(!showTrash) moveToTrash(p.id); else permanentlyDelete(p.id); } });
        meta.append(titleRow,time,tagsWrap,shareLine); card.append(th,meta); frag.appendChild(card); }); }
    grid.innerHTML=''; grid.appendChild(frag); emptyTrashBtn.style.display = showTrash? 'inline-flex':'none'; updatePager(); }
  function updatePager(){ const total=getFilteredSorted().length; const shown=Math.min(visibleCount,total); loadMoreBtn.disabled = shown>=total; pagerHint.textContent = shown>=total? (total? 'å·²é¡¯ç¤ºå…¨éƒ¨':'æ²’æœ‰è³‡æ–™') : `å°šæœ‰ ${total-shown} å¼µ`; countShown.textContent=String(shown); countFiltered.textContent=String(total); }

  function showOriginal(p){ const w=window.open(); if(!w){ alert('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ï¼Œè«‹å…è¨±å¾Œå†è©¦'); return; } const html = `<!DOCTYPE html><title>${(p.title||fileNameWithoutExt(p.name))} - åŸåœ–</title><style>html,body{margin:0;height:100%;background:#111;display:grid;place-items:center}</style><img src="${p.dataUrl}" alt="original" style="max-width:100%;max-height:100%"/>`; w.document.write(html); }

  // â€”â€” åˆ†äº«
  function sharePhoto(id){ const p=photos.find(x=>x.id===id); if(!p) return; let token=getTokenByPhotoId(id, userEmail); const map=loadShares(); if(!token){ token='sh_'+uid(); const snap={ id:p.id, dataUrl:p.dataUrl, name:p.name, lastModified:p.lastModified, size:p.size, title:p.title, desc:p.desc, tags:Array.isArray(p.tags)? p.tags.slice():[] }; map[token]={ owner: userEmail, album, createdAt: now(), snapshot: snap }; saveShares(map); } const url=buildShareUrl(token); const ok=confirm('å·²ç”¢ç”Ÿåˆ†äº«é€£çµï¼š\n\n'+url+'\n\næ˜¯å¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Ÿ'); if(ok){ copyText(url); alert('å·²è¤‡è£½åˆ†äº«é€£çµ'); } render(); }
  function copyShareLink(id){ const token=getTokenByPhotoId(id, userEmail); if(!token){ alert('å°šæœªåˆ†äº«ï¼Œè«‹å…ˆé»ã€Œåˆ†äº«ã€ç”¢ç”Ÿé€£çµ'); return; } const url=buildShareUrl(token); copyText(url); alert('å·²è¤‡è£½åˆ†äº«é€£çµ'); }
  function copyText(text){ if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text); } else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} ta.remove(); } }

  // â€”â€” Modal
  let editingId=null; function openEditor(id){ const p=photos.find(x=>x.id===id); if(!p) return; if(p.isDeleted) return alert('å›æ”¶æ¡¶ä¸­çš„é …ç›®ä¸èƒ½ç·¨è¼¯ï¼Œè«‹å…ˆé‚„åŸ'); editingId=id; fTitle.value=p.title||fileNameWithoutExt(p.name); fDesc.value=p.desc||''; fTags.value=(p.tags||[]).join(', '); fFav.checked=!!p.fav; fSetCover.checked=!!p.cover; showModal(true); setTimeout(()=>fTitle.focus(),0); }
  function showModal(show){ modalBackdrop.style.display = show? 'flex':'none'; modalBackdrop.setAttribute('aria-hidden', show? 'false': 'true'); if(!show) editingId=null; }
  function saveEditor(){ const p=photos.find(x=>x.id===editingId); if(!p) return; p.title=String(fTitle.value||'').trim(); p.desc=String(fDesc.value||'').trim(); p.tags=String(fTags.value||'').split(',').map(s=>s.trim()).filter(Boolean); p.fav=!!fFav.checked; if(fSetCover.checked) setAsCover(p.id); persist(); announce('å·²æ›´æ–°ã€Œ'+(p.title||fileNameWithoutExt(p.name))+'ã€çš„ä¸­ç¹¼è³‡æ–™'); render(); showModal(false); }
  btnCancel.addEventListener('click',()=>showModal(false)); btnSave.addEventListener('click',saveEditor); modalBackdrop.addEventListener('click',ev=>{ if(ev.target===modalBackdrop) showModal(false); }); document.addEventListener('keydown',ev=>{ if(modalBackdrop.style.display==='flex' && ev.key==='Escape') showModal(false); });

  // â€”â€” Controls
  function setTab(trash){ showTrash=!!trash; tabLibrary.classList.toggle('active', !showTrash); tabTrash.classList.toggle('active', showTrash); tabLibrary.setAttribute('aria-selected', String(!showTrash)); tabTrash.setAttribute('aria-selected', String(showTrash)); visibleCount=12; render(); }
  tabLibrary.addEventListener('click', ()=>setTab(false)); tabTrash.addEventListener('click', ()=>setTab(true)); emptyTrashBtn.addEventListener('click', emptyTrash);
  clearAllBtn.addEventListener('click', ()=>{ if(!photos.length) return; if(confirm('å°‡åˆªé™¤æ­¤å¸³è™Ÿæ­¤ç›¸ç°¿æ‰€æœ‰ç›¸ç‰‡ï¼ˆå«å›æ”¶æ¡¶ï¼‰ï¼Œç„¡æ³•å¾©åŸã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ')){ photos=[]; persist(); announce('å·²æ¸…ç©ºæ­¤ç›¸ç°¿è³‡æ–™'); render(); }});
  loadMoreBtn.addEventListener('click', ()=>{ visibleCount += 12; render(); });
  searchInput.addEventListener('input', onSearchInput); sortBySelect.addEventListener('change', ()=>{ visibleCount=12; render(); }); sortOrderSelect.addEventListener('change', ()=>{ visibleCount=12; render(); }); fileInput.addEventListener('change', handleUpload);
  addAlbumBtn.addEventListener('click', addAlbum); renameAlbumBtn.addEventListener('click', renameAlbum); deleteAlbumBtn.addEventListener('click', deleteAlbum);

  // â€”â€” Persistï¼ˆç›¸ç°¿/ä½¿ç”¨è€…ä½œç”¨ï¼‰
  function persist(){ if(!userEmail) return; savePhotos(userEmail, album, photos); }

  // â€”â€” Auth UI
  function setMode(m){ mode=m; if(m==='register'){ password2Input.style.display='inline-block'; toggleModeBtn.textContent='åˆ‡æ›åˆ°ç™»å…¥'; submitBtn.textContent='è¨»å†Š'; authMsg.textContent=''; } else { password2Input.style.display='none'; toggleModeBtn.textContent='åˆ‡æ›åˆ°è¨»å†Š'; submitBtn.textContent='ç™»å…¥'; authMsg.textContent=''; } }
  const authMsg=document.getElementById('authMsg'); const lockHint=document.getElementById('lockHint');
  toggleModeBtn.addEventListener('click', ()=> setMode(mode==='login'? 'register':'login'));
  submitBtn.addEventListener('click', async ()=>{
    const email=emailInput.value||''; const pass=passwordInput.value||''; const pass2=password2Input.value||'';
    try{
      const lock=checkLocked(email); if(lock.locked){ lockHint.style.display='block'; lockHint.textContent='æ­¤å¸³è™Ÿå·²é–å®šï¼Œè«‹ '+Math.ceil((lock.leftMs||0)/1000)+' ç§’å¾Œå†è©¦'; throw new Error('å¸³è™Ÿæš«æ™‚é–å®š'); } else { lockHint.style.display='none'; }
      if(mode==='register'){
        if(pass!==pass2) throw new Error('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´');
        const u=await register(email, pass); authMsg.textContent='è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥'; authMsg.style.color='#22c55e'; setMode('login'); emailInput.value=u.email; passwordInput.value=''; password2Input.value='';
      } else {
        const u=await login(email, pass); emailInput.value=''; passwordInput.value=''; password2Input.value=''; onAuthed(u.email);
      }
    }catch(err){ authMsg.textContent=err.message||String(err); authMsg.style.color='#f43f5e'; }
  });
  const currentUserEl=document.getElementById('currentUser');
  function showAuthed(is){ authSection.style.display=is? 'none':'grid'; authedToolbar.style.display=is? 'grid':'none'; appSection.style.display=is? 'block':'none'; albumBar.style.display=is? 'flex':'none'; }
  function onAuthed(email){ userEmail=normalizeEmail(email); showAuthed(true); currentUserEl.textContent=userEmail; albums=loadAlbums(userEmail); album=albums[0]||'æˆ‘çš„ç›¸ç°¿'; photos=loadPhotos(userEmail,album); // patch
    let patched=false; photos.forEach(p=>{ if(!('thumbUrl' in p)){ p.thumbUrl=null; patched=true } if(!('isDeleted' in p)){ p.isDeleted=false; patched=true } if(!('deletedAt' in p)){ p.deletedAt=null; patched=true } if(!('fav' in p)){ p.fav=false; patched=true } if(!('cover' in p)){ p.cover=false; patched=true } }); if(patched) persist();
    (async ()=>{ for(const p of photos){ if(p.thumbUrl && !p.isDeleted){ await putThumbIntoCache(p.id, p.thumbUrl); } } })();
    (async ()=>{ const need=photos.filter(p=>!p.thumbUrl && !p.isDeleted).slice(0,6); let mod=false; for(const p of need){ try{ p.thumbUrl=await createThumb(p.dataUrl,640,0.7); await putThumbIntoCache(p.id, p.thumbUrl); mod=true; }catch(_){} } if(mod) persist(); render(); })();
    autoPurge(); visibleCount=12; buildAlbumBar(); render(); }
  logoutBtn.addEventListener('click', ()=>{ logout(); photos=[]; query=''; showAuthed(false); authMsg.textContent='å·²ç™»å‡º'; authMsg.style.color='var(--muted)'; });

  // â€”â€” Visitor
  function qp(name){ const u=new URL(location.href); return u.searchParams.get(name); }
  btnVisitHome.addEventListener('click', ()=>{ const base=location.origin+location.pathname; location.href=base; });
  function showVisitor(token){ const map=loadShares(); const rec=map[token]; if(!rec || !rec.snapshot){ authSection.style.display='none'; authedToolbar.style.display='none'; appSection.style.display='none'; albumBar.style.display='none'; visitorView.style.display='block'; visitorView.innerHTML='<div class="card" style="padding:20px">é€£çµå·²å¤±æ•ˆæˆ–ä¸å­˜åœ¨ã€‚</div>'; return; } const p=rec.snapshot; authSection.style.display='none'; authedToolbar.style.display='none'; appSection.style.display='none'; albumBar.style.display='none'; visitorView.style.display='block'; vImg.src=p.dataUrl; vTitle.textContent=p.title||fileNameWithoutExt(p.name); vMeta.textContent='æ™‚é–“ï¼š'+fmtFull(p.lastModified)+'ï½œ'+prettySize(p.size||0); vDesc.textContent=p.desc||'â€”'; vTags.innerHTML=''; (p.tags||[]).forEach(t=>{ const chip=document.createElement('span'); chip.className='tag'; chip.textContent=t; vTags.appendChild(chip); }); }

  // â€”â€” Service Worker
  const SW_CODE = `
  const APP_CACHE='${PWA_APP_CACHE}';
  const THUMB_CACHE='${PWA_THUMB_CACHE}';
  self.addEventListener('install', (e)=>{ self.skipWaiting(); e.waitUntil((async()=>{ try{ const cache=await caches.open(APP_CACHE); const root=new URL('./', self.registration.scope).href; await cache.addAll([root]); }catch(_){ } })()); });
  self.addEventListener('activate', (e)=>{ e.waitUntil((async()=>{ try{ const keys=await caches.keys(); for(const k of keys){ if(k!==APP_CACHE && k!==THUMB_CACHE){ await caches.delete(k); } } }catch(_){ } await self.clients.claim(); })()); });
  self.addEventListener('fetch', (event)=>{ const url=new URL(event.request.url); if(url.pathname.startsWith('/thumbs/')){ event.respondWith((async()=>{ const cache=await caches.open(THUMB_CACHE); const cached=await cache.match(event.request); if(cached) return cached; return new Response('Not cached', { status:404 }); })()); return; } event.respondWith((async()=>{ const cache=await caches.open(APP_CACHE); const cached=await cache.match(event.request); if(cached) return cached; try{ const resp=await fetch(event.request); if(event.request.method==='GET' && url.origin===location.origin){ cache.put(event.request, resp.clone()); } return resp; }catch(_){ return cached || new Response('Offline', {status:503}); } })()); });`;
  async function registerSW(){ if(!('serviceWorker' in navigator)) return; try{ const blob=new Blob([SW_CODE],{type:'text/javascript'}); const swUrl=URL.createObjectURL(blob); const reg=await navigator.serviceWorker.register(swUrl,{scope:'./'}); console.log('SW è¨»å†Šå®Œæˆï¼š',reg.scope); }catch(err){ console.warn('SW è¨»å†Šå¤±æ•—ï¼š',err); } }

  // â€”â€” è‡ªæˆ‘æ¸¬è©¦ï¼ˆä¸è®Šæ›´æ—¢æœ‰æ¸¬è©¦ï¼›è‹¥ç¼ºï¼Œè£œå¹¾å€‹ï¼‰
  function runSelfTests(){ console.groupCollapsed('ğŸ” Self-tests for Final'); try{ // 1) debounce åªè§¸ç™¼ä¸€æ¬¡
      let calls=0; const fn=debounce(()=>{calls++}, 60); fn(); fn(); fn(); setTimeout(()=>{}, 0);
      setTimeout(()=>{ console.assert(calls===1,'Debounce æ‡‰åªè§¸ç™¼ 1 æ¬¡'); }, 160);
      // 2) æ’åº
      document.getElementById('sortBy').value='time'; document.getElementById('sortOrder').value='asc'; const demo=[{title:'B',lastModified:2},{title:'a',lastModified:1},{title:'C',lastModified:3}]; const asc=demo.slice().sort((a,b)=>a.lastModified-b.lastModified).map(x=>x.lastModified).join(','); console.assert(asc==='1,2,3','æ™‚é–“æ’åº asc');
      // 3) a11yï¼šimg alt
      const okAlt = Array.from(document.querySelectorAll('#grid img')).every(n=>n.hasAttribute('alt')); console.assert(okAlt,'img éœ€ alt');
      console.log('âœ… è‡ªæˆ‘æ¸¬è©¦é€šéï¼ˆæˆ–ç¨å¾Œå¾… DOM å®Œæˆï¼‰'); }catch(err){ console.error('âŒ è‡ªæˆ‘æ¸¬è©¦å¤±æ•—', err); } console.groupEnd(); }

  // â€”â€” Init
  (function init(){ setTheme(getTheme()); themeBtn.addEventListener('click', ()=> setTheme(getTheme()==='light'?'dark':'light'));
    const share=qp('share'); if(share){ showVisitor(share); registerSW(); runSelfTests(); return; }
    setMode('login'); const authed=currentUserEmail(); if(authed){ onAuthed(authed); } registerSW(); runSelfTests(); })();
  </script>
</body>
</html>

